{"version":3,"file":"B3DMLoader-Cnf0ja_2.js","sources":["../../../src/three/renderer/loaders/B3DMLoader.js"],"sourcesContent":["import { B3DMLoaderBase } from '3d-tiles-renderer/core';\nimport { DefaultLoadingManager, Matrix4 } from 'three';\nimport { GLTFLoader } from 'three/examples/jsm/loaders/GLTFLoader.js';\n\nexport class B3DMLoader extends B3DMLoaderBase {\n\n\tconstructor( manager = DefaultLoadingManager ) {\n\n\t\tsuper();\n\t\tthis.manager = manager;\n\t\tthis.adjustmentTransform = new Matrix4();\n\n\t}\n\n\tparse( buffer ) {\n\n\t\tconst b3dm = super.parse( buffer );\n\t\tconst gltfBuffer = b3dm.glbBytes.slice().buffer;\n\t\treturn new Promise( ( resolve, reject ) => {\n\n\t\t\tconst manager = this.manager;\n\t\t\tconst fetchOptions = this.fetchOptions;\n\t\t\tconst loader = manager.getHandler( 'path.gltf' ) || new GLTFLoader( manager );\n\n\t\t\tif ( fetchOptions.credentials === 'include' && fetchOptions.mode === 'cors' ) {\n\n\t\t\t\tloader.setCrossOrigin( 'use-credentials' );\n\n\t\t\t}\n\n\t\t\tif ( 'credentials' in fetchOptions ) {\n\n\t\t\t\tloader.setWithCredentials( fetchOptions.credentials === 'include' );\n\n\t\t\t}\n\n\t\t\tif ( fetchOptions.headers ) {\n\n\t\t\t\tloader.setRequestHeader( fetchOptions.headers );\n\n\t\t\t}\n\n\t\t\t// GLTFLoader assumes the working path ends in a slash\n\t\t\tlet workingPath = this.workingPath;\n\t\t\tif ( ! /[\\\\/]$/.test( workingPath ) && workingPath.length ) {\n\n\t\t\t\tworkingPath += '/';\n\n\t\t\t}\n\n\t\t\tconst adjustmentTransform = this.adjustmentTransform;\n\n\t\t\tloader.parse( gltfBuffer, workingPath, model => {\n\n\t\t\t\tconst { batchTable, featureTable } = b3dm;\n\t\t\t\tconst { scene } = model;\n\n\t\t\t\tconst rtcCenter = featureTable.getData( 'RTC_CENTER', 1, 'FLOAT', 'VEC3' );\n\t\t\t\tif ( rtcCenter ) {\n\n\t\t\t\t\tscene.position.x += rtcCenter[ 0 ];\n\t\t\t\t\tscene.position.y += rtcCenter[ 1 ];\n\t\t\t\t\tscene.position.z += rtcCenter[ 2 ];\n\n\t\t\t\t}\n\n\t\t\t\tmodel.scene.updateMatrix();\n\t\t\t\tmodel.scene.matrix.multiply( adjustmentTransform );\n\t\t\t\tmodel.scene.matrix.decompose( model.scene.position, model.scene.quaternion, model.scene.scale );\n\n\t\t\t\tmodel.batchTable = batchTable;\n\t\t\t\tmodel.featureTable = featureTable;\n\n\t\t\t\tscene.batchTable = batchTable;\n\t\t\t\tscene.featureTable = featureTable;\n\n\t\t\t\tresolve( model );\n\n\t\t\t}, reject );\n\n\t\t} );\n\n\t}\n\n}\n"],"names":["B3DMLoader","B3DMLoaderBase","manager","DefaultLoadingManager","Matrix4","buffer","b3dm","gltfBuffer","resolve","reject","fetchOptions","loader","GLTFLoader","workingPath","adjustmentTransform","model","batchTable","featureTable","scene","rtcCenter"],"mappings":"qJAIO,MAAMA,UAAmBC,CAAe,CAE9C,YAAaC,EAAUC,EAAwB,CAE9C,MAAK,EACL,KAAK,QAAUD,EACf,KAAK,oBAAsB,IAAIE,CAEhC,CAEA,MAAOC,EAAS,CAEf,MAAMC,EAAO,MAAM,MAAOD,CAAM,EAC1BE,EAAaD,EAAK,SAAS,MAAK,EAAG,OACzC,OAAO,IAAI,QAAS,CAAEE,EAASC,IAAY,CAE1C,MAAMP,EAAU,KAAK,QACfQ,EAAe,KAAK,aACpBC,EAAST,EAAQ,WAAY,WAAW,GAAM,IAAIU,EAAYV,CAAO,EAEtEQ,EAAa,cAAgB,WAAaA,EAAa,OAAS,QAEpEC,EAAO,eAAgB,iBAAiB,EAIpC,gBAAiBD,GAErBC,EAAO,mBAAoBD,EAAa,cAAgB,SAAS,EAI7DA,EAAa,SAEjBC,EAAO,iBAAkBD,EAAa,OAAO,EAK9C,IAAIG,EAAc,KAAK,YAClB,CAAE,SAAS,KAAMA,CAAW,GAAMA,EAAY,SAElDA,GAAe,KAIhB,MAAMC,EAAsB,KAAK,oBAEjCH,EAAO,MAAOJ,EAAYM,EAAaE,GAAS,CAE/C,KAAM,CAAE,WAAAC,EAAY,aAAAC,CAAY,EAAKX,EAC/B,CAAE,MAAAY,CAAK,EAAKH,EAEZI,EAAYF,EAAa,QAAS,aAAc,EAAG,QAAS,MAAM,EACnEE,IAEJD,EAAM,SAAS,GAAKC,EAAW,CAAC,EAChCD,EAAM,SAAS,GAAKC,EAAW,CAAC,EAChCD,EAAM,SAAS,GAAKC,EAAW,CAAC,GAIjCJ,EAAM,MAAM,aAAY,EACxBA,EAAM,MAAM,OAAO,SAAUD,CAAmB,EAChDC,EAAM,MAAM,OAAO,UAAWA,EAAM,MAAM,SAAUA,EAAM,MAAM,WAAYA,EAAM,MAAM,KAAK,EAE7FA,EAAM,WAAaC,EACnBD,EAAM,aAAeE,EAErBC,EAAM,WAAaF,EACnBE,EAAM,aAAeD,EAErBT,EAASO,CAAK,CAEf,EAAGN,CAAM,CAEV,CAAC,CAEF,CAED"}