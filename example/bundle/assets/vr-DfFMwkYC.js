import"./modulepreload-polyfill-B5Qt9EMX.js";/* empty css               */import{T as k}from"./TilesRenderer-Bm042Xsy.js";import{aw as W,i as D,s as R,h as I,o as G,S as H,W as $,G as M,ax as X,a as _,D as q,A as Y,B as Q,d as J,R as K,x as Z,ay as ee,an as te,az as F,ap as se,aA as oe,ai as ne}from"./three.module-D-uF--xd.js";import{g as ie}from"./lil-gui.module.min-BH_YJbPT.js";import{G as ae}from"./GLTFLoader-B4GrkiON.js";import"./TilesRendererBase-CFsQu8zV.js";import"./constants-JFoaxC9y.js";import"./BatchTable-CRr3zuRk.js";import"./B3DMLoader-Cnf0ja_2.js";import"./B3DMLoaderBase-w5mdSgm-.js";import"./PNTSLoader-DwvZQNdL.js";import"./I3DMLoader-BWluRuWb.js";import"./Ellipsoid-Dwquuq5w.js";import"./CMPTLoader-BOTrymv0.js";import"./EllipsoidRegion-VNvPMw5b.js";class g{static createButton(e,t={}){const s=document.createElement("button");function r(){let n=null;async function b(y){y.addEventListener("end",O),await e.xr.setSession(y),s.textContent="EXIT VR",n=y}function O(){n.removeEventListener("end",O),s.textContent="ENTER VR",n=null}s.style.display="",s.style.cursor="pointer",s.style.left="calc(50% - 50px)",s.style.width="100px",s.textContent="ENTER VR";const T={...t,optionalFeatures:["local-floor","bounded-floor","layers",...t.optionalFeatures||[]]};s.onmouseenter=function(){s.style.opacity="1.0"},s.onmouseleave=function(){s.style.opacity="0.5"},s.onclick=function(){n===null?navigator.xr.requestSession("immersive-vr",T).then(b):(n.end(),navigator.xr.offerSession!==void 0&&navigator.xr.offerSession("immersive-vr",T).then(b).catch(y=>{console.warn(y)}))},navigator.xr.offerSession!==void 0&&navigator.xr.offerSession("immersive-vr",T).then(b).catch(y=>{console.warn(y)})}function a(){s.style.display="",s.style.cursor="auto",s.style.left="calc(50% - 75px)",s.style.width="150px",s.onmouseenter=null,s.onmouseleave=null,s.onclick=null}function i(){a(),s.textContent="VR NOT SUPPORTED"}function h(n){a(),console.warn("Exception when trying to call xr.isSessionSupported",n),s.textContent="VR NOT ALLOWED"}function l(n){n.style.position="absolute",n.style.bottom="20px",n.style.padding="12px 6px",n.style.border="1px solid #fff",n.style.borderRadius="4px",n.style.background="rgba(0,0,0,0.1)",n.style.color="#fff",n.style.font="normal 13px sans-serif",n.style.textAlign="center",n.style.opacity="0.5",n.style.outline="none",n.style.zIndex="999"}if("xr"in navigator)return s.id="VRButton",s.style.display="none",l(s),navigator.xr.isSessionSupported("immersive-vr").then(function(n){n?r():i(),n&&g.xrSessionIsGranted&&s.click()}).catch(h),s;{const n=document.createElement("a");return window.isSecureContext===!1?(n.href=document.location.href.replace(/^http:/,"https:"),n.innerHTML="WEBXR NEEDS HTTPS"):(n.href="https://immersiveweb.dev/",n.innerHTML="WEBXR NOT AVAILABLE"),n.style.left="calc(50% - 90px)",n.style.width="180px",n.style.textDecoration="none",l(n),n}}static registerSessionGrantedListener(){if(typeof navigator<"u"&&"xr"in navigator){if(/WebXRViewer\//i.test(navigator.userAgent))return;navigator.xr.addEventListener("sessiongranted",()=>{g.xrSessionIsGranted=!0})}}}g.xrSessionIsGranted=!1;g.registerSessionGrantedListener();const u={ComponentState:Object.freeze({DEFAULT:"default",TOUCHED:"touched",PRESSED:"pressed"}),ComponentProperty:Object.freeze({BUTTON:"button",X_AXIS:"xAxis",Y_AXIS:"yAxis",STATE:"state"}),ComponentType:Object.freeze({TRIGGER:"trigger",SQUEEZE:"squeeze",TOUCHPAD:"touchpad",THUMBSTICK:"thumbstick",BUTTON:"button"}),ButtonTouchThreshold:.05,AxisTouchThreshold:.1,VisualResponseProperty:Object.freeze({TRANSFORM:"transform",VISIBILITY:"visibility"})};async function U(o){const e=await fetch(o);if(e.ok)return e.json();throw new Error(e.statusText)}async function re(o){if(!o)throw new Error("No basePath supplied");return await U(`${o}/profilesList.json`)}async function le(o,e,t=null,s=!0){if(!o)throw new Error("No xrInputSource supplied");if(!e)throw new Error("No basePath supplied");const r=await re(e);let a;if(o.profiles.some(l=>{const n=r[l];return n&&(a={profileId:l,profilePath:`${e}/${n.path}`,deprecated:!!n.deprecated}),!!a}),!a){if(!t)throw new Error("No matching profile name found");const l=r[t];if(!l)throw new Error(`No matching profile name found and default profile "${t}" missing.`);a={profileId:t,profilePath:`${e}/${l.path}`,deprecated:!!l.deprecated}}const i=await U(a.profilePath);let h;if(s){let l;if(o.handedness==="any"?l=i.layouts[Object.keys(i.layouts)[0]]:l=i.layouts[o.handedness],!l)throw new Error(`No matching handedness, ${o.handedness}, in profile ${a.profileId}`);l.assetPath&&(h=a.profilePath.replace("profile.json",l.assetPath))}return{profile:i,assetPath:h}}const de={xAxis:0,yAxis:0,button:0,state:u.ComponentState.DEFAULT};function ue(o=0,e=0){let t=o,s=e;if(Math.sqrt(o*o+e*e)>1){const i=Math.atan2(e,o);t=Math.cos(i),s=Math.sin(i)}return{normalizedXAxis:t*.5+.5,normalizedYAxis:s*.5+.5}}class ce{constructor(e){this.componentProperty=e.componentProperty,this.states=e.states,this.valueNodeName=e.valueNodeName,this.valueNodeProperty=e.valueNodeProperty,this.valueNodeProperty===u.VisualResponseProperty.TRANSFORM&&(this.minNodeName=e.minNodeName,this.maxNodeName=e.maxNodeName),this.value=0,this.updateFromComponent(de)}updateFromComponent({xAxis:e,yAxis:t,button:s,state:r}){const{normalizedXAxis:a,normalizedYAxis:i}=ue(e,t);switch(this.componentProperty){case u.ComponentProperty.X_AXIS:this.value=this.states.includes(r)?a:.5;break;case u.ComponentProperty.Y_AXIS:this.value=this.states.includes(r)?i:.5;break;case u.ComponentProperty.BUTTON:this.value=this.states.includes(r)?s:0;break;case u.ComponentProperty.STATE:this.valueNodeProperty===u.VisualResponseProperty.VISIBILITY?this.value=this.states.includes(r):this.value=this.states.includes(r)?1:0;break;default:throw new Error(`Unexpected visualResponse componentProperty ${this.componentProperty}`)}}}class he{constructor(e,t){if(!e||!t||!t.visualResponses||!t.gamepadIndices||Object.keys(t.gamepadIndices).length===0)throw new Error("Invalid arguments supplied");this.id=e,this.type=t.type,this.rootNodeName=t.rootNodeName,this.touchPointNodeName=t.touchPointNodeName,this.visualResponses={},Object.keys(t.visualResponses).forEach(s=>{const r=new ce(t.visualResponses[s]);this.visualResponses[s]=r}),this.gamepadIndices=Object.assign({},t.gamepadIndices),this.values={state:u.ComponentState.DEFAULT,button:this.gamepadIndices.button!==void 0?0:void 0,xAxis:this.gamepadIndices.xAxis!==void 0?0:void 0,yAxis:this.gamepadIndices.yAxis!==void 0?0:void 0}}get data(){return{id:this.id,...this.values}}updateFromGamepad(e){if(this.values.state=u.ComponentState.DEFAULT,this.gamepadIndices.button!==void 0&&e.buttons.length>this.gamepadIndices.button){const t=e.buttons[this.gamepadIndices.button];this.values.button=t.value,this.values.button=this.values.button<0?0:this.values.button,this.values.button=this.values.button>1?1:this.values.button,t.pressed||this.values.button===1?this.values.state=u.ComponentState.PRESSED:(t.touched||this.values.button>u.ButtonTouchThreshold)&&(this.values.state=u.ComponentState.TOUCHED)}this.gamepadIndices.xAxis!==void 0&&e.axes.length>this.gamepadIndices.xAxis&&(this.values.xAxis=e.axes[this.gamepadIndices.xAxis],this.values.xAxis=this.values.xAxis<-1?-1:this.values.xAxis,this.values.xAxis=this.values.xAxis>1?1:this.values.xAxis,this.values.state===u.ComponentState.DEFAULT&&Math.abs(this.values.xAxis)>u.AxisTouchThreshold&&(this.values.state=u.ComponentState.TOUCHED)),this.gamepadIndices.yAxis!==void 0&&e.axes.length>this.gamepadIndices.yAxis&&(this.values.yAxis=e.axes[this.gamepadIndices.yAxis],this.values.yAxis=this.values.yAxis<-1?-1:this.values.yAxis,this.values.yAxis=this.values.yAxis>1?1:this.values.yAxis,this.values.state===u.ComponentState.DEFAULT&&Math.abs(this.values.yAxis)>u.AxisTouchThreshold&&(this.values.state=u.ComponentState.TOUCHED)),Object.values(this.visualResponses).forEach(t=>{t.updateFromComponent(this.values)})}}class pe{constructor(e,t,s){if(!e)throw new Error("No xrInputSource supplied");if(!t)throw new Error("No profile supplied");this.xrInputSource=e,this.assetUrl=s,this.id=t.profileId,this.layoutDescription=t.layouts[e.handedness],this.components={},Object.keys(this.layoutDescription.components).forEach(r=>{const a=this.layoutDescription.components[r];this.components[r]=new he(r,a)}),this.updateFromGamepad()}get gripSpace(){return this.xrInputSource.gripSpace}get targetRaySpace(){return this.xrInputSource.targetRaySpace}get data(){const e=[];return Object.values(this.components).forEach(t=>{e.push(t.data)}),e}updateFromGamepad(){Object.values(this.components).forEach(e=>{e.updateFromGamepad(this.xrInputSource.gamepad)})}}const fe="https://cdn.jsdelivr.net/npm/@webxr-input-profiles/assets@1.0/dist/profiles",me="generic-trigger";class xe extends W{constructor(){super(),this.motionController=null,this.envMap=null}setEnvironmentMap(e){return this.envMap==e?this:(this.envMap=e,this.traverse(t=>{t.isMesh&&(t.material.envMap=this.envMap,t.material.needsUpdate=!0)}),this)}updateMatrixWorld(e){super.updateMatrixWorld(e),this.motionController&&(this.motionController.updateFromGamepad(),Object.values(this.motionController.components).forEach(t=>{Object.values(t.visualResponses).forEach(s=>{const{valueNode:r,minNode:a,maxNode:i,value:h,valueNodeProperty:l}=s;r&&(l===u.VisualResponseProperty.VISIBILITY?r.visible=h:l===u.VisualResponseProperty.TRANSFORM&&(r.quaternion.slerpQuaternions(a.quaternion,i.quaternion,h),r.position.lerpVectors(a.position,i.position,h)))})}))}}function ye(o,e){Object.values(o.components).forEach(t=>{const{type:s,touchPointNodeName:r,visualResponses:a}=t;if(s===u.ComponentType.TOUCHPAD)if(t.touchPointNode=e.getObjectByName(r),t.touchPointNode){const i=new D(.001),h=new R({color:255}),l=new I(i,h);t.touchPointNode.add(l)}else console.warn(`Could not find touch dot, ${t.touchPointNodeName}, in touchpad component ${t.id}`);Object.values(a).forEach(i=>{const{valueNodeName:h,minNodeName:l,maxNodeName:n,valueNodeProperty:b}=i;if(b===u.VisualResponseProperty.TRANSFORM){if(i.minNode=e.getObjectByName(l),i.maxNode=e.getObjectByName(n),!i.minNode){console.warn(`Could not find ${l} in the model`);return}if(!i.maxNode){console.warn(`Could not find ${n} in the model`);return}}i.valueNode=e.getObjectByName(h),i.valueNode||console.warn(`Could not find ${h} in the model`)})})}function B(o,e){ye(o.motionController,e),o.envMap&&e.traverse(t=>{t.isMesh&&(t.material.envMap=o.envMap,t.material.needsUpdate=!0)}),o.add(e)}class ve{constructor(e=null,t=null){this.gltfLoader=e,this.path=fe,this._assetCache={},this.onLoad=t,this.gltfLoader||(this.gltfLoader=new ae)}setPath(e){return this.path=e,this}createControllerModel(e){const t=new xe;let s=null;return e.addEventListener("connected",r=>{const a=r.data;a.targetRayMode!=="tracked-pointer"||!a.gamepad||a.hand||le(a,this.path,me).then(({profile:i,assetPath:h})=>{t.motionController=new pe(a,i,h);const l=this._assetCache[t.motionController.assetUrl];if(l)s=l.scene.clone(),B(t,s),this.onLoad&&this.onLoad(s);else{if(!this.gltfLoader)throw new Error("GLTFLoader not set.");this.gltfLoader.setPath(""),this.gltfLoader.load(t.motionController.assetUrl,n=>{this._assetCache[t.motionController.assetUrl]=n,s=n.scene.clone(),B(t,s),this.onLoad&&this.onLoad(s)},null,()=>{throw new Error(`Asset ${t.motionController.assetUrl} missing or malformed.`)})}}).catch(i=>{console.warn(i)})}),e.addEventListener("disconnected",()=>{t.motionController=null,t.remove(s),s=null}),t}}let p,v,c,d,m,L,P,w,N,V,f,A,x,C,E=null;const S=[],we=new G(0,1,0),z={displayGrid:!0};ge();function ge(){v=new H,c=new $({antialias:!0}),c.setPixelRatio(window.devicePixelRatio),c.setSize(window.innerWidth,window.innerHeight),c.setClearColor(12303291),c.xr.enabled=!0,document.body.appendChild(c.domElement),c.domElement.tabIndex=1,c.setAnimationLoop(Ee),m=new M,v.add(m),w=new X(10,10,16777215,16777215),w.material.transparent=!0,w.material.opacity=.5,w.material.depthWrite=!1,m.add(w),p=new _(60,window.innerWidth/window.innerHeight,.1,4e3),p.position.set(0,1,0),m.add(p);const o=new q(16777215);o.position.set(1,2,3),v.add(o);const e=new Y(16777215,.2);v.add(e),L=new Q,P=new J,A=new M,A.rotation.x=Math.PI/2,A.position.y=32,v.add(A),d=new k("https://raw.githubusercontent.com/NASA-AMMOS/3DTilesSampleData/master/msl-dingo-gap/0528_0260184_to_s64o256_colorize/scene-tileset.json"),A.add(d.group),d.setCamera(p),d.setResolutionFromRenderer(p,c);const t=i=>{S.push(i)};d.downloadQueue.schedulingCallback=t,d.parseQueue.schedulingCallback=t,d.lruCache.maxSize=1200,d.lruCache.minSize=900,N=new K,V=new G(0,0,1);const s=new R({color:11722715});f=new I(new Z(1.5,.2,16,100),s),f.visible=!1,v.add(f),document.body.appendChild(g.createButton(c)),x=c.xr.getController(0),x.addEventListener("selectstart",()=>{f.visible&&m.position.copy(f.position)}),x.addEventListener("connected",function(i){this.controllerActive=!0,this.add(be(i.data))}),x.addEventListener("disconnected",function(){this.controllerActive=!1,this.remove(this.children[0])}),m.add(x);const r=new ve;C=c.xr.getControllerGrip(0),C.add(r.createControllerModel(C)),m.add(C),j(),window.addEventListener("resize",j,!1);const a=new ie;a.width=300,a.add(z,"displayGrid"),a.open()}function be(o){let e,t;switch(o.targetRayMode){case"tracked-pointer":return e=new te,e.setAttribute("position",new F([0,0,0,0,0,-1],3)),e.setAttribute("color",new F([.5,.5,.5,0,0,0],3)),t=new se({vertexColors:!0,blending:oe,depthWrite:!1,transparent:!0}),new ne(e,t);case"gaze":return e=new ee(.02,.04,32).translate(0,0,-1),t=new R({opacity:.5,transparent:!0}),new I(e,t)}}function j(){p.updateProjectionMatrix(),c.setPixelRatio(window.devicePixelRatio),c.setSize(window.innerWidth,window.innerHeight),p.aspect=window.innerWidth/window.innerHeight,p.updateProjectionMatrix()}function Ae(){if(c.xr.isPresenting){if(E===null){const o=c.xr.getCamera(p);d.cameras.forEach(t=>d.deleteCamera(t)),d.setCamera(o);const e=o.cameras[0];e&&d.setResolution(o,e.viewport.z,e.viewport.w),E=c.xr.getSession()}}else E!==null&&(d.cameras.forEach(o=>d.deleteCamera(o)),d.setCamera(p),d.setResolutionFromRenderer(p,c),p.position.set(0,1,0),E=null)}function Ce(){for(let o=0,e=S.length;o<e;o++)S[o]();S.length=0}function Ee(){if(w.visible=z.displayGrid,d.getBoundingBox(L)?(L.getCenter(d.group.position),d.group.position.multiplyScalar(-1)):d.getBoundingSphere(P)&&(d.group.position.copy(P.center),d.group.position.multiplyScalar(-1)),Ae(),Ce(),d.update(),x.controllerActive){const{ray:o}=N;N.firstHitOnly=!0,o.origin.copy(x.position).applyMatrix4(m.matrixWorld),x.getWorldDirection(o.direction).multiplyScalar(-1);const e=N.intersectObject(d.group,!0);if(e.length){const t=e[0];t.face.normal.transformDirection(d.group.matrixWorld),f.position.copy(t.point),f.quaternion.setFromUnitVectors(V,t.face.normal),f.visible=!0;const s=m.position.distanceTo(f.position)*p.fov/4e3;f.scale.setScalar(s),t.face.normal.dot(we)<.15&&(f.visible=!1)}else f.visible=!1}else f.visible=!1;c.render(v,p)}
//# sourceMappingURL=vr-DfFMwkYC.js.map
