{"version":3,"file":"b3dmExample-kFsC1IMb.js","sources":["../../b3dmExample.js"],"sourcesContent":["import { B3DMLoader } from '3d-tiles-renderer';\nimport {\n\tScene,\n\tGroup,\n\tDirectionalLight,\n\tAmbientLight,\n\tWebGLRenderer,\n\tPerspectiveCamera,\n\tBox3,\n\tPCFSoftShadowMap,\n\tVector2,\n\tRaycaster,\n\tShaderLib,\n\tUniformsUtils,\n\tShaderMaterial,\n\tColor,\n} from 'three';\nimport { OrbitControls } from 'three/examples/jsm/controls/OrbitControls.js';\n\nlet camera, controls, scene, renderer, offsetGroup;\nlet dirLight;\nlet raycaster, mouse;\nlet model;\nlet infoEl;\n\ninit();\nanimate();\n\n// Adjusts the three.js standard shader to include batchid highlight\nfunction batchIdHighlightShaderMixin( shader ) {\n\n\tconst newShader = { ...shader };\n\tnewShader.uniforms = {\n\t\thighlightedBatchId: { value: - 1 },\n\t\thighlightColor: { value: new Color( 0xFFC107 ).convertSRGBToLinear() },\n\t\t...UniformsUtils.clone( shader.uniforms ),\n\t};\n\tnewShader.extensions = {\n\t\tderivatives: true,\n\t};\n\tnewShader.lights = true;\n\tnewShader.vertexShader =\n\t\t`\n\t\t\tattribute float _batchid;\n\t\t\tvarying float batchid;\n\t\t` +\n\t\tnewShader.vertexShader.replace(\n\t\t\t/#include <uv_vertex>/,\n\t\t\t`\n\t\t\t#include <uv_vertex>\n\t\t\tbatchid = _batchid;\n\t\t\t`\n\t\t);\n\tnewShader.fragmentShader =\n\t\t`\n\t\t\tvarying float batchid;\n\t\t\tuniform float highlightedBatchId;\n\t\t\tuniform vec3 highlightColor;\n\t\t` +\n\t\tnewShader.fragmentShader.replace(\n\t\t\t/vec4 diffuseColor = vec4\\( diffuse, opacity \\);/,\n\t\t\t`\n\t\t\tvec4 diffuseColor =\n\t\t\t\tabs( batchid - highlightedBatchId ) < 0.5 ?\n\t\t\t\tvec4( highlightColor, opacity ) :\n\t\t\t\tvec4( diffuse, opacity );\n\t\t\t`\n\t\t);\n\n\treturn newShader;\n\n}\n\nfunction init() {\n\n\tinfoEl = document.getElementById( 'hover-info' );\n\n\tscene = new Scene();\n\n\t// primary camera view\n\trenderer = new WebGLRenderer( { antialias: true } );\n\trenderer.setPixelRatio( window.devicePixelRatio );\n\trenderer.setSize( window.innerWidth, window.innerHeight );\n\trenderer.setClearColor( 0x151c1f );\n\trenderer.shadowMap.enabled = true;\n\trenderer.shadowMap.type = PCFSoftShadowMap;\n\n\tdocument.body.appendChild( renderer.domElement );\n\n\tcamera = new PerspectiveCamera( 60, window.innerWidth / window.innerHeight, 1, 4000 );\n\tcamera.position.set( 400, 400, 400 );\n\n\t// controls\n\tcontrols = new OrbitControls( camera, renderer.domElement );\n\tcontrols.screenSpacePanning = false;\n\tcontrols.minDistance = 1;\n\tcontrols.maxDistance = 2000;\n\n\t// lights\n\tdirLight = new DirectionalLight( 0xffffff, 1.25 );\n\tdirLight.position.set( 1, 2, 3 ).multiplyScalar( 40 );\n\tdirLight.castShadow = true;\n\tdirLight.shadow.bias = - 0.01;\n\tdirLight.shadow.mapSize.setScalar( 2048 );\n\n\tconst shadowCam = dirLight.shadow.camera;\n\tshadowCam.left = - 200;\n\tshadowCam.bottom = - 200;\n\tshadowCam.right = 200;\n\tshadowCam.top = 200;\n\tshadowCam.updateProjectionMatrix();\n\n\tscene.add( dirLight );\n\n\tconst ambLight = new AmbientLight( 0xffffff, 0.05 );\n\tscene.add( ambLight );\n\n\toffsetGroup = new Group();\n\tscene.add( offsetGroup );\n\n\tnew B3DMLoader()\n\t\t.loadAsync( 'https://raw.githubusercontent.com/CesiumGS/cesium/main/Apps/SampleData/Cesium3DTiles/Hierarchy/BatchTableHierarchy/tile.b3dm' )\n\t\t.then( res => {\n\n\t\t\tconsole.log( res );\n\t\t\tmodel = res.scene;\n\t\t\toffsetGroup.add( model );\n\n\t\t\tconst box = new Box3();\n\t\t\tbox.setFromObject( model );\n\t\t\tbox.getCenter( offsetGroup.position ).multiplyScalar( - 1 );\n\n\n\t\t\t// reassign the material to use the batchid highlight variant.\n\t\t\t// in practice this should copy over any needed uniforms from the\n\t\t\t// original material.\n\t\t\tmodel.traverse( c => {\n\n\t\t\t\tif ( c.isMesh ) {\n\n\t\t\t\t\tc.material = new ShaderMaterial( batchIdHighlightShaderMixin( ShaderLib.standard ) );\n\n\t\t\t\t}\n\n\t\t\t} );\n\n\t\t} );\n\n\traycaster = new Raycaster();\n\tmouse = new Vector2();\n\n\tonWindowResize();\n\twindow.addEventListener( 'resize', onWindowResize, false );\n\trenderer.domElement.addEventListener( 'mousemove', onMouseMove, false );\n\n}\n\nfunction onMouseMove( e ) {\n\n\tconst bounds = this.getBoundingClientRect();\n\tmouse.x = e.clientX - bounds.x;\n\tmouse.y = e.clientY - bounds.y;\n\tmouse.x = ( mouse.x / bounds.width ) * 2 - 1;\n\tmouse.y = - ( mouse.y / bounds.height ) * 2 + 1;\n\n\traycaster.setFromCamera( mouse, camera );\n\n\t// Get the batch table data\n\tconst intersects = raycaster.intersectObject( scene );\n\tlet hoveredBatchid = - 1;\n\tif ( intersects.length > 0 ) {\n\n\t\tconst { face, object } = intersects[ 0 ];\n\t\tconst batchidAttr = object.geometry.getAttribute( '_batchid' );\n\n\t\tif ( batchidAttr ) {\n\n\t\t\t// Traverse the parents to find the batch table.\n\t\t\tlet batchTableObject = object;\n\t\t\twhile ( ! batchTableObject.batchTable ) {\n\n\t\t\t\tbatchTableObject = batchTableObject.parent;\n\n\t\t\t}\n\n\t\t\t// Log the batch data\n\t\t\tconst batchTable = batchTableObject.batchTable;\n\t\t\thoveredBatchid = batchidAttr.getX( face.a );\n\n\t\t\tconst batchData = batchTable.getDataFromId( hoveredBatchid );\n\t\t\tconst hierarchyData = batchData[ '3DTILES_batch_table_hierarchy' ];\n\n\t\t\tconst batchTableKeys = batchTable.getKeys();\n\t\t\tinfoEl.innerText = `${ '_batchid'.padEnd( 15 ) }: ${ hoveredBatchid }\\n`;\n\t\t\tfor ( const key of batchTableKeys ) {\n\n\t\t\t\tinfoEl.innerText += `${ key.padEnd( 15 ) }: ${ batchData[ key ] }\\n`;\n\n\t\t\t}\n\n\t\t\tfor ( const className in hierarchyData ) {\n\n\t\t\t\tfor ( const instance in hierarchyData[ className ] ) {\n\n\t\t\t\t\tinfoEl.innerText += `${ instance.padEnd( 15 ) }: ${ hierarchyData[ className ][ instance ] }\\n`;\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t}\n\n\t} else {\n\n\t\tinfoEl.innerText = '';\n\n\t}\n\n\tif ( model ) {\n\n\t\tmodel.traverse( c => {\n\n\t\t\tif ( c.isMesh ) {\n\n\t\t\t\tc.material.uniforms.highlightedBatchId.value = hoveredBatchid;\n\n\t\t\t}\n\n\t\t} );\n\n\t}\n\n}\n\nfunction onWindowResize() {\n\n\tcamera.aspect = window.innerWidth / window.innerHeight;\n\trenderer.setPixelRatio( window.devicePixelRatio );\n\trenderer.setSize( window.innerWidth, window.innerHeight );\n\tcamera.updateProjectionMatrix();\n\n}\n\nfunction animate() {\n\n\trequestAnimationFrame( animate );\n\n\trender();\n\n}\n\nfunction render() {\n\n\trenderer.render( scene, camera );\n\n}\n"],"names":["camera","controls","scene","renderer","offsetGroup","dirLight","raycaster","mouse","model","infoEl","init","animate","batchIdHighlightShaderMixin","shader","newShader","Color","UniformsUtils","Scene","WebGLRenderer","PCFSoftShadowMap","PerspectiveCamera","OrbitControls","DirectionalLight","shadowCam","ambLight","AmbientLight","Group","B3DMLoader","res","box","Box3","c","ShaderMaterial","ShaderLib","Raycaster","Vector2","onWindowResize","onMouseMove","e","bounds","intersects","hoveredBatchid","face","object","batchidAttr","batchTableObject","batchTable","batchData","hierarchyData","batchTableKeys","key","className","instance","render"],"mappings":"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"}