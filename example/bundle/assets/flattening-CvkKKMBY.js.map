{"version":3,"file":"flattening-CvkKKMBY.js","sources":["../../../src/three/plugins/TileFlatteningPlugin.js","../../r3f/plugins/TileFlatteningPlugin.jsx","../../r3f/flattening.jsx"],"sourcesContent":["import { Box3, DoubleSide, MathUtils, Matrix4, MeshBasicMaterial, Raycaster, Sphere, Vector3 } from 'three';\n\n// Limitations:\n// - No support for BatchedTilesPlugin when resetting or modifying geometry\n// - Sharing geometry between models may result in incorrect flattening\n\nconst _sphere = /* @__PURE__ */ new Sphere();\nconst _vec = /* @__PURE__ */ new Vector3();\nconst _matrix = /* @__PURE__ */ new Matrix4();\nconst _invMatrix = /* @__PURE__ */ new Matrix4();\nconst _raycaster = /* @__PURE__ */ new Raycaster();\nconst _doubleSidedMaterial = /* @__PURE__ */ new MeshBasicMaterial( { side: DoubleSide } );\nconst _box = /* @__PURE__ */ new Box3();\nconst RAYCAST_DISTANCE = 1e5;\n\nfunction calculateSphere( object, target ) {\n\n\tif ( object.isBufferGeometry ) {\n\n\t\tif ( object.boundingSphere === null ) {\n\n\t\t\tobject.computeBoundingSphere();\n\n\t\t}\n\n\t\treturn target.copy( object.boundingSphere );\n\n\t} else {\n\n\t\t_box.setFromObject( object );\n\t\t_box.getBoundingSphere( target );\n\t\treturn target;\n\n\t}\n\n}\n\nexport class TileFlatteningPlugin {\n\n\tconstructor() {\n\n\t\tthis.name = 'TILE_FLATTENING_PLUGIN';\n\t\tthis.priority = - 100;\n\n\t\tthis.tiles = null;\n\t\tthis.shapes = new Map();\n\t\tthis.positionsMap = new Map();\n\t\tthis.positionsUpdated = new Set();\n\t\tthis.needsUpdate = false;\n\n\t}\n\n\tinit( tiles ) {\n\n\t\tthis.tiles = tiles;\n\t\tthis.needsUpdate = true;\n\n\t\tthis._updateBeforeCallback = () => {\n\n\t\t\tif ( this.needsUpdate ) {\n\n\t\t\t\tthis._updateTiles();\n\t\t\t\tthis.needsUpdate = false;\n\n\t\t\t}\n\n\t\t};\n\n\t\tthis._disposeModelCallback = ( { tile } ) => {\n\n\t\t\tthis.positionsMap.delete( tile );\n\t\t\tthis.positionsUpdated.delete( tile );\n\n\t\t};\n\n\t\ttiles.addEventListener( 'update-before', this._updateBeforeCallback );\n\t\ttiles.addEventListener( 'dispose-model', this._disposeModelCallback );\n\n\t}\n\n\t// update tile flattening state if it has not been made visible, yet\n\tsetTileActive( tile, active ) {\n\n\t\tif ( active && ! this.positionsUpdated.has( tile ) ) {\n\n\t\t\tthis._updateTile( tile );\n\n\t\t}\n\n\t}\n\n\t_updateTile( tile ) {\n\n\t\tconst { positionsUpdated, positionsMap, shapes, tiles } = this;\n\t\tpositionsUpdated.add( tile );\n\n\t\tconst scene = tile.engineData.scene;\n\t\tif ( ! positionsMap.has( tile ) ) {\n\n\t\t\t// save the geometry positions for resetting after\n\t\t\tconst geomMap = new Map();\n\t\t\tpositionsMap.set( tile, geomMap );\n\t\t\tscene.traverse( c => {\n\n\t\t\t\tif ( c.geometry ) {\n\n\t\t\t\t\tgeomMap.set( c.geometry, c.geometry.attributes.position.array.slice() );\n\n\t\t\t\t}\n\n\t\t\t} );\n\n\t\t} else {\n\n\t\t\t// reset the geometry state before re-flattening tiles\n\t\t\tconst geomMap = positionsMap.get( tile );\n\t\t\tscene.traverse( c => {\n\n\t\t\t\tif ( c.geometry ) {\n\n\t\t\t\t\tconst buffer = geomMap.get( c.geometry );\n\t\t\t\t\tif ( buffer ) {\n\n\t\t\t\t\t\tc.geometry.attributes.position.array.set( buffer );\n\t\t\t\t\t\tc.geometry.attributes.position.needsUpdate = true;\n\n\t\t\t\t\t}\n\n\t\t\t\t}\n\n\t\t\t} );\n\n\t\t}\n\n\t\t// TODO: if we save the sphere of the original mesh we can check the height to limit the tiles checked\n\t\t// TODO: we should use the tile bounding volume sphere if present\n\t\tscene.updateMatrixWorld( true );\n\n\t\t// iterate over every geometry\n\t\tscene.traverse( c => {\n\n\t\t\tconst { geometry } = c;\n\n\t\t\tif ( ! geometry ) {\n\n\t\t\t\treturn;\n\n\t\t\t}\n\n\t\t\t// calculate matrices\n\t\t\t_matrix.copy( c.matrixWorld );\n\t\t\tif ( scene.parent !== null ) {\n\n\t\t\t\t_matrix.premultiply( tiles.group.matrixWorldInverse );\n\n\t\t\t}\n\n\t\t\t_invMatrix.copy( _matrix ).invert();\n\n\t\t\t// calculate sphere for mesh\n\t\t\tcalculateSphere( geometry, _sphere ).applyMatrix4( _matrix );\n\n\t\t\t// iterate over each shape\n\t\t\tshapes.forEach( ( {\n\t\t\t\tshape,\n\t\t\t\tdirection,\n\t\t\t\tsphere,\n\n\t\t\t\tthresholdMode,\n\t\t\t\tthreshold,\n\t\t\t\tflattenRange,\n\t\t\t} ) => {\n\n\t\t\t\t// check if the spheres overlap so there may actually be potential of geometry overlap\n\t\t\t\t_vec.subVectors( _sphere.center, sphere.center );\n\t\t\t\t_vec.addScaledVector( direction, - direction.dot( _vec ) );\n\n\t\t\t\tconst r2 = ( _sphere.radius + sphere.radius ) ** 2;\n\t\t\t\tif ( _vec.lengthSq() > r2 ) {\n\n\t\t\t\t\treturn;\n\n\t\t\t\t}\n\n\t\t\t\t// iterate over every vertex position\n\t\t\t\tconst { position } = geometry.attributes;\n\t\t\t\tconst { ray } = _raycaster;\n\t\t\t\tray.direction.copy( direction ).multiplyScalar( - 1 );\n\t\t\t\tfor ( let i = 0, l = position.count; i < l; i ++ ) {\n\n\t\t\t\t\tray.origin\n\t\t\t\t\t\t.fromBufferAttribute( position, i )\n\t\t\t\t\t\t.applyMatrix4( _matrix )\n\t\t\t\t\t\t.addScaledVector( direction, RAYCAST_DISTANCE );\n\t\t\t\t\t_raycaster.far = RAYCAST_DISTANCE;\n\n\t\t\t\t\tconst hit = _raycaster.intersectObject( shape )[ 0 ];\n\t\t\t\t\tif ( hit ) {\n\n\t\t\t\t\t\tlet rangeAlpha = ( RAYCAST_DISTANCE - hit.distance ) / threshold;\n\t\t\t\t\t\tconst aboveThreshold = rangeAlpha >= 1;\n\t\t\t\t\t\tif ( ! aboveThreshold || aboveThreshold && thresholdMode === 'flatten' ) {\n\n\t\t\t\t\t\t\trangeAlpha = Math.min( rangeAlpha, 1.0 );\n\n\t\t\t\t\t\t\thit.point.addScaledVector( ray.direction, MathUtils.mapLinear( rangeAlpha, 0, 1, - flattenRange, 0 ) );\n\t\t\t\t\t\t\thit.point.applyMatrix4( _invMatrix );\n\t\t\t\t\t\t\tposition.setXYZ( i, ...hit.point );\n\n\t\t\t\t\t\t}\n\n\t\t\t\t\t}\n\n\t\t\t\t}\n\n\t\t\t} );\n\n\t\t} );\n\n\n\t\tthis.tiles.dispatchEvent( { type: 'needs-render' } );\n\n\t}\n\n\t_updateTiles() {\n\n\t\tthis.positionsUpdated.clear();\n\t\tthis.tiles.activeTiles.forEach( tile => this._updateTile( tile ) );\n\n\t}\n\n\t// API for updating and shapes to flatten the vertices\n\thasShape( mesh ) {\n\n\t\treturn this.shapes.has( mesh );\n\n\t}\n\n\taddShape( mesh, direction = new Vector3( 0, 0, - 1 ), options = {} ) {\n\n\t\tif ( this.hasShape( mesh ) ) {\n\n\t\t\tthrow new Error( 'TileFlatteningPlugin: Shape is already used.' );\n\n\t\t}\n\n\t\tif ( typeof options === 'number' ) {\n\n\t\t\tconsole.warn( 'TileFlatteningPlugin: \"addShape\" function signature has changed. Please use an options object, instead.' );\n\t\t\toptions = {\n\t\t\t\tthreshold: options,\n\t\t\t};\n\n\t\t}\n\n\t\tthis.needsUpdate = true;\n\n\t\tconst shape = mesh.clone();\n\t\tshape.updateMatrixWorld( true );\n\t\tshape.traverse( c => {\n\n\t\t\tif ( c.material ) {\n\n\t\t\t\tc.material = _doubleSidedMaterial;\n\n\t\t\t}\n\n\t\t} );\n\n\t\tconst sphere = calculateSphere( shape, new Sphere() );\n\t\tthis.shapes.set( mesh, {\n\t\t\tshape: shape,\n\t\t\tdirection: direction.clone(),\n\t\t\tsphere: sphere,\n\n\t\t\t// \"flatten\": Flattens the vertices above the shape\n\t\t\t// \"none\": leaves the vertices above the shape as they are\n\t\t\tthresholdMode: 'none',\n\n\t\t\t// only flatten within this range above the object\n\t\t\tthreshold: Infinity,\n\n\t\t\t// the range to flatten vertices in to. 0 is completely flat\n\t\t\t// while 0.1 means a 10cm range.\n\t\t\tflattenRange: 0,\n\n\t\t\t...options,\n\t\t} );\n\n\t}\n\n\tupdateShape( mesh ) {\n\n\t\tif ( ! this.hasShape( mesh ) ) {\n\n\t\t\tthrow new Error( 'TileFlatteningPlugin: Shape is not present.' );\n\n\t\t}\n\n\t\tconst { direction, threshold, thresholdMode, flattenRange } = this.shapes.get( mesh );\n\t\tthis.deleteShape( mesh );\n\t\tthis.addShape( mesh, direction, {\n\t\t\tthreshold,\n\t\t\tthresholdMode,\n\t\t\tflattenRange,\n\t\t} );\n\n\t}\n\n\tdeleteShape( mesh ) {\n\n\t\tthis.needsUpdate = true;\n\t\treturn this.shapes.delete( mesh );\n\n\t}\n\n\tclearShapes() {\n\n\t\tif ( this.shapes.size === 0 ) {\n\n\t\t\treturn;\n\n\t\t}\n\n\t\tthis.needsUpdate = true;\n\t\tthis.shapes.clear();\n\n\t}\n\n\t// reset the vertex positions and remove the update callback\n\tdispose() {\n\n\t\tthis.tiles.removeEventListener( 'before-update', this._updateBeforeCallback );\n\t\tthis.tiles.removeEventListener( 'dispose-model', this._disposeModelCallback );\n\n\t\tthis.positionsMap.forEach( geomMap => {\n\n\t\t\tgeomMap.forEach( ( buffer, geometry ) => {\n\n\t\t\t\tconst { position } = geometry.attributes;\n\t\t\t\tposition.array.set( buffer );\n\t\t\t\tposition.needsUpdate = true;\n\n\t\t\t} );\n\n\t\t} );\n\n\t}\n\n}\n","import { forwardRef, useCallback, useContext, useEffect, useMemo, useState } from 'react';\nimport { TilesPlugin, TilesPluginContext, TilesRendererContext } from '3d-tiles-renderer/r3f';\nimport { TileFlatteningPlugin as TileFlatteningPluginImpl } from '3d-tiles-renderer/plugins';\nimport { Box3, Group, Matrix4, Vector3 } from 'three';\nimport { useFrame } from '@react-three/fiber';\n\n// NOTE: The flattening shape will not automatically update when child geometry vertices are adjusted so in order\n// to force a remount of the component the use should modify a \"key\" property when it needs to change.\n\n// construct a hash relative to a frame\nconst _matrix = /* @__PURE__ */ new Matrix4();\nfunction objectHash( obj, relativeMatrix ) {\n\n\tlet hash = '';\n\tobj.traverse( c => {\n\n\t\tlet mat = c.matrix;\n\t\tif ( c === obj ) {\n\n\t\t\t_matrix.copy( obj.matrixWorld ).premultiply( relativeMatrix );\n\t\t\tmat = _matrix;\n\n\t\t}\n\n\t\tif ( c.geometry ) {\n\n\t\t\thash += c.geometry.uuid + '_';\n\n\t\t}\n\n\t\tmat.elements.forEach( v => {\n\n\t\t\thash += v.toFixed( 6 ) + ',';\n\n\t\t} );\n\n\t} );\n\n\treturn hash;\n\n}\n\n// Helper class for adding a flattening shape to the scene\nexport function TileFlatteningShape( props ) {\n\n\t// Get the plugins and tiles\n\tconst plugin = useContext( TilesPluginContext );\n\tconst tiles = useContext( TilesRendererContext );\n\n\tconst {\n\t\tchildren,\n\n\t\t// if true then the child geometry is rendered\n\t\tvisible = false,\n\n\t\t// the \"threshold\" option for \"addShape\"\n\t\tthreshold = Infinity,\n\t\tthresholdMode = 'none',\n\t\tflattenRange = 0,\n\n\t\t// the \"direction\" option for \"addShape\"\n\t\tdirection = null,\n\n\t\t// if true then a projection direction is derived from the shape position\n\t\t// relative to the tileset ellipsoid if \"direction\" is not present\n\t\trelativeToEllipsoid = false,\n\t} = props;\n\n\tconst [ group, setGroup ] = useState( null );\n\tconst [ hash, setHash ] = useState( null );\n\n\tconst relativeGroup = useMemo( () => {\n\n\t\treturn new Group();\n\n\t}, [] );\n\n\tconst updateShape = useCallback( () => {\n\n\t\tplugin.deleteShape( relativeGroup );\n\n\t\trelativeGroup.clear();\n\t\trelativeGroup.add( ...group.children.map( c => c.clone() ) );\n\n\t\t// ensure world transforms are up to date\n\t\ttiles.group.updateMatrixWorld();\n\t\tgroup.updateMatrixWorld( true );\n\n\t\trelativeGroup\n\t\t\t.matrixWorld\n\t\t\t.copy( group.matrixWorld )\n\t\t\t.premultiply( tiles.group.matrixWorldInverse )\n\t\t\t.decompose( relativeGroup.position, relativeGroup.quaternion, relativeGroup.scale );\n\n\t\t// Calculate the direction to flatten on\n\t\tconst _direction = new Vector3();\n\t\tif ( direction ) {\n\n\t\t\t_direction.copy( direction );\n\n\t\t} else if ( relativeToEllipsoid ) {\n\n\t\t\tconst box = new Box3();\n\t\t\tbox.setFromObject( relativeGroup );\n\t\t\tbox.getCenter( _direction );\n\t\t\ttiles.ellipsoid.getPositionToNormal( _direction, _direction ).multiplyScalar( - 1 );\n\n\t\t} else {\n\n\t\t\t_direction.set( 0, 0, 1 );\n\n\t\t}\n\n\t\t// add a shape to the plugin\n\t\tplugin.addShape( relativeGroup, _direction, {\n\t\t\tthreshold,\n\t\t\tthresholdMode,\n\t\t\tflattenRange,\n\t\t} );\n\n\t\tsetHash( objectHash( group, tiles.group.matrixWorldInverse ) );\n\n\t}, [ tiles, group, direction, relativeToEllipsoid, plugin, threshold, thresholdMode, flattenRange, relativeGroup ] );\n\n\t// Add the provided shape to the tileset\n\tuseEffect( () => {\n\n\t\tif ( tiles === null || group === null || plugin === null ) {\n\n\t\t\treturn;\n\n\t\t}\n\n\t\tupdateShape();\n\n\t\treturn () => {\n\n\t\t\tplugin.deleteShape( relativeGroup );\n\n\t\t};\n\n\t}, [ group, plugin, relativeGroup, tiles, updateShape ] );\n\n\tuseFrame( () => {\n\n\t\tif ( ! tiles || ! group ) {\n\n\t\t\treturn;\n\n\t\t}\n\n\t\t// check if the object needs to updated\n\t\tconst newHash = objectHash( group, tiles.group.matrixWorldInverse );\n\t\tif ( hash !== newHash ) {\n\n\t\t\tupdateShape();\n\n\t\t}\n\n\t} );\n\n\treturn <group ref={ setGroup } visible={ visible } raycast={ () => false }>{ children }</group>;\n\n}\n\n// Wrapper for TilesFlatteningPlugin\nexport const TileFlatteningPlugin = forwardRef( function TileFlatteningPlugin( props, ref ) {\n\n\tconst { children, ...rest } = props;\n\n\treturn <TilesPlugin plugin={ TileFlatteningPluginImpl } ref={ ref } { ...rest }>{ children }</TilesPlugin>;\n\n} );\n","import { StrictMode } from 'react';\nimport { createRoot } from 'react-dom/client';\nimport { Canvas } from '@react-three/fiber';\nimport { Environment, GizmoHelper, GizmoViewport } from '@react-three/drei';\nimport { TilesPlugin, TilesRenderer, EnvironmentControls, EastNorthUpFrame } from '3d-tiles-renderer/r3f';\nimport { TilesFadePlugin, GLTFExtensionsPlugin, ReorientationPlugin, CesiumIonAuthPlugin, UpdateOnChangePlugin } from '3d-tiles-renderer/plugins';\nimport { TileFlatteningPlugin, TileFlatteningShape } from './plugins/TileFlatteningPlugin.jsx';\nimport { DRACOLoader } from 'three/examples/jsm/loaders/DRACOLoader.js';\nimport {\n\tMathUtils,\n} from 'three';\n\nconst dracoLoader = new DRACOLoader().setDecoderPath( 'https://www.gstatic.com/draco/v1/decoders/' );\n\nconst LAT = 35.3606 * MathUtils.DEG2RAD;\nconst LON = 138.7274 * MathUtils.DEG2RAD;\nfunction App() {\n\n\treturn (\n\t\t<Canvas\n\t\t\tcamera={ {\n\t\t\t\tposition: [ 1e4 * 0.7, 1e4 * 0.7, 1e4 * 0.7 ],\n\t\t\t\tfar: 1600000\n\t\t\t} }\n\t\t\tstyle={ {\n\t\t\t\twidth: '100%',\n\t\t\t\theight: '100%',\n\t\t\t\tposition: 'absolute',\n\t\t\t\tmargin: 0,\n\t\t\t\tleft: 0,\n\t\t\t\ttop: 0,\n\t\t\t} }\n\t\t>\n\t\t\t{/* 3D Tiles renderer tileset */}\n\t\t\t<TilesRenderer group={ { rotation: [ - Math.PI / 2, 0, 0 ] } }>\n\t\t\t\t<TilesPlugin plugin={ CesiumIonAuthPlugin } args={ { apiToken: import.meta.env.VITE_ION_KEY, assetId: '2275207', autoRefreshToken: true } } />\n\t\t\t\t<TilesPlugin plugin={ GLTFExtensionsPlugin } dracoLoader={ dracoLoader } />\n\t\t\t\t<TilesPlugin plugin={ UpdateOnChangePlugin } />\n\t\t\t\t<TilesPlugin plugin={ TilesFadePlugin } />\n\t\t\t\t<TilesPlugin plugin={ ReorientationPlugin } args={ { lat: LAT, lon: LON } } />\n\t\t\t\t<TileFlatteningPlugin>\n\t\t\t\t\t<TileFlatteningShape relativeToEllipsoid visible={ false }>\n\t\t\t\t\t\t<EastNorthUpFrame lat={ LAT } lon={ LON } height={ 1000 }>\n\t\t\t\t\t\t\t<mesh scale={ 5000 }>\n\t\t\t\t\t\t\t\t<circleGeometry />\n\t\t\t\t\t\t\t</mesh>\n\t\t\t\t\t\t</EastNorthUpFrame>\n\t\t\t\t\t</TileFlatteningShape>\n\t\t\t\t</TileFlatteningPlugin>\n\n\t\t\t</TilesRenderer>\n\n\t\t\t{/* Controls */}\n\t\t\t<EnvironmentControls\n\t\t\t\tenableDamping={ true }\n\t\t\t\tmaxDistance={ 1e4 * 2 }\n\t\t\t\tminDistance={ 500 }\n\t\t\t\tminPolarAngle={ 0 }\n\t\t\t\tmaxPolarAngle={ 3 * Math.PI / 8 }\n\t\t\t/>\n\n\t\t\t{/* other r3f staging */}\n\t\t\t<Environment\n\t\t\t\tpreset=\"sunset\" background={ true }\n\t\t\t\tbackgroundBlurriness={ 0.9 }\n\t\t\t\tenvironmentIntensity={ 1 }\n\t\t\t/>\n\t\t\t<GizmoHelper alignment=\"bottom-right\">\n\t\t\t\t<GizmoViewport />\n\t\t\t</GizmoHelper>\n\t\t</Canvas>\n\t);\n\n}\n\ncreateRoot( document.getElementById( 'root' ) ).render(\n\t<StrictMode>\n\t\t<App />\n\t</StrictMode>,\n);\n\n"],"names":["_sphere","Sphere","_vec","Vector3","_matrix","Matrix4","_invMatrix","_raycaster","Raycaster","_doubleSidedMaterial","MeshBasicMaterial","DoubleSide","_box","Box3","RAYCAST_DISTANCE","calculateSphere","object","target","TileFlatteningPlugin$1","tiles","tile","active","positionsUpdated","positionsMap","shapes","scene","geomMap","c","buffer","geometry","shape","direction","sphere","thresholdMode","threshold","flattenRange","r2","position","ray","i","l","hit","rangeAlpha","aboveThreshold","MathUtils","mesh","options","objectHash","obj","relativeMatrix","hash","mat","v","TileFlatteningShape","props","plugin","useContext","TilesPluginContext","TilesRendererContext","children","visible","relativeToEllipsoid","group","setGroup","useState","setHash","relativeGroup","useMemo","Group","updateShape","useCallback","_direction","box","useEffect","useFrame","newHash","jsx","TileFlatteningPlugin","forwardRef","ref","rest","TilesPlugin","TileFlatteningPluginImpl","dracoLoader","DRACOLoader","LAT","LON","App","jsxs","Canvas","TilesRenderer","CesiumIonAuthPlugin","GLTFExtensionsPlugin","UpdateOnChangePlugin","TilesFadePlugin","ReorientationPlugin","EastNorthUpFrame","EnvironmentControls","Environment","GizmoHelper","GizmoViewport","createRoot","StrictMode"],"mappings":"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"}