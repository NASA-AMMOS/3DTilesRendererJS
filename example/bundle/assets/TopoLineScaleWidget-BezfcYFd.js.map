{"version":3,"file":"TopoLineScaleWidget-BezfcYFd.js","sources":["../../r3f/components/TopoLineScaleWidget.jsx"],"sourcesContent":["import { CanvasDOMOverlay, TilesRendererContext } from '3d-tiles-renderer/r3f';\nimport { useThree } from '@react-three/fiber';\nimport { useContext, useEffect, useState } from 'react';\nimport { Vector3, MathUtils } from 'three';\n\nconst _v0 = /* @__PURE__ */new Vector3();\nconst _v1 = /* @__PURE__ */new Vector3();\nfunction calculatePixelWidth( camera, resolution, distance ) {\n\n\t// calculate two projected points at the given distance into NDC\n\tconst X_DELTA = 0.01;\n\tconst v0 = _v0.set( 0, 0, - distance ).applyMatrix4( camera.projectionMatrix );\n\tconst v1 = _v1.set( X_DELTA, 0, - distance ).applyMatrix4( camera.projectionMatrix );\n\n\t// calculate how many pixels per meter\n\tconst pixelsPerMeter = ( Math.abs( v0.x - v1.x ) * resolution.width * 0.5 ) / X_DELTA;\n\treturn 1 / pixelsPerMeter;\n\n}\n\n// format a number to be human readable with units\nfunction formatNumber( v ) {\n\n\tif ( v === null ) {\n\n\t\treturn '--';\n\n\t}\n\n\tconst info = getDisplayValue( v );\n\tconst display = parseFloat( info.value.toFixed( 2 ) ).toString().replace( /^-/, '- ' );\n\treturn `${ display }${ info.unit }`;\n\n}\n\n// returns a unit and adjusted value for display\nfunction getDisplayValue( value ) {\n\n\tconst pow = Math.ceil( Math.log10( Math.abs( value ) ) );\n\tlet unit = 'm';\n\tlet exp = 0;\n\n\tswitch ( MathUtils.clamp( pow, - 6, 2 ) ) {\n\n\t\tcase 2:\n\t\t\tunit = 'km';\n\t\t\texp = 3;\n\t\t\tbreak;\n\t\tcase 1: case 0: case - 1:\n\t\t\tunit = 'm';\n\t\t\texp = 0;\n\t\t\tbreak;\n\t\tcase - 2:\n\t\t\tunit = 'cm';\n\t\t\texp = - 2;\n\t\t\tbreak;\n\t\tcase - 3: case - 4: case - 5:\n\t\t\tunit = 'mm';\n\t\t\texp = - 3;\n\t\t\tbreak;\n\t\tcase - 6:\n\t\t\tunit = 'Î¼M';\n\t\t\texp = - 6;\n\t\t\tbreak;\n\n\t\tdefault:\n\t\t\tthrow new Error();\n\n\t}\n\n\treturn {\n\t\tunit,\n\t\tvalue: value * Math.pow( 10, - exp ),\n\t};\n\n}\n\nexport function TopoLineScaleWidget( { invert } ) {\n\n\tconst get = useThree( ( { get } ) => get );\n\tconst gl = useThree( ( { gl } ) => gl );\n\tconst pointer = useThree( ( { pointer } ) => pointer );\n\tconst [ info, setInfo ] = useState( null );\n\tconst tiles = useContext( TilesRendererContext );\n\tconst element = gl.domElement;\n\n\t// add callback for mouse movement\n\tuseEffect( () => {\n\n\t\tconst callback = () => {\n\n\t\t\t// get the topo plugin\n\t\t\tconst plugin = tiles && tiles.getPluginByName( 'TOPO_LINES_PLUGIN' );\n\t\t\tif ( plugin ) {\n\n\t\t\t\tconst { pointer, camera, scene, raycaster } = get();\n\n\t\t\t\t// get the hovered point\n\t\t\t\traycaster.setFromCamera( pointer, camera );\n\t\t\t\tconst hit = raycaster.intersectObject( scene )[ 0 ];\n\n\t\t\t\tif ( hit ) {\n\n\t\t\t\t\t// retrieve the topo line & elevation info\n\t\t\t\t\tconst elevation = plugin.computeTopographicLineInfo( camera, hit.point );\n\t\t\t\t\tconst length = { metersPerPixel: calculatePixelWidth( camera, plugin.resolution, hit.distance ) };\n\n\t\t\t\t\tif ( invert ) {\n\n\t\t\t\t\t\televation.value *= - 1;\n\n\t\t\t\t\t}\n\n\t\t\t\t\tsetInfo( {\n\t\t\t\t\t\televation,\n\t\t\t\t\t\tlength,\n\t\t\t\t\t} );\n\n\t\t\t\t} else {\n\n\t\t\t\t\tsetInfo( null );\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t};\n\n\t\telement.addEventListener( 'pointermove', callback );\n\t\telement.addEventListener( 'wheel', callback );\n\n\t\treturn () => {\n\n\t\t\telement.removeEventListener( 'pointermove', callback );\n\t\t\telement.removeEventListener( 'wheel', callback );\n\n\t\t};\n\n\t}, [ get, element, tiles, invert ] );\n\n\t// extract the needed values\n\tlet elevationValue = null;\n\tlet stepInPixels = 5;\n\tlet stepInMeters = null;\n\tlet finalWidth = 0;\n\tlet adjustedMeters = null;\n\tif ( info ) {\n\n\t\t// pixels are specified in drawing buffer size while css units account for dpr\n\t\tconst dpr = window.devicePixelRatio;\n\n\t\t// elevation info\n\t\tconst stepInfo = info.elevation.alpha < 0.25 ? info.elevation.max : info.elevation.min;\n\t\televationValue = info.elevation.value;\n\t\tstepInPixels = stepInfo.stepInPixels / dpr;\n\t\tstepInMeters = stepInfo.step;\n\n\t\t// length info\n\t\tconst MAX_PIXEL_WIDTH = 50;\n\t\tconst metersPerPixel = info.length.metersPerPixel * dpr;\n\t\tconst targetMeters = MAX_PIXEL_WIDTH * metersPerPixel;\n\t\tadjustedMeters = 10 ** Math.floor( Math.log10( targetMeters ) );\n\t\tfinalWidth = adjustedMeters / metersPerPixel;\n\t\tif ( finalWidth * 5 < MAX_PIXEL_WIDTH ) {\n\n\t\t\tadjustedMeters *= 5;\n\t\t\tfinalWidth *= 5;\n\n\t\t}\n\n\t\tif ( finalWidth * 2.5 < MAX_PIXEL_WIDTH ) {\n\n\t\t\tadjustedMeters *= 2.5;\n\t\t\tfinalWidth *= 2.5;\n\n\t\t}\n\n\t}\n\n\t// construct the ticks for the topo lines\n\tconst tickElement = <div style={ {\n\t\tflexGrow: 1,\n\t\tdisplay: 'flex',\n\t\tflexDirection: 'column',\n\t\toverflow: 'hidden',\n\t\talignItems: 'end',\n\t\tjustifyContent: 'end',\n\t\tpaddingBottom: '0.5em',\n\t} }>\n\t\t{\n\t\t\tnew Array( 10 )\n\t\t\t\t.fill()\n\t\t\t\t.map( ( e, i ) => {\n\n\t\t\t\t\treturn <div\n\t\t\t\t\t\tkey={ i }\n\t\t\t\t\t\tstyle={ {\n\t\t\t\t\t\t\tminHeight: i === 9 ? '1px' : '1px',\n\t\t\t\t\t\t\topacity: i === 9 ? 1 : 0.5,\n\t\t\t\t\t\t\twidth: i === 9 ? '15px' : '10px',\n\t\t\t\t\t\t\tbackground: 'white',\n\t\t\t\t\t\t\tmarginTop: stepInPixels,\n\t\t\t\t\t\t} }\n\t\t\t\t\t/>;\n\n\t\t\t\t} )\n\t\t}</div>;\n\n\t// construct the element for displaying the tick measurements\n\tconst tickMeasureElement = <div style={ {\n\t\tdisplay: 'flex',\n\t\toverflow: 'hidden',\n\t\tflexGrow: 1,\n\t} }>\n\t\t<div style={ {\n\t\t\tdisplay: 'flex',\n\t\t\tflexDirection: 'column',\n\t\t\tflexGrow: 1,\n\t\t\tjustifyContent: 'end',\n\t\t} }>\n\t\t\t<div>{ formatNumber( stepInMeters ) }</div>\n\t\t\t<div>{ formatNumber( stepInMeters * 10.0 || null ) }</div>\n\t\t</div>\n\t\t{ tickElement }\n\t</div>;\n\n\t// construct the element for pixel width display\n\tconst widthMeasureElement = <div style= { {\n\t\tmarginTop: '10px',\n\t} }>\n\t\t<div style={ {\n\t\t\tdisplay: 'flex',\n\t\t} }>\n\t\t\t<div style={ {\n\t\t\t\tflexGrow: 1,\n\t\t\t} }>{ formatNumber( adjustedMeters ) }</div>\n\t\t\t<div>len</div>\n\t\t</div>\n\t\t<div style={ {\n\t\t\theight: '2px',\n\t\t\tborderTop: '1px solid white',\n\t\t\tborderLeft: '1px solid white',\n\t\t\tborderRight: '1px solid white',\n\t\t\twidth: finalWidth === 0 ? '100%' : `${ finalWidth }px`,\n\t\t} }></div>\n\t</div>;\n\n\t// construct the elevation display element\n\tconst elevationElement = <div style={ {\n\t\tdisplay: 'flex',\n\t\tmarginTop: '10px',\n\t} }>\n\t\t<div style={ {\n\t\t\tflexGrow: 1,\n\t\t} }>{ formatNumber( elevationValue ) }</div>\n\t\t<div>el</div>\n\t</div>;\n\n\tconst mouseEl = <div style={ {\n\t\tposition: 'absolute',\n\t\tleft: `${ ( pointer.x * 0.5 + 0.5 ) * 100 }%`,\n\t\ttop: `${ 100 - ( pointer.y * 0.5 + 0.5 ) * 100 }%`,\n\t\tcolor: 'white',\n\t\tfontSize: '12px',\n\t\tpointerEvents: 'none',\n\t\ttextShadow: '0px 0px 4px rgba( 0, 0, 0, 0.5 )',\n\t} }>\n\t\t<div style={ {\n\t\t\ttransform: 'translateX( -50% ) translateY( -125% )'\n\t\t} }>{ elevationValue ? formatNumber( elevationValue ) : '' }</div>\n\t</div>;\n\n\treturn <CanvasDOMOverlay>\n\t\t{ mouseEl }\n\n\t\t<div style={ {\n\t\t\tpadding: '5px',\n\t\t\twidth: '65px',\n\t\t\theight: '80px',\n\t\t\tposition: 'absolute',\n\t\t\tleft: 5,\n\t\t\tbottom: 5,\n\t\t\tbackground: 'rgb( 0, 0, 0, 0.2 )',\n\t\t\tborderRadius: 3,\n\t\t\tcolor: 'white',\n\t\t\tdisplay: 'flex',\n\t\t\tflexDirection: 'column',\n\t\t\tfontSize: '12px',\n\t\t} }>\n\n\t\t\t{ tickMeasureElement }\n\n\t\t\t{ elevationElement }\n\n\t\t\t{ widthMeasureElement }\n\t\t</div>\n\t</CanvasDOMOverlay>;\n\n}\n"],"names":["_v0","Vector3","_v1","calculatePixelWidth","camera","resolution","distance","v0","v1","formatNumber","v","info","getDisplayValue","value","pow","unit","exp","MathUtils","TopoLineScaleWidget","invert","get","useThree","gl","pointer","setInfo","useState","tiles","useContext","TilesRendererContext","element","useEffect","callback","plugin","scene","raycaster","hit","elevation","length","elevationValue","stepInPixels","stepInMeters","finalWidth","adjustedMeters","dpr","stepInfo","MAX_PIXEL_WIDTH","metersPerPixel","targetMeters","tickElement","jsx","e","i","tickMeasureElement","jsxs","widthMeasureElement","elevationElement","mouseEl","CanvasDOMOverlay"],"mappings":"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"}