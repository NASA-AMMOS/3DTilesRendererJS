import{C as c}from"./CesiumIonAuth-ByA9ya_o.js";import{b as f}from"./TilesRendererBase-CFsQu8zV.js";class d{constructor(){this.creditsCount={}}_adjustAttributions(t,s){const e=this.creditsCount,i=t.split(/;/g);for(let o=0,a=i.length;o<a;o++){const n=i[o];n in e||(e[n]=0),e[n]+=s?1:-1,e[n]<=0&&delete e[n]}}addAttributions(t){this._adjustAttributions(t,!0)}removeAttributions(t){this._adjustAttributions(t,!1)}toString(){return Object.entries(this.creditsCount).sort((s,e)=>{const i=s[1];return e[1]-i}).map(s=>s[0]).join("; ")}}const p="https://tile.googleapis.com/v1/3dtiles/root.json";class T{constructor({apiToken:t,sessionOptions:s=null,autoRefreshToken:e=!1,logoUrl:i=null,useRecommendedSettings:o=!0}){this.name="GOOGLE_CLOUD_AUTH_PLUGIN",this.apiToken=t,this.useRecommendedSettings=o,this.logoUrl=i,this.auth=new g({apiToken:t,autoRefreshToken:e,sessionOptions:s}),this.tiles=null,this._visibilityChangeCallback=null,this._attributionsManager=new d,this._logoAttribution={value:"",type:"image",collapsible:!1},this._attribution={value:"",type:"string",collapsible:!0}}init(t){const{useRecommendedSettings:s,auth:e}=this;t.resetFailedTiles(),t.rootURL==null&&(t.rootURL=p),e.sessionOptions||(e.authURL=t.rootURL),s&&!e.isMapTilesSession&&(t.errorTarget=20),this.tiles=t,this._visibilityChangeCallback=({tile:i,visible:o})=>{var n,h;const a=((h=(n=i.engineData.metadata)==null?void 0:n.asset)==null?void 0:h.copyright)||"";o?this._attributionsManager.addAttributions(a):this._attributionsManager.removeAttributions(a)},t.addEventListener("tile-visibility-change",this._visibilityChangeCallback)}getAttributions(t){this.tiles.visibleTiles.size>0&&(this.logoUrl&&(this._logoAttribution.value=this.logoUrl,t.push(this._logoAttribution)),this._attribution.value=this._attributionsManager.toString(),t.push(this._attribution))}dispose(){this.tiles.removeEventListener("tile-visibility-change",this._visibilityChangeCallback)}async fetchData(t,s){return this.auth.fetch(t,s)}}let _=class{get apiToken(){return this.auth.apiToken}set apiToken(t){this.auth.apiToken=t}get autoRefreshToken(){return this.auth.autoRefreshToken}set autoRefreshToken(t){this.auth.autoRefreshToken=t}constructor(t={}){const{apiToken:s,assetId:e=null,autoRefreshToken:i=!1,useRecommendedSettings:o=!0,assetTypeHandler:a=(n,h,m)=>{console.warn(`CesiumIonAuthPlugin: Cesium Ion asset type "${n}" unhandled.`)}}=t;this.name="CESIUM_ION_AUTH_PLUGIN",this.auth=new c({apiToken:s,autoRefreshToken:i}),this.assetId=e,this.autoRefreshToken=i,this.useRecommendedSettings=o,this.assetTypeHandler=a,this.tiles=null,this._tileSetVersion=-1,this._attributions=[]}init(t){this.assetId!==null&&(t.rootURL=`https://api.cesium.com/v1/assets/${this.assetId}/endpoint`),this.tiles=t,this.auth.authURL=t.rootURL,t.resetFailedTiles()}loadRootTileset(){return this.auth.refreshToken().then(t=>(this._initializeFromAsset(t),this.tiles.invokeOnePlugin(s=>s!==this&&s.loadRootTileset&&s.loadRootTileset()))).catch(t=>{this.tiles.dispatchEvent({type:"load-error",tile:null,error:t,url:this.auth.authURL})})}preprocessURL(t){return t=new URL(t),/^http/.test(t.protocol)&&this._tileSetVersion!=-1&&t.searchParams.set("v",this._tileSetVersion),t.toString()}fetchData(t,s){return this.tiles.getPluginByName("GOOGLE_CLOUD_AUTH_PLUGIN")!==null?null:this.auth.fetch(t,s)}getAttributions(t){this.tiles.visibleTiles.size>0&&t.push(...this._attributions)}_initializeFromAsset(t){const s=this.tiles;if("externalType"in t){const e=new URL(t.options.url);s.rootURL=t.options.url,s.registerPlugin(new T({apiToken:e.searchParams.get("key"),autoRefreshToken:this.autoRefreshToken,useRecommendedSettings:this.useRecommendedSettings}))}else{t.type!=="3DTILES"&&this.assetTypeHandler(t.type,s,t),s.rootURL=t.url;const e=new URL(t.url);e.searchParams.has("v")&&this._tileSetVersion===-1&&(this._tileSetVersion=e.searchParams.get("v")),t.attributions&&(this._attributions=t.attributions.map(i=>({value:i.html,type:"html",collapsible:i.collapsible})))}}};const l="https://tile.googleapis.com/v1/createSession";class g{get isMapTilesSession(){return this.authURL===l}constructor(t={}){const{apiToken:s,sessionOptions:e=null,autoRefreshToken:i=!1}=t;this.apiToken=s,this.autoRefreshToken=i,this.authURL=l,this.sessionToken=null,this.sessionOptions=e,this._tokenRefreshPromise=null}async fetch(t,s){this.sessionToken===null&&this.isMapTilesSession&&this.refreshToken(s),await this._tokenRefreshPromise;const e=new URL(t);e.searchParams.set("key",this.apiToken),this.sessionToken&&e.searchParams.set("session",this.sessionToken);let i=await fetch(e,s);return i.status>=400&&i.status<=499&&this.autoRefreshToken&&(await this.refreshToken(s),this.sessionToken&&e.searchParams.set("session",this.sessionToken),i=await fetch(e,s)),this.sessionToken===null&&!this.isMapTilesSession?i.json().then(o=>(this.sessionToken=u(o),o)):i}refreshToken(t){if(this._tokenRefreshPromise===null){const s=new URL(this.authURL);s.searchParams.set("key",this.apiToken);const e={...t};this.isMapTilesSession&&(e.method="POST",e.body=JSON.stringify(this.sessionOptions),e.headers=e.headers||{},e.headers={...e.headers,"Content-Type":"application/json"}),this._tokenRefreshPromise=fetch(s,e).then(i=>{if(!i.ok)throw new Error(`GoogleCloudAuth: Failed to load data with error code ${i.status}`);return i.json()}).then(i=>(this.sessionToken=u(i),this._tokenRefreshPromise=null,i))}return this._tokenRefreshPromise}}function u(r){if("session"in r)return r.session;{let t=null;const s=r.root;return f(s,e=>{if(e.content&&e.content.uri){const[,i]=e.content.uri.split("?");return t=new URLSearchParams(i).get("session"),!0}return!1}),t}}export{_ as C};
//# sourceMappingURL=GoogleCloudAuth-vMnc9CC1.js.map
