{"version":3,"file":"CesiumIonAuth-ByA9ya_o.js","sources":["../../../src/core/plugins/auth/CesiumIonAuth.js"],"sourcesContent":["// Class for making fetches to Cesium Ion, refreshing the token if needed.\nexport class CesiumIonAuth {\n\n\tconstructor( options = {} ) {\n\n\t\tconst { apiToken, autoRefreshToken = false } = options;\n\t\tthis.apiToken = apiToken;\n\t\tthis.autoRefreshToken = autoRefreshToken;\n\t\tthis.authURL = null;\n\t\tthis._tokenRefreshPromise = null;\n\t\tthis._bearerToken = null;\n\n\t}\n\n\tasync fetch( url, options ) {\n\n\t\tawait this._tokenRefreshPromise;\n\n\t\t// insert the authorization token\n\t\tconst fetchOptions = { ...options };\n\t\tfetchOptions.headers = fetchOptions.headers || {};\n\t\tfetchOptions.headers = {\n\t\t\t...fetchOptions.headers,\n\t\t\tAuthorization: this._bearerToken,\n\t\t};\n\n\t\t// try to refresh the token if we failed to load the tile data\n\t\tconst res = await fetch( url, fetchOptions );\n\t\tif ( res.status >= 400 && res.status <= 499 && this.autoRefreshToken ) {\n\n\t\t\t// refresh the bearer token\n\t\t\tawait this.refreshToken( options );\n\t\t\tfetchOptions.headers.Authorization = this._bearerToken;\n\n\t\t\treturn fetch( url, fetchOptions );\n\n\t\t} else {\n\n\t\t\treturn res;\n\n\t\t}\n\n\t}\n\n\trefreshToken( options ) {\n\n\t\tif ( this._tokenRefreshPromise === null ) {\n\n\t\t\t// construct the url to fetch the endpoint\n\t\t\tconst url = new URL( this.authURL );\n\t\t\turl.searchParams.set( 'access_token', this.apiToken );\n\n\t\t\tthis._tokenRefreshPromise = fetch( url, options )\n\t\t\t\t.then( res => {\n\n\t\t\t\t\tif ( ! res.ok ) {\n\n\t\t\t\t\t\tthrow new Error( `CesiumIonAuthPlugin: Failed to load data with error code ${ res.status }` );\n\n\t\t\t\t\t}\n\n\t\t\t\t\treturn res.json();\n\n\t\t\t\t} )\n\t\t\t\t.then( json => {\n\n\t\t\t\t\tthis._bearerToken = `Bearer ${ json.accessToken }`;\n\t\t\t\t\tthis._tokenRefreshPromise = null;\n\n\t\t\t\t\treturn json;\n\n\t\t\t\t} );\n\n\t\t}\n\n\t\treturn this._tokenRefreshPromise;\n\n\t}\n\n}\n"],"names":["CesiumIonAuth","options","apiToken","autoRefreshToken","url","fetchOptions","res","json"],"mappings":"AACO,MAAMA,CAAc,CAE1B,YAAaC,EAAU,GAAK,CAE3B,KAAM,CAAE,SAAAC,EAAU,iBAAAC,EAAmB,EAAK,EAAKF,EAC/C,KAAK,SAAWC,EAChB,KAAK,iBAAmBC,EACxB,KAAK,QAAU,KACf,KAAK,qBAAuB,KAC5B,KAAK,aAAe,IAErB,CAEA,MAAM,MAAOC,EAAKH,EAAU,CAE3B,MAAM,KAAK,qBAGX,MAAMI,EAAe,CAAE,GAAGJ,CAAO,EACjCI,EAAa,QAAUA,EAAa,SAAW,CAAA,EAC/CA,EAAa,QAAU,CACtB,GAAGA,EAAa,QAChB,cAAe,KAAK,YACvB,EAGE,MAAMC,EAAM,MAAM,MAAOF,EAAKC,CAAY,EAC1C,OAAKC,EAAI,QAAU,KAAOA,EAAI,QAAU,KAAO,KAAK,kBAGnD,MAAM,KAAK,aAAcL,CAAO,EAChCI,EAAa,QAAQ,cAAgB,KAAK,aAEnC,MAAOD,EAAKC,CAAY,GAIxBC,CAIT,CAEA,aAAcL,EAAU,CAEvB,GAAK,KAAK,uBAAyB,KAAO,CAGzC,MAAMG,EAAM,IAAI,IAAK,KAAK,OAAO,EACjCA,EAAI,aAAa,IAAK,eAAgB,KAAK,QAAQ,EAEnD,KAAK,qBAAuB,MAAOA,EAAKH,CAAO,EAC7C,KAAMK,GAAO,CAEb,GAAK,CAAEA,EAAI,GAEV,MAAM,IAAI,MAAO,4DAA6DA,EAAI,MAAM,EAAG,EAI5F,OAAOA,EAAI,KAAI,CAEhB,CAAC,EACA,KAAMC,IAEN,KAAK,aAAe,UAAWA,EAAK,WAAW,GAC/C,KAAK,qBAAuB,KAErBA,EAEP,CAEH,CAEA,OAAO,KAAK,oBAEb,CAED"}