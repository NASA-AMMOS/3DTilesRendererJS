import{L as y,F as k,U as T,a as E,Q as A,P as O}from"./constants-JFoaxC9y.js";function W(t){if(!t)return null;let e=t.length;const r=t.indexOf("?"),a=t.indexOf("#");r!==-1&&(e=Math.min(e,r)),a!==-1&&(e=Math.min(e,a));const s=t.lastIndexOf(".",e),n=t.lastIndexOf("/",e),i=t.indexOf("://");return i!==-1&&i+2===n||s===-1||s<n?null:t.substring(s+1,e)||null}const Y=2**30;class Se{get unloadPriorityCallback(){return this._unloadPriorityCallback}set unloadPriorityCallback(e){e.length===1?(console.warn('LRUCache: "unloadPriorityCallback" function has been changed to take two arguments.'),this._unloadPriorityCallback=(r,a)=>{const s=e(r),n=e(a);return s<n?-1:s>n?1:0}):this._unloadPriorityCallback=e}constructor(){this.minSize=6e3,this.maxSize=8e3,this.minBytesSize=.3*Y,this.maxBytesSize=.4*Y,this.unloadPercent=.05,this.autoMarkUnused=!0,this.itemSet=new Map,this.itemList=[],this.usedSet=new Set,this.callbacks=new Map,this.unloadingHandle=-1,this.cachedBytes=0,this.bytesMap=new Map,this.loadedSet=new Set,this._unloadPriorityCallback=null;const e=this.itemSet;this.defaultPriorityCallback=r=>e.get(r)}isFull(){return this.itemSet.size>=this.maxSize||this.cachedBytes>=this.maxBytesSize}getMemoryUsage(e){return this.bytesMap.get(e)||0}setMemoryUsage(e,r){const{bytesMap:a,itemSet:s}=this;s.has(e)&&(this.cachedBytes-=a.get(e)||0,a.set(e,r),this.cachedBytes+=r)}add(e,r){const a=this.itemSet;if(a.has(e)||this.isFull())return!1;const s=this.usedSet,n=this.itemList,i=this.callbacks;return n.push(e),s.add(e),a.set(e,Date.now()),i.set(e,r),!0}has(e){return this.itemSet.has(e)}remove(e){const r=this.usedSet,a=this.itemSet,s=this.itemList,n=this.bytesMap,i=this.callbacks,o=this.loadedSet;if(a.has(e)){this.cachedBytes-=n.get(e)||0,n.delete(e),i.get(e)(e);const l=s.indexOf(e);return s.splice(l,1),r.delete(e),a.delete(e),i.delete(e),o.delete(e),!0}return!1}setLoaded(e,r){const{itemSet:a,loadedSet:s}=this;a.has(e)&&(r===!0?s.add(e):s.delete(e))}markUsed(e){const r=this.itemSet,a=this.usedSet;r.has(e)&&!a.has(e)&&(r.set(e,Date.now()),a.add(e))}markUnused(e){this.usedSet.delete(e)}markAllUnused(){this.usedSet.clear()}isUsed(e){return this.usedSet.has(e)}unloadUnusedContent(){const{unloadPercent:e,minSize:r,maxSize:a,itemList:s,itemSet:n,usedSet:i,loadedSet:o,callbacks:l,bytesMap:c,minBytesSize:h,maxBytesSize:m}=this,v=s.length-i.size,u=s.length-o.size,d=Math.max(Math.min(s.length-r,v),0),p=this.cachedBytes-h,U=this.unloadPriorityCallback||this.defaultPriorityCallback;let L=!1;const me=d>0&&v>0||u&&s.length>a;if(v&&this.cachedBytes>h||u&&this.cachedBytes>m||me){s.sort((f,C)=>{const G=i.has(f),Ce=i.has(C);if(G===Ce){const H=o.has(f),Te=o.has(C);return H===Te?-U(f,C):H?1:-1}else return G?1:-1});const pe=Math.max(r*e,d*e),_=Math.ceil(Math.min(pe,v,d)),ge=Math.max(e*p,e*h),ye=Math.min(ge,p);let g=0,R=0;for(;this.cachedBytes-R>m||s.length-g>a;){const f=s[g],C=c.get(f)||0;if(i.has(f)&&o.has(f)||this.cachedBytes-R-C<m&&s.length-g<=a)break;R+=C,g++}for(;R<ye||g<_;){const f=s[g],C=c.get(f)||0;if(i.has(f)||this.cachedBytes-R-C<h&&g>=_)break;R+=C,g++}s.splice(0,g).forEach(f=>{this.cachedBytes-=c.get(f)||0,l.get(f)(f),c.delete(f),n.delete(f),l.delete(f),o.delete(f),i.delete(f)}),L=g<d||R<p&&g<v,L=L&&g>0}L&&(this.unloadingHandle=requestAnimationFrame(()=>this.scheduleUnload()))}scheduleUnload(){cancelAnimationFrame(this.unloadingHandle),this.scheduled||(this.scheduled=!0,queueMicrotask(()=>{this.scheduled=!1,this.unloadUnusedContent()}))}}class K extends Error{constructor(){super("PriorityQueue: Item removed"),this.name="PriorityQueueItemRemovedError"}}class M{get running(){return this.items.length!==0||this.currJobs!==0}constructor(){this.maxJobs=6,this.items=[],this.callbacks=new Map,this.currJobs=0,this.scheduled=!1,this.autoUpdate=!0,this.priorityCallback=null,this.schedulingCallback=e=>{requestAnimationFrame(e)},this._runjobs=()=>{this.scheduled=!1,this.tryRunJobs()}}sort(){const e=this.priorityCallback,r=this.items;e!==null&&r.sort(e)}has(e){return this.callbacks.has(e)}add(e,r){const a={callback:r,reject:null,resolve:null,promise:null};return a.promise=new Promise((s,n)=>{const i=this.items,o=this.callbacks;a.resolve=s,a.reject=n,i.unshift(e),o.set(e,a),this.autoUpdate&&this.scheduleJobRun()}),a.promise}remove(e){const r=this.items,a=this.callbacks,s=r.indexOf(e);if(s!==-1){const n=a.get(e);n.promise.catch(i=>{if(!(i instanceof K))throw i}),n.reject(new K),r.splice(s,1),a.delete(e)}}removeByFilter(e){const{items:r}=this;for(let a=0;a<r.length;a++){const s=r[a];e(s)&&(this.remove(s),a--)}}tryRunJobs(){this.sort();const e=this.items,r=this.callbacks,a=this.maxJobs;let s=0;const n=()=>{this.currJobs--,this.autoUpdate&&this.scheduleJobRun()};for(;a>this.currJobs&&e.length>0&&s<a;){this.currJobs++,s++;const i=e.pop(),{callback:o,resolve:l,reject:c}=r.get(i);r.delete(i);let h;try{h=o(i)}catch(m){c(m),n()}h instanceof Promise?h.then(l).catch(c).finally(n):(l(h),n())}}scheduleJobRun(){this.scheduled||(this.schedulingCallback(this._runjobs),this.scheduled=!0)}}const x={inView:!1,error:1/0,distanceFromCamera:1/0};function B(t){return t===y||t===k}function b(t,e){return ee(t)&&t.traversal.lastFrameVisited===e&&t.traversal.used}function ee(t){return!!t.traversal}function F(t){const e=t.children.length===0||!!t.children[0].internal,r=!t.internal.hasUnrenderableContent||B(t.internal.loadingState);return e&&r}function w(t){return t.internal.hasUnrenderableContent||t.parent&&t.parent.geometricError<t.geometricError}function I(t,e){e.ensureChildrenArePreprocessed(t),t.traversal.lastFrameVisited!==e.frameCount&&(t.traversal.lastFrameVisited=e.frameCount,t.traversal.used=!1,t.traversal.inFrustum=!1,t.traversal.isLeaf=!1,t.traversal.visible=!1,t.traversal.active=!1,t.traversal.error=1/0,t.traversal.distanceFromCamera=1/0,t.traversal.allChildrenReady=!1,t.traversal.kicked=!1,t.traversal.allUsedChildrenProcessed=!1,e.calculateTileViewErrorWithPlugin(t,x),t.traversal.inFrustum=x.inView,t.traversal.error=x.error,t.traversal.distanceFromCamera=x.distanceFromCamera)}function q(t,e,r=!1){if(I(t,e),r?e.markTileUsed(t):D(t),w(t)&&F(t)){const a=t.children;for(let s=0,n=a.length;s<n;s++)q(a[s],e,r)}}function te(t,e){if(I(t,e),t.traversal.usedLastFrame&&(D(t),t.traversal.wasSetActive&&(t.traversal.active=!0),(!t.traversal.active||w(t))&&F(t))){const r=t.children;for(let a=0,s=r.length;a<s;a++)te(r[a],e)}}function D(t){t.traversal.used=!0}function be(t,e){return!(t.traversal.error<=e.errorTarget&&!w(t)||e.maxDepth>0&&t.internal.depth+1>=e.maxDepth||!F(t))}function se(t,e){const{frameCount:r}=e,{children:a}=t;for(let s=0,n=a.length;s<n;s++){const i=a[s];b(i,r)&&(i.traversal.active&&(i.traversal.kicked=!0,i.traversal.active=!1),se(i,e))}}function X(t){return!w(t)&&(!t.internal.hasContent||B(t.internal.loadingState))}function re(t,e){if(I(t,e),!t.traversal.inFrustum)return;if(!be(t,e)){D(t);return}let r=!1,a=!1;const s=t.children;for(let n=0,i=s.length;n<i;n++){const o=s[n];re(o,e),r=r||b(o,e.frameCount),a=a||o.traversal.inFrustum}if(t.refine==="REPLACE"&&!a&&s.length!==0){t.traversal.inFrustum=!1,e.markTileUsed(t);for(let n=0,i=s.length;n<i;n++)q(s[n],e,!0);return}if(D(t),t.refine==="REPLACE"&&r&&e.loadSiblings)for(let n=0,i=s.length;n<i;n++)q(s[n],e)}function ae(t,e){const r=e.frameCount;if(!b(t,r))return;const a=t.children;let s=!1;for(let i=0,o=a.length;i<o;i++){const l=a[i];s=s||b(l,r)}if(!s)t.traversal.isLeaf=!0;else for(let i=0,o=a.length;i<o;i++)ae(a[i],e);let n=!0;for(let i=0,o=a.length;i<o;i++){const l=a[i];b(l,e.frameCount)&&!l.traversal.allUsedChildrenProcessed&&(n=!1)}t.traversal.allUsedChildrenProcessed=n&&F(t)}function ne(t,e){if(!b(t,e.frameCount))return;const r=t.internal.hasContent,a=B(t.internal.loadingState)&&r,s=t.children;if(t.traversal.isLeaf){if(!w(t)&&(t.traversal.active=!0,F(t)&&(!t.internal.hasContent||!B(t.internal.loadingState))))for(let o=0,l=s.length;o<l;o++)te(s[o],e);return}let n=s.length>0;for(let o=0,l=s.length;o<l;o++){const c=s[o];ne(c,e),b(c,e.frameCount)&&!(c.traversal.active&&X(c))&&!c.traversal.allChildrenReady&&(n=!1)}t.traversal.allChildrenReady=n;const i=t.traversal.active&&X(t);!w(t)&&!n&&!i&&t.traversal.wasSetActive&&(a||!t.internal.hasContent)&&(t.traversal.active=!0,se(t,e))}function ie(t,e){var a;const r=b(t,e.frameCount);if(r&&((t.internal.hasUnrenderableContent||t.internal.hasRenderableContent&&t.refine==="ADD")&&(t.traversal.active=!0),(t.traversal.active||t.traversal.kicked)&&t.internal.hasContent?(e.markTileUsed(t),(t.internal.hasUnrenderableContent||t.traversal.allUsedChildrenProcessed)&&e.queueTileForDownload(t),t.internal.loadingState!==y&&(t.traversal.active=!1)):t.traversal.active=!1,t.traversal.visible=t.internal.hasRenderableContent&&t.traversal.active&&t.traversal.inFrustum&&t.internal.loadingState===y,e.stats.used++,t.traversal.inFrustum&&e.stats.inFrustum++),r||ee(t)&&((a=t.traversal)!=null&&a.usedLastFrame)){let s=!1,n=!1;r?(s=t.traversal.active,e.displayActiveTiles?n=t.traversal.active||t.traversal.visible:n=t.traversal.visible):I(t,e),t.internal.hasRenderableContent&&t.internal.loadingState===y&&(t.traversal.wasSetActive!==s&&(e.stats.active+=s?1:-1,e.invokeOnePlugin(o=>o.setTileActive&&o.setTileActive(t,s))),t.traversal.wasSetVisible!==n&&(e.stats.visible+=n?1:-1,e.invokeOnePlugin(o=>o.setTileVisible&&o.setTileVisible(t,n)))),t.traversal.wasSetActive=s,t.traversal.wasSetVisible=n,t.traversal.usedLastFrame=r;const i=t.children;for(let o=0,l=i.length;o<l;o++){const c=i[o];ie(c,e)}}}function Pe(t,e){re(t,e),ae(t,e),ne(t,e),ie(t,e)}const V={inView:!1,error:1/0,distanceFromCamera:1/0},oe=!0;function le(t){return t===y||t===k}function P(t,e){return de(t)&&t.traversal.lastFrameVisited===e&&t.traversal.used}function de(t){return!!t.traversal}function j(t){return t.children.length===0||!!t.children[0].internal}function z(t){return t.internal.hasUnrenderableContent||t.parent&&t.parent.geometricError<t.geometricError}function J(t,e){t.traversal.lastFrameVisited!==e.frameCount&&(t.traversal.lastFrameVisited=e.frameCount,t.traversal.used=!1,t.traversal.inFrustum=!1,t.traversal.isLeaf=!1,t.traversal.visible=!1,t.traversal.active=!1,t.traversal.error=1/0,t.traversal.distanceFromCamera=1/0,t.traversal.allChildrenReady=!1,e.calculateTileViewErrorWithPlugin(t,V),t.traversal.inFrustum=V.inView,t.traversal.error=V.error,t.traversal.distanceFromCamera=V.distanceFromCamera)}function $(t,e,r=!1){if(e.ensureChildrenArePreprocessed(t),J(t,e),Q(t,e,r),z(t)&&j(t)){const a=t.children;for(let s=0,n=a.length;s<n;s++)$(a[s],e,r)}}function ce(t,e){if(e.ensureChildrenArePreprocessed(t),P(t,e.frameCount)&&(t.internal.hasContent&&e.queueTileForDownload(t),j(t))){const r=t.children;for(let a=0,s=r.length;a<s;a++)ce(r[a],e)}}function Q(t,e,r=!1){t.traversal.used||(r||(t.traversal.used=!0,e.stats.used++),e.markTileUsed(t),t.traversal.inFrustum===!0&&e.stats.inFrustum++)}function Ue(t,e){return!(t.traversal.error<=e.errorTarget&&!z(t)||e.maxDepth>0&&t.internal.depth+1>=e.maxDepth||!j(t))}function he(t,e){if(e.ensureChildrenArePreprocessed(t),J(t,e),!t.traversal.inFrustum)return;if(!Ue(t,e)){Q(t,e);return}let r=!1,a=!1;const s=t.children;for(let n=0,i=s.length;n<i;n++){const o=s[n];he(o,e),r=r||P(o,e.frameCount),a=a||o.traversal.inFrustum}if(t.refine==="REPLACE"&&!a&&s.length!==0){t.traversal.inFrustum=!1;for(let n=0,i=s.length;n<i;n++)$(s[n],e,!0);return}if(Q(t,e),t.refine==="REPLACE"&&(r&&t.internal.depth!==0||oe))for(let n=0,i=s.length;n<i;n++)$(s[n],e)}function ue(t,e){const r=e.frameCount;if(!P(t,r))return;const a=t.children;let s=!1;for(let n=0,i=a.length;n<i;n++){const o=a[n];s=s||P(o,r)}if(!s)t.traversal.isLeaf=!0;else{let n=!0;for(let i=0,o=a.length;i<o;i++){const l=a[i];if(ue(l,e),P(l,r)){const c=!z(l);let h=!l.internal.hasContent||l.internal.hasRenderableContent&&le(l.internal.loadingState)||l.internal.hasUnrenderableContent&&l.internal.loadingState===k;h=c&&h||l.traversal.allChildrenReady,n=n&&h}}t.traversal.allChildrenReady=n}}function fe(t,e){const r=e.stats;if(!P(t,e.frameCount))return;if(t.traversal.isLeaf){t.internal.loadingState===y?(t.traversal.inFrustum&&(t.traversal.visible=!0,r.visible++),t.traversal.active=!0,r.active++):t.internal.hasContent&&e.queueTileForDownload(t);return}const a=t.children,s=t.internal.hasContent,n=le(t.internal.loadingState)&&s,i=(e.errorTarget+1)*e.errorThreshold,o=t.traversal.error<=i,l=t.refine==="ADD",c=t.traversal.allChildrenReady||t.internal.depth===0&&!oe;if(s&&(o||l)&&e.queueTileForDownload(t),(o&&n&&!c||n&&l)&&(t.traversal.inFrustum&&(t.traversal.visible=!0,r.visible++),t.traversal.active=!0,r.active++),!l&&o&&!c)for(let h=0,m=a.length;h<m;h++){const v=a[h];P(v,e.frameCount)&&ce(v,e)}else for(let h=0,m=a.length;h<m;h++)fe(a[h],e)}function ve(t,e){const r=P(t,e.frameCount);if(r||de(t)&&t.traversal.usedLastFrame){let a=!1,s=!1;r?(a=t.traversal.active,e.displayActiveTiles?s=t.traversal.active||t.traversal.visible:s=t.traversal.visible):J(t,e),t.internal.hasRenderableContent&&t.internal.loadingState===y&&(t.traversal.wasSetActive!==a&&e.invokeOnePlugin(i=>i.setTileActive&&i.setTileActive(t,a)),t.traversal.wasSetVisible!==s&&e.invokeOnePlugin(i=>i.setTileVisible&&i.setTileVisible(t,s))),t.traversal.wasSetActive=a,t.traversal.wasSetVisible=s,t.traversal.usedLastFrame=r;const n=t.children;for(let i=0,o=n.length;i<o;i++){const l=n[i];ve(l,e)}}}function Re(t,e){he(t,e),ue(t,e),fe(t,e),ve(t,e)}function ke(t){let e=null;return()=>{e===null&&(e=requestAnimationFrame(()=>{e=null,t()}))}}function we(t,e=null,r=null){const a=[];for(a.push(t),a.push(null),a.push(0);a.length>0;){const s=a.pop(),n=a.pop(),i=a.pop();if(e&&e(i,n,s)){r&&r(i,n,s);return}const o=i.children;if(o)for(let l=o.length-1;l>=0;l--)a.push(o[l]),a.push(i),a.push(s+1);r&&r(i,n,s)}}function xe(t,e=null){let r=t;for(;r;){const a=r.internal.depth,s=r.parent;e&&e(r,s,a),r=s}}const Z=Symbol("PLUGIN_REGISTERED"),S={inView:!0,error:0,distance:1/0},N=(t,e)=>{const r=t.priority||0,a=e.priority||0;return r!==a?r>a?1:-1:!t.traversal||!e.traversal?0:t.traversal.used!==e.traversal.used?t.traversal.used?1:-1:t.traversal.error!==e.traversal.error?t.traversal.error>e.traversal.error?1:-1:t.traversal.distanceFromCamera!==e.traversal.distanceFromCamera?t.traversal.distanceFromCamera>e.traversal.distanceFromCamera?-1:1:t.internal.depthFromRenderedParent!==e.internal.depthFromRenderedParent?t.internal.depthFromRenderedParent>e.internal.depthFromRenderedParent?-1:1:0},Fe=(t,e)=>{const r=t.priority||0,a=e.priority||0;return r!==a?r>a?1:-1:!t.traversal||!e.traversal?0:t.traversal.used!==e.traversal.used?t.traversal.used?1:-1:t.traversal.inFrustum!==e.traversal.inFrustum?t.traversal.inFrustum?1:-1:t.internal.hasUnrenderableContent!==e.internal.hasUnrenderableContent?t.internal.hasUnrenderableContent?1:-1:t.traversal.distanceFromCamera!==e.traversal.distanceFromCamera?t.traversal.distanceFromCamera>e.traversal.distanceFromCamera?-1:1:0},Le=(t,e)=>{const r=t.priority||0,a=e.priority||0;return r!==a?r>a?1:-1:!t.traversal||!e.traversal?0:t.traversal.lastFrameVisited!==e.traversal.lastFrameVisited?t.traversal.lastFrameVisited>e.traversal.lastFrameVisited?-1:1:t.internal.depthFromRenderedParent!==e.internal.depthFromRenderedParent?t.internal.depthFromRenderedParent>e.internal.depthFromRenderedParent?1:-1:t.internal.loadingState!==e.internal.loadingState?t.internal.loadingState>e.internal.loadingState?-1:1:t.internal.hasUnrenderableContent!==e.internal.hasUnrenderableContent?t.internal.hasUnrenderableContent?-1:1:t.traversal.error!==e.traversal.error?t.traversal.error>e.traversal.error?-1:1:0};class Ve{get root(){const e=this.rootTileset;return e?e.root:null}get rootTileSet(){return console.warn('TilesRenderer: "rootTileSet" has been deprecated. Use "rootTileset" instead.'),this.rootTileset}get loadProgress(){const{stats:e,isLoading:r}=this,a=e.queued+e.downloading+e.parsing,s=e.inCacheSinceLoad+(r?1:0);return s===0?1:1-a/s}get errorThreshold(){return this._errorThreshold}set errorThreshold(e){console.warn('TilesRenderer: The "errorThreshold" option has been deprecated.'),this._errorThreshold=e}constructor(e=null){this.rootLoadingState=T,this.rootTileset=null,this.rootURL=e,this.fetchOptions={},this.plugins=[],this.queuedTiles=[],this.cachedSinceLoadComplete=new Set,this.isLoading=!1;const r=new Se;r.unloadPriorityCallback=Le;const a=new M;a.maxJobs=25,a.priorityCallback=N;const s=new M;s.maxJobs=5,s.priorityCallback=N;const n=new M;n.maxJobs=25,n.priorityCallback=(i,o)=>{const l=i.parent,c=o.parent;return l===c?0:l?c?a.priorityCallback(l,c):-1:1},this.processedTiles=new WeakSet,this.visibleTiles=new Set,this.activeTiles=new Set,this.usedSet=new Set,this.loadingTiles=new Set,this.lruCache=r,this.downloadQueue=a,this.parseQueue=s,this.processNodeQueue=n,this.stats={inCacheSinceLoad:0,inCache:0,queued:0,downloading:0,parsing:0,loaded:0,failed:0,inFrustum:0,used:0,active:0,visible:0,tilesProcessed:0},this.frameCount=0,this._dispatchNeedsUpdateEvent=ke(()=>{this.dispatchEvent({type:"needs-update"})}),this.errorTarget=16,this._errorThreshold=1/0,this.displayActiveTiles=!1,this.maxDepth=1/0,this.optimizedLoadStrategy=!1,this.loadSiblings=!0,this.maxTilesProcessed=250}registerPlugin(e){if(e[Z]===!0)throw new Error("TilesRendererBase: A plugin can only be registered to a single tileset");e.loadRootTileSet&&!e.loadRootTileset&&(console.warn('TilesRendererBase: Plugin implements deprecated "loadRootTileSet" method. Please rename to "loadRootTileset".'),e.loadRootTileset=e.loadRootTileSet),e.preprocessTileSet&&!e.preprocessTileset&&(console.warn('TilesRendererBase: Plugin implements deprecated "preprocessTileSet" method. Please rename to "preprocessTileset".'),e.preprocessTileset=e.preprocessTileSet);const r=this.plugins,a=e.priority||0;let s=r.length;for(let n=0;n<r.length;n++)if((r[n].priority||0)>a){s=n;break}r.splice(s,0,e),e[Z]=!0,e.init&&e.init(this)}unregisterPlugin(e){const r=this.plugins;if(typeof e=="string"&&(e=this.getPluginByName(e)),r.includes(e)){const a=r.indexOf(e);return r.splice(a,1),e.dispose&&e.dispose(),!0}return!1}getPluginByName(e){return this.plugins.find(r=>r.name===e)||null}invokeOnePlugin(e){const r=[...this.plugins,this];for(let a=0;a<r.length;a++){const s=e(r[a]);if(s)return s}return null}invokeAllPlugins(e){const r=[...this.plugins,this],a=[];for(let s=0;s<r.length;s++){const n=e(r[s]);n&&a.push(n)}return a.length===0?null:Promise.all(a)}traverse(e,r,a=!0){this.root&&we(this.root,(s,...n)=>(a&&this.ensureChildrenArePreprocessed(s,!0),e?e(s,...n):!1),r)}getAttributions(e=[]){return this.invokeAllPlugins(r=>r!==this&&r.getAttributions&&r.getAttributions(e)),e}update(){const{lruCache:e,usedSet:r,stats:a,root:s,downloadQueue:n,parseQueue:i,processNodeQueue:o,optimizedLoadStrategy:l}=this;if(this.rootLoadingState===T&&(this.rootLoadingState=E,this.invokeOnePlugin(u=>u.loadRootTileset&&u.loadRootTileset()).then(u=>{let d=this.rootURL;d!==null&&this.invokeAllPlugins(p=>d=p.preprocessURL?p.preprocessURL(d,null):d),this.rootLoadingState=y,this.rootTileset=u,this.dispatchEvent({type:"needs-update"}),this.dispatchEvent({type:"load-content"}),this.dispatchEvent({type:"load-tileset",tileset:u,url:d}),this.dispatchEvent({type:"load-root-tileset",tileset:u,url:d})}).catch(u=>{this.rootLoadingState=k,console.error(u),this.rootTileset=null,this.dispatchEvent({type:"load-error",tile:null,error:u,url:this.rootURL})})),!s)return;let c=null;if(this.invokeAllPlugins(u=>{if(u.doTilesNeedUpdate){const d=u.doTilesNeedUpdate();c===null?c=d:c=!!(c||d)}}),c===!1){this.dispatchEvent({type:"update-before"}),this.dispatchEvent({type:"update-after"});return}this.dispatchEvent({type:"update-before"}),a.inFrustum=0,a.used=0,a.active=0,a.visible=0,a.tilesProcessed=0,this.frameCount++,r.forEach(u=>e.markUnused(u)),r.clear();const h=l?Fe:N;n.priorityCallback=h,i.priorityCallback=h,this.prepareForTraversal(),l?Pe(s,this):Re(s,this),this.removeUnusedPendingTiles();const m=this.queuedTiles;m.sort(e.unloadPriorityCallback);for(let u=0,d=m.length;u<d&&!e.isFull();u++)this.requestTileContents(m[u]);m.length=0,e.scheduleUnload(),(n.running||i.running||o.running)===!1&&this.isLoading===!0&&(this.cachedSinceLoadComplete.clear(),a.inCacheSinceLoad=0,this.dispatchEvent({type:"tiles-load-end"}),this.isLoading=!1),this.dispatchEvent({type:"update-after"})}resetFailedTiles(){this.rootLoadingState===k&&(this.rootLoadingState=T);const e=this.stats;e.failed!==0&&(this.traverse(r=>{r.internal.loadingState===k&&(r.internal.loadingState=T)},null,!1),e.failed=0)}calculateTileViewErrorWithPlugin(e,r){this.calculateTileViewError(e,r);let a=null,s=0,n=1/0;this.invokeAllPlugins(i=>{i!==this&&i.calculateTileViewError&&(S.inView=!0,S.error=0,S.distance=1/0,i.calculateTileViewError(e,S)&&(a===null&&(a=!0),a=a&&S.inView,S.inView&&(n=Math.min(n,S.distance),s=Math.max(s,S.error))))}),r.inView&&a!==!1?(r.error=Math.max(r.error,s),r.distanceFromCamera=Math.min(r.distanceFromCamera,n)):a?(r.inView=!0,r.error=s,r.distanceFromCamera=n):r.inView=!1}dispose(){[...this.plugins].forEach(s=>{this.unregisterPlugin(s)});const r=this.lruCache,a=[];this.traverse(s=>(a.push(s),!1),null,!1);for(let s=0,n=a.length;s<n;s++)r.remove(a[s]);this.stats={queued:0,parsing:0,downloading:0,failed:0,inFrustum:0,traversed:0,used:0,active:0,visible:0},this.frameCount=0,this.loadingTiles.clear()}calculateBytesUsed(e,r){return 0}dispatchEvent(e){}addEventListener(e,r){}removeEventListener(e,r){}parseTile(e,r,a){return null}prepareForTraversal(){}disposeTile(e){e.traversal.visible&&(this.invokeOnePlugin(a=>a.setTileVisible&&a.setTileVisible(e,!1)),e.traversal.visible=!1),e.traversal.active&&(this.invokeOnePlugin(a=>a.setTileActive&&a.setTileActive(e,!1)),e.traversal.active=!1);const{scene:r}=e.engineData;r&&this.dispatchEvent({type:"dispose-model",scene:r,tile:e})}preprocessNode(e,r,a=null){var s;if(this.processedTiles.add(e),this.stats.tilesProcessed++,e.content&&(!("uri"in e.content)&&"url"in e.content&&(e.content.uri=e.content.url,delete e.content.url),e.content.boundingVolume&&!("box"in e.content.boundingVolume||"sphere"in e.content.boundingVolume||"region"in e.content.boundingVolume)&&delete e.content.boundingVolume),e.parent=a,e.children=e.children||[],e.internal={hasContent:!1,hasRenderableContent:!1,hasUnrenderableContent:!1,loadingState:T,basePath:r,depth:-1,depthFromRenderedParent:-1},(s=e.content)!=null&&s.uri){const n=W(e.content.uri),i=!!(n&&/json$/.test(n));e.internal.hasContent=!0,e.internal.hasUnrenderableContent=i,e.internal.hasRenderableContent=!i}else e.internal.hasContent=!1,e.internal.hasUnrenderableContent=!1,e.internal.hasRenderableContent=!1;a?(e.internal.depth=a.internal.depth+1,e.internal.depthFromRenderedParent=a.internal.depthFromRenderedParent+(e.internal.hasRenderableContent?1:0)):(e.internal.depth=0,e.internal.depthFromRenderedParent=e.internal.hasRenderableContent?1:0),e.traversal={distanceFromCamera:1/0,error:1/0,inFrustum:!1,isLeaf:!1,used:!1,usedLastFrame:!1,visible:!1,wasSetVisible:!1,active:!1,wasSetActive:!1,allChildrenReady:!1,kicked:!1,allUsedChildrenProcessed:!1,lastFrameVisited:-1},a===null?e.refine=e.refine||"REPLACE":e.refine=e.refine||a.refine,e.engineData={scene:null,metadata:null,boundingVolume:null},Object.defineProperty(e,"cached",{get(){return console.warn('TilesRenderer: "tile.cached" field has been renamed to "tile.engineData".'),this.engineData},enumerable:!1,configurable:!0}),this.invokeAllPlugins(n=>{n!==this&&n.preprocessNode&&n.preprocessNode(e,r,a)})}setTileActive(e,r){r?this.activeTiles.add(e):this.activeTiles.delete(e)}setTileVisible(e,r){r?this.visibleTiles.add(e):this.visibleTiles.delete(e),this.dispatchEvent({type:"tile-visibility-change",scene:e.engineData.scene,tile:e,visible:r})}calculateTileViewError(e,r){}removeUnusedPendingTiles(){const{lruCache:e,loadingTiles:r}=this,a=[];for(const s of r)!e.isUsed(s)&&s.internal.loadingState===A&&a.push(s);for(let s=0;s<a.length;s++)e.remove(a[s])}queueTileForDownload(e){e.internal.loadingState!==T||this.lruCache.isFull()||this.queuedTiles.push(e)}markTileUsed(e){this.usedSet.add(e),this.lruCache.markUsed(e)}fetchData(e,r){return fetch(e,r)}ensureChildrenArePreprocessed(e,r=this.stats.tilesProcessed<this.maxTilesProcessed){const a=e.children;if(a.length===0||a[0].internal)return;const s=n=>{for(let i=0,o=n.length;i<o;i++)this.preprocessNode(n[i],e.internal.basePath,e)};r?(this.processNodeQueue.remove(e),s(a)):this.processNodeQueue.has(e)||this.processNodeQueue.add(e,n=>{s(n.children),this._dispatchNeedsUpdateEvent()})}getBytesUsed(e){let r=0;return this.invokeAllPlugins(a=>{a.calculateBytesUsed&&(r+=a.calculateBytesUsed(e,e.engineData.scene)||0)}),r}recalculateBytesUsed(e=null){const{lruCache:r,processedTiles:a}=this;e===null?r.itemSet.forEach(s=>{a.has(s)&&r.setMemoryUsage(s,this.getBytesUsed(s))}):r.setMemoryUsage(e,this.getBytesUsed(e))}preprocessTileset(e,r,a=null){const s=Object.getPrototypeOf(this);Object.hasOwn(s,"preprocessTileSet")&&console.warn(`${s.constructor.name}: Class overrides deprecated "preprocessTileSet" method. Please rename to "preprocessTileset".`);const n=e.asset.version,[i,o]=n.split(".").map(c=>parseInt(c));console.assert(i<=1,"TilesRenderer: asset.version is expected to be a 1.x or a compatible version."),i===1&&o>0&&console.warn("TilesRenderer: tiles versions at 1.1 or higher have limited support. Some new extensions and features may not be supported.");let l=r.replace(/\/[^/]*$/,"");l=new URL(l,window.location.href).toString(),this.preprocessNode(e.root,l,a)}preprocessTileSet(...e){return console.warn('TilesRenderer: "preprocessTileSet" has been deprecated. Use "preprocessTileset" instead.'),this.preprocessTileset(...e)}loadRootTileset(){const e=Object.getPrototypeOf(this);Object.hasOwn(e,"loadRootTileSet")&&console.warn(`${e.constructor.name}: Class overrides deprecated "loadRootTileSet" method. Please rename to "loadRootTileset".`);let r=this.rootURL;return this.invokeAllPlugins(s=>r=s.preprocessURL?s.preprocessURL(r,null):r),this.invokeOnePlugin(s=>s.fetchData&&s.fetchData(r,this.fetchOptions)).then(s=>{if(s instanceof Response){if(s.ok)return s.json();throw new Error(`TilesRenderer: Failed to load tileset "${r}" with status ${s.status} : ${s.statusText}`)}else return s}).then(s=>(this.preprocessTileset(s,r),s))}loadRootTileSet(...e){return console.warn('TilesRenderer: "loadRootTileSet" has been deprecated. Use "loadRootTileset" instead.'),this.loadRootTileSet(...e)}requestTileContents(e){if(e.internal.loadingState!==T)return;let r=!1,a=null,s=new URL(e.content.uri,e.internal.basePath+"/").toString();this.invokeAllPlugins(d=>s=d.preprocessURL?d.preprocessURL(s,e):s);const n=this.stats,i=this.lruCache,o=this.downloadQueue,l=this.parseQueue,c=this.loadingTiles,h=W(s),m=new AbortController,v=m.signal;if(i.add(e,d=>{m.abort(),r?d.children.length=0:this.invokeAllPlugins(p=>{p.disposeTile&&p.disposeTile(d)}),n.inCache--,this.cachedSinceLoadComplete.has(e)&&(this.cachedSinceLoadComplete.delete(e),n.inCacheSinceLoad--),d.internal.loadingState===A?n.queued--:d.internal.loadingState===E?n.downloading--:d.internal.loadingState===O?n.parsing--:d.internal.loadingState===y&&n.loaded--,d.internal.loadingState=T,l.remove(d),o.remove(d),c.delete(d)}))return this.isLoading||(this.isLoading=!0,this.dispatchEvent({type:"tiles-load-start"})),i.setMemoryUsage(e,this.getBytesUsed(e)),this.cachedSinceLoadComplete.add(e),n.inCacheSinceLoad++,n.inCache++,n.queued++,e.internal.loadingState=A,c.add(e),o.add(e,d=>{if(v.aborted)return Promise.resolve();e.internal.loadingState=E,n.downloading++,n.queued--;const p=this.invokeOnePlugin(U=>U.fetchData&&U.fetchData(s,{...this.fetchOptions,signal:v}));return this.dispatchEvent({type:"tile-download-start",tile:e,uri:s}),p}).then(d=>{if(!v.aborted)if(d instanceof Response){if(d.ok)return h==="json"?d.json():d.arrayBuffer();throw new Error(`Failed to load model with error code ${d.status}`)}else return d}).then(d=>{if(!v.aborted)return n.downloading--,n.parsing++,e.internal.loadingState=O,l.add(e,p=>v.aborted?Promise.resolve():h==="json"&&d.root?(this.preprocessTileset(d,s,e),e.children.push(d.root),a=d,r=!0,Promise.resolve()):this.invokeOnePlugin(U=>U.parseTile&&U.parseTile(d,p,h,s,v)))}).then(()=>{if(v.aborted)return;n.parsing--,n.loaded++,e.internal.loadingState=y,c.delete(e),i.setLoaded(e,!0);const d=this.getBytesUsed(e);if(i.getMemoryUsage(e)===0&&d>0&&i.isFull()){i.remove(e);return}i.setMemoryUsage(e,d),this.dispatchEvent({type:"needs-update"}),this.dispatchEvent({type:"load-content"}),r&&this.dispatchEvent({type:"load-tileset",tileset:a,url:s}),e.engineData.scene&&this.dispatchEvent({type:"load-model",scene:e.engineData.scene,tile:e,url:s})}).catch(d=>{v.aborted||(d.name!=="AbortError"?(l.remove(e),o.remove(e),e.internal.loadingState===A?n.queued--:e.internal.loadingState===E?n.downloading--:e.internal.loadingState===O?n.parsing--:e.internal.loadingState===y&&n.loaded--,n.failed++,console.error(`TilesRenderer : Failed to load tile at url "${e.content.uri}".`),console.error(d),e.internal.loadingState=k,c.delete(e),i.setLoaded(e,!0),this.dispatchEvent({type:"load-error",tile:e,error:d,url:s})):i.remove(e))})}}export{Se as L,M as P,Ve as T,K as a,we as b,xe as t};
//# sourceMappingURL=TilesRendererBase-CFsQu8zV.js.map
