import{G as f,d as T,ak as U,h as I,k as V,s as R,al as W,am as F,f as z,C as j}from"./three.module-D-uF--xd.js";import{S as q,a as J}from"./EllipsoidRegionHelper-CAg2B1Y_.js";import{t as K}from"./TilesRendererBase-CFsQu8zV.js";const H=Symbol("ORIGINAL_MATERIAL"),B=Symbol("HAS_RANDOM_COLOR"),y=Symbol("HAS_RANDOM_NODE_COLOR"),E=Symbol("LOAD_TIME"),p=Symbol("PARENT_BOUND_REF_COUNT"),L=new T,_=()=>{},G={};function D(m){if(!G[m]){const e=Math.random(),t=.5+Math.random()*.5,r=.375+Math.random()*.25;G[m]=new j().setHSL(e,t,r)}return G[m]}const u=0,O=1,A=2,S=3,N=4,P=5,w=6,M=7,x=8,k=9,v=10,Q=Object.freeze({NONE:u,SCREEN_ERROR:O,GEOMETRIC_ERROR:A,DISTANCE:S,DEPTH:N,RELATIVE_DEPTH:P,IS_LEAF:w,RANDOM_COLOR:M,RANDOM_NODE_COLOR:x,CUSTOM_COLOR:k,LOAD_ORDER:v});class ${static get ColorModes(){return Q}get unlit(){return this._unlit}set unlit(e){e!==this._unlit&&(this._unlit=e,this.materialsNeedUpdate=!0)}get colorMode(){return this._colorMode}set colorMode(e){e!==this._colorMode&&(this._colorMode=e,this.materialsNeedUpdate=!0)}get enabled(){return this._enabled}set enabled(e){e!==this._enabled&&this.tiles!==null&&(this._enabled=e,e?this.init(this.tiles):this.dispose())}get displayParentBounds(){return this._displayParentBounds}set displayParentBounds(e){this._displayParentBounds!==e&&(this._displayParentBounds=e,e?this.tiles.traverse(t=>{t.traversal.visible&&this._onTileVisibilityChange(t,!0)}):this.tiles.traverse(t=>{t[p]=null,this._onTileVisibilityChange(t,t.traversal.visible)}))}constructor(e){e={displayParentBounds:!1,displayBoxBounds:!1,displaySphereBounds:!1,displayRegionBounds:!1,colorMode:u,maxDebugDepth:-1,maxDebugDistance:-1,maxDebugError:-1,customColorCallback:null,unlit:!1,enabled:!0,...e},this.name="DEBUG_TILES_PLUGIN",this.tiles=null,this._colorMode=null,this._unlit=null,this.materialsNeedUpdate=!1,this.extremeDebugDepth=-1,this.extremeDebugError=-1,this.boxGroup=null,this.sphereGroup=null,this.regionGroup=null,this._enabled=e.enabled,this._displayParentBounds=e.displayParentBounds,this.displayBoxBounds=e.displayBoxBounds,this.displaySphereBounds=e.displaySphereBounds,this.displayRegionBounds=e.displayRegionBounds,this.colorMode=e.colorMode,this.maxDebugDepth=e.maxDebugDepth,this.maxDebugDistance=e.maxDebugDistance,this.maxDebugError=e.maxDebugError,this.customColorCallback=e.customColorCallback,this.unlit=e.unlit,this.getDebugColor=(t,r)=>{r.setRGB(t,t,t)}}init(e){if(this.tiles=e,!this.enabled)return;const t=e.group;this.boxGroup=new f,this.boxGroup.name="DebugTilesRenderer.boxGroup",t.add(this.boxGroup),this.boxGroup.updateMatrixWorld(),this.sphereGroup=new f,this.sphereGroup.name="DebugTilesRenderer.sphereGroup",t.add(this.sphereGroup),this.sphereGroup.updateMatrixWorld(),this.regionGroup=new f,this.regionGroup.name="DebugTilesRenderer.regionGroup",t.add(this.regionGroup),this.regionGroup.updateMatrixWorld(),this._onLoadTilesetCB=()=>{this._initExtremes()},this._onLoadModelCB=({scene:r,tile:s})=>{this._onLoadModel(r,s)},this._onDisposeModelCB=({tile:r})=>{this._onDisposeModel(r)},this._onUpdateAfterCB=()=>{this.update()},this._onTileVisibilityChangeCB=({scene:r,tile:s,visible:o})=>{this._onTileVisibilityChange(s,o)},e.addEventListener("load-tileset",this._onLoadTilesetCB),e.addEventListener("load-model",this._onLoadModelCB),e.addEventListener("dispose-model",this._onDisposeModelCB),e.addEventListener("update-after",this._onUpdateAfterCB),e.addEventListener("tile-visibility-change",this._onTileVisibilityChangeCB),this._initExtremes(),e.traverse(r=>{r.engineData.scene&&this._onLoadModel(r.engineData.scene,r)}),e.visibleTiles.forEach(r=>{this._onTileVisibilityChange(r,!0)})}getTileFromObject3D(e){let t=null;return this.tiles.activeTiles.forEach(s=>{if(t)return!0;const o=s.engineData.scene;o&&o.traverse(d=>{d===e&&(t=s)})}),t}_initExtremes(){if(!(this.tiles&&this.tiles.root))return;let e=-1,t=-1;this.tiles.traverse(null,(r,s,o)=>{e=Math.max(e,o),t=Math.max(t,r.geometricError)},!1),this.extremeDebugDepth=e,this.extremeDebugError=t}update(){const{tiles:e,colorMode:t}=this;if(!e.root)return;this.materialsNeedUpdate&&(e.forEachLoadedModel(a=>{this._updateMaterial(a)}),this.materialsNeedUpdate=!1),this.boxGroup.visible=this.displayBoxBounds,this.sphereGroup.visible=this.displaySphereBounds,this.regionGroup.visible=this.displayRegionBounds;let r=-1;this.maxDebugDepth===-1?r=this.extremeDebugDepth:r=this.maxDebugDepth;let s=-1;this.maxDebugError===-1?s=this.extremeDebugError:s=this.maxDebugError;let o=-1;this.maxDebugDistance===-1?(e.getBoundingSphere(L),o=L.radius):o=this.maxDebugDistance;const{errorTarget:d,visibleTiles:i}=e;let n;t===v&&(n=Array.from(i).sort((a,C)=>a[E]-C[E])),i.forEach(a=>{const C=a.engineData.scene;let c,b,g;t===M&&(c=Math.random(),b=.5+Math.random()*.5,g=.375+Math.random()*.25),C.traverse(l=>{if(t===x&&(c=Math.random(),b=.5+Math.random()*.5,g=.375+Math.random()*.25),l.material)switch(t!==M&&delete l.material[B],t!==x&&delete l.material[y],t){case N:{const h=a.internal.depth/r;this.getDebugColor(h,l.material.color);break}case P:{const h=a.internal.depthFromRenderedParent/r;this.getDebugColor(h,l.material.color);break}case O:{const h=a.traversal.error/d;h>1?l.material.color.setRGB(1,0,0):this.getDebugColor(h,l.material.color);break}case A:{const h=Math.min(a.geometricError/s,1);this.getDebugColor(h,l.material.color);break}case S:{const h=Math.min(a.traversal.distanceFromCamera/o,1);this.getDebugColor(h,l.material.color);break}case w:{!a.children||a.children.length===0?this.getDebugColor(1,l.material.color):this.getDebugColor(0,l.material.color);break}case x:{l.material[y]||(l.material.color.setHSL(c,b,g),l.material[y]=!0);break}case M:{l.material[B]||(l.material.color.setHSL(c,b,g),l.material[B]=!0);break}case k:{this.customColorCallback?this.customColorCallback(a,l):console.warn("DebugTilesRenderer: customColorCallback not defined");break}case v:{const h=n.indexOf(a);this.getDebugColor(h/(n.length-1),l.material.color);break}}})})}_onTileVisibilityChange(e,t){this.displayParentBounds?K(e,r=>{r[p]==null&&(r[p]=0),t?r[p]++:r[p]>0&&r[p]--;const s=r===e&&t||this.displayParentBounds&&r[p]>0;this._updateBoundHelper(r,s)}):this._updateBoundHelper(e,t)}_createBoundHelper(e){const t=this.tiles,r=e.engineData,{sphere:s,obb:o,region:d}=r.boundingVolume;if(o){const i=new f;i.name="DebugTilesRenderer.boxHelperGroup",i.matrix.copy(o.transform),i.matrixAutoUpdate=!1,r.boxHelperGroup=i;const n=new U(o.box,D(e.internal.depth));n.raycast=_,i.add(n);const a=new I(new V,new R({color:D(e.internal.depth),transparent:!0,depthWrite:!1,opacity:.05,side:W}));o.box.getSize(a.scale),a.raycast=_,i.add(a),t.visibleTiles.has(e)&&this.displayBoxBounds&&(this.boxGroup.add(i),i.updateMatrixWorld(!0))}if(s){const i=new q(s,D(e.internal.depth));i.raycast=_,r.sphereHelper=i,t.visibleTiles.has(e)&&this.displaySphereBounds&&(this.sphereGroup.add(i),i.updateMatrixWorld(!0))}if(d){const i=new J(d,D(e.internal.depth));i.raycast=_;const n=new T;d.getBoundingSphere(n),i.position.copy(n.center),n.center.multiplyScalar(-1),i.geometry.translate(...n.center),r.regionHelper=i,t.visibleTiles.has(e)&&this.displayRegionBounds&&(this.regionGroup.add(i),i.updateMatrixWorld(!0))}}_updateHelperMaterials(e,t){t.traverse(r=>{const{material:s}=r;if(!s)return;e.traversal.visible||!this.displayParentBounds?s.opacity=r.isMesh?.05:1:s.opacity=r.isMesh?.01:.2;const o=s.transparent;s.transparent=s.opacity<1,s.transparent!==o&&(s.needsUpdate=!0)})}_updateBoundHelper(e,t){const r=e.engineData;if(!r)return;const s=this.sphereGroup,o=this.boxGroup,d=this.regionGroup;t&&r.boxHelperGroup==null&&r.sphereHelper==null&&r.regionHelper==null&&this._createBoundHelper(e);const i=r.boxHelperGroup,n=r.sphereHelper,a=r.regionHelper;t?(i&&(o.add(i),i.updateMatrixWorld(!0),this._updateHelperMaterials(e,i)),n&&(s.add(n),n.updateMatrixWorld(!0),this._updateHelperMaterials(e,n)),a&&(d.add(a),a.updateMatrixWorld(!0),this._updateHelperMaterials(e,a))):(i&&o.remove(i),n&&s.remove(n),a&&d.remove(a))}_updateMaterial(e){const{colorMode:t,unlit:r}=this;e.traverse(s=>{if(!s.material)return;const o=s.material,d=s[H];if(o!==d&&o.dispose(),t!==u||r){if(s.isPoints){const i=new F;i.size=d.size,i.sizeAttenuation=d.sizeAttenuation,s.material=i}else r?s.material=new R:(s.material=new z,s.material.flatShading=!0);t===u&&(s.material.map=d.map,s.material.color.set(d.color))}else s.material=d})}_onLoadModel(e,t){t[E]=performance.now(),e.traverse(r=>{const s=r.material;s&&(r[H]=s)}),this._updateMaterial(e)}_onDisposeModel(e){const t=e.engineData;t!=null&&t.boxHelperGroup&&(t.boxHelperGroup.children[0].geometry.dispose(),delete t.boxHelperGroup),t!=null&&t.sphereHelper&&(t.sphereHelper.geometry.dispose(),delete t.sphereHelper),t!=null&&t.regionHelper&&(t.regionHelper.geometry.dispose(),delete t.regionHelper)}dispose(){var t,r,s;const e=this.tiles;e.removeEventListener("load-tileset",this._onLoadTilesetCB),e.removeEventListener("load-model",this._onLoadModelCB),e.removeEventListener("dispose-model",this._onDisposeModelCB),e.removeEventListener("update-after",this._onUpdateAfterCB),e.removeEventListener("tile-visibility-change",this._onTileVisibilityChangeCB),this.colorMode=u,this.unlit=!1,e.forEachLoadedModel(o=>{this._updateMaterial(o)}),e.traverse(o=>{this._onDisposeModel(o)},null,!1),(t=this.boxGroup)==null||t.removeFromParent(),(r=this.sphereGroup)==null||r.removeFromParent(),(s=this.regionGroup)==null||s.removeFromParent()}}export{$ as D};
//# sourceMappingURL=DebugTilesPlugin-DPW5Pin-.js.map
