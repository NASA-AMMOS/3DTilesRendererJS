import{d as R,r as l,h as _,u as D,f as G,j as m,k as V,i as I}from"./CameraControls-QAVn3KPw.js";import{S as N,m as z,l as S,ae as Q,O as U,aC as X,R as Y,Q as $,M as Z}from"./three.module-DBfedTbk.js";import{C as H}from"./CanvasDOMOverlay-BFXAGi4N.js";import{C as J}from"./CameraTransitionManager-WDxKQLbX.js";const x=new z,M=new z,T=new z,k=new S,F=new S,W=new Q,O={};function K(a,u,s,r){W.origin.copy(a.position),W.direction.set(0,0,-1).transformDirection(a.matrixWorld),W.applyMatrix4(s.matrixWorldInverse),u.closestPointToRayEstimate(W,T),T.applyMatrix4(s.matrixWorld),M.set(0,0,-1).transformDirection(a.matrixWorld);const c=T.sub(a.position).dot(M);return r.copy(a.position).addScaledVector(M,c),r}function ee(a){const{defaultScene:u,defaultCamera:s,overrideRenderLoop:r=!0,renderPriority:c=1}=a,p=l.useMemo(()=>new U,[]),[h,o,i,g]=R(n=>[n.set,n.size,n.gl,n.scene]);l.useEffect(()=>{h({camera:p})},[h,p]),l.useEffect(()=>{p.left=-o.width/2,p.right=o.width/2,p.top=o.height/2,p.bottom=-o.height/2,p.near=0,p.far=2e3,p.position.z=p.far/2,p.updateProjectionMatrix()},[p,o]),D(()=>{r&&i.render(u,s);const n=i.autoClear;i.autoClear=!1,i.clearDepth(),i.render(g,p),i.autoClear=n},c)}function B(){const a=l.useRef();return l.useEffect(()=>{const s=a.current.attributes.position;for(let r=0,c=s.count;r<c;r++)x.fromBufferAttribute(s,r),x.y>0&&(x.x=0,s.setXYZ(r,...x))}),m.jsx("boxGeometry",{ref:a})}function te({northColor:a=15684432,southColor:u=16777215}){const[s,r]=l.useState(),c=l.useRef();return l.useEffect(()=>{r(c.current)},[]),m.jsxs("group",{scale:.5,ref:c,children:[m.jsx("ambientLight",{intensity:1}),m.jsx("directionalLight",{position:[0,2,3],intensity:3,target:s}),m.jsx("directionalLight",{position:[0,-2,-3],intensity:3,target:s}),m.jsxs("mesh",{children:[m.jsx("sphereGeometry",{}),m.jsx("meshBasicMaterial",{color:0,opacity:.3,transparent:!0,side:X})]}),m.jsxs("group",{scale:[.5,1,.15],children:[m.jsxs("mesh",{"position-y":.5,children:[m.jsx(B,{}),m.jsx("meshStandardMaterial",{color:a})]}),m.jsxs("mesh",{"position-y":-.5,"rotation-x":Math.PI,children:[m.jsx(B,{}),m.jsx("meshStandardMaterial",{color:u})]})]})]})}function ne({children:a,overrideRenderLoop:u,mode:s="3d",margin:r=10,scale:c=35,visible:p=!0,...h}){const[o,i,g]=R(t=>[t.camera,t.scene,t.size]),n=l.useContext(_),f=l.useRef(null),E=l.useMemo(()=>new N,[]);let C,e;return Array.isArray(r)?(C=r[0],e=r[1]):(C=r,e=r),D(()=>{if(n===null||f.current===null)return null;const{ellipsoid:t}=n,d=f.current;if(K(o,t,n.group,T).applyMatrix4(n.group.matrixWorldInverse),t.getPositionToCartographic(T,O),t.getEastNorthUpFrame(O.lat,O.lon,0,F).premultiply(n.group.matrixWorld),F.invert(),k.copy(o.matrixWorld).premultiply(F),s.toLowerCase()==="3d")d.quaternion.setFromRotationMatrix(k).invert();else if(x.set(0,1,0).transformDirection(k).normalize(),x.z=0,x.normalize(),x.length()===0)d.quaternion.identity();else{const y=M.set(0,1,0).angleTo(x);M.cross(x).normalize(),d.quaternion.setFromAxisAngle(M,-y)}}),a||(a=m.jsx(te,{})),p?G(m.jsxs(m.Fragment,{children:[m.jsx("group",{ref:f,scale:c,position:[g.width/2-C-c/2,-g.height/2+e+c/2,0],...h,children:a}),m.jsx(ee,{defaultCamera:o,defaultScene:i,overrideRenderLoop:u,renderPriority:10})]}),E,{events:{priority:10}}):null}const re=l.forwardRef(function(u,s){const{mode:r="perspective",onBeforeToggle:c,perspectiveCamera:p,orthographicCamera:h,...o}=u,[i,g,n,f,E,C]=R(t=>[t.set,t.get,t.invalidate,t.controls,t.camera,t.size]),e=l.useMemo(()=>{const t=new J;return t.autoSync=!1,E.isOrthographicCamera?(t.orthographicCamera.copy(E),t.mode="orthographic"):t.perspectiveCamera.copy(E),t.syncCameras(),t.mode=r,t},[]);l.useEffect(()=>{const{perspectiveCamera:t,orthographicCamera:d}=e,y=C.width/C.height;t.aspect=y,t.updateProjectionMatrix(),d.left=-d.top*y,d.right=-d.left,t.updateProjectionMatrix()},[e,C]),V(e,s),l.useEffect(()=>{const t=({camera:d})=>{i(()=>({camera:d}))};return i(()=>({camera:e.camera})),e.addEventListener("camera-change",t),()=>{e.removeEventListener("camera-change",t)}},[e,i]),l.useEffect(()=>{const t=e.perspectiveCamera,d=e.orthographicCamera;return e.perspectiveCamera=p||t,e.orthographicCamera=h||d,i(()=>({camera:e.camera})),()=>{e.perspectiveCamera=t,e.orthographicCamera=d}},[p,h,e,i]),l.useEffect(()=>{if(r!==e.mode){const t=r==="orthographic"?e.orthographicCamera:e.perspectiveCamera;c?c(e,t):f&&f.isEnvironmentControls?(f.getPivotPoint(e.fixedPoint),e.syncCameras(),f.adjustCamera(e.perspectiveCamera),f.adjustCamera(e.orthographicCamera)):(e.fixedPoint.set(0,0,-1).transformDirection(e.camera.matrixWorld).multiplyScalar(50).add(e.camera.position),e.syncCameras()),e.toggle(),n()}},[r,e,n,f,c]),l.useEffect(()=>{const t=()=>n();return e.addEventListener("transition-start",t),e.addEventListener("change",t),e.addEventListener("transition-end",t),()=>{e.removeEventListener("transition-start",t),e.removeEventListener("change",t),e.removeEventListener("transition-end",t)}},[e,n]),I(e,o),D(()=>{e.update(),f&&(f.enabled=!e.animating);const{camera:t,size:d}=g();if(!h&&t===e.orthographicCamera){const y=d.width/d.height,j=e.orthographicCamera;y!==j.right&&(j.bottom=-1,j.top=1,j.left=-y,j.right=y,j.updateProjectionMatrix())}e.animating&&n()},-1)});function ce(a){const u=l.useContext(_),s=l.useRef();return D(()=>{const r=s.current;r&&u&&(r.style.width=`${u.loadProgress*100}%`,r.style.opacity=u.loadProgress===1?0:1,r.style.transition=u.loadProgress===1?"opacity 0.5s linear":"")}),m.jsx(H,{ref:s,style:{position:"absolute",left:0,bottom:0,height:"2px",background:"white",opacity:0,width:"100%"}})}const b=new S;function q(a,u,s){return s.makeTranslation(-a.x,-a.y,-a.z),b.makeRotationFromQuaternion(u),s.premultiply(b),b.makeTranslation(a.x,a.y,a.z),s.premultiply(b),s}const P=new Y,v=new z,L=new z,A=new $,w=new S,le=l.forwardRef(function(u,s){const r=l.useContext(_),c=R(({controls:o})=>o),p=R(({scene:o})=>o),h=l.useCallback((o,i)=>{if(!o.animating){i.updateMatrixWorld(),P.ray.direction.set(0,0,-1).transformDirection(o.camera.matrixWorld),P.ray.origin.setFromMatrixPosition(o.camera.matrixWorld);const g=P.intersectObject(p)[0];if(g?(o.fixedPoint.copy(g.point),o.syncCameras()):(c.getPivotPoint(o.fixedPoint),o.syncCameras()),r?(w.copy(r.group.matrixWorld).invert(),v.copy(o.fixedPoint).applyMatrix4(w),r.ellipsoid.getPositionToNormal(v,v).multiplyScalar(-1).transformDirection(r.group.matrixWorld)):v.set(0,-1,0),i.isOrthographicCamera){const n=v.angleTo(P.ray.direction);L.crossVectors(v,P.ray.direction),A.setFromAxisAngle(L,-n).normalize(),q(o.fixedPoint,A,w),i.matrixWorld.premultiply(w),i.matrixWorld.decompose(i.position,i.quaternion,i.scale)}else if(!c.isGlobeControls||c._isNearControls()){let n=v.angleTo(P.ray.direction);n=Math.max(65*Z.DEG2RAD-n,0),L.set(1,0,0).transformDirection(i.matrixWorld),A.setFromAxisAngle(L,n).normalize(),q(o.fixedPoint,A,w),i.matrixWorld.premultiply(w),i.matrixWorld.decompose(i.position,i.quaternion,i.scale)}}c.adjustCamera(o.perspectiveCamera),c.adjustCamera(o.orthographicCamera)},[r,c,p]);return m.jsx(re,{...u,ref:s,onBeforeToggle:h})});export{le as C,ce as T,ne as a};
//# sourceMappingURL=CameraViewTransition-CNe7mUlH.js.map
