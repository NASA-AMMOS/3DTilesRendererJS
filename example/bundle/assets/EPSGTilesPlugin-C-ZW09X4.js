import{I as tt,T as N,a as O,b as H}from"./ImageFormatPlugin-Cwk6ueKg.js";import{m as V,aP as et,d as it,V as st,M as d}from"./three.module-DBfedTbk.js";import{P as F,X as nt,T as ot}from"./TMSImageSource-CIsRgZv6.js";import{T as Z}from"./TiledImageSource-DLt2EM25.js";const D=new V,A=new V;function rt(p,t,e){const i=e+1e-5;let o=t+1e-5;Math.abs(o)>Math.PI/2&&(o=o-1e-5),p.getCartographicToPosition(t,e,0,D),p.getCartographicToPosition(o,e,0,A);const n=D.distanceTo(A)/1e-5;return p.getCartographicToPosition(t,i,0,A),[D.distanceTo(A)/1e-5,n]}const at=30,lt=15,U=new V,z=new V,x=new st,W=new it;class b extends tt{get projection(){return this.tiling.projection}constructor(t={}){const{shape:e="planar",endCaps:s=!0,...i}=t;super(i),this.shape=e,this.endCaps=s}async parseToMesh(t,e,...s){const i=await super.parseToMesh(t,e,...s),{shape:o,projection:n,tiles:r,tiling:l}=this;if(o==="ellipsoid"){const a=r.ellipsoid,c=e[N],g=e[O],E=e[H],[m,M,u,h]=e.boundingVolume.region,T=Math.ceil((h-M)*d.RAD2DEG*.25),f=Math.ceil((u-m)*d.RAD2DEG*.25),S=Math.max(lt,T),B=Math.max(at,f),I=new et(1,1,B,S),[_,C,j,v]=l.getTileBounds(g,E,c,!0,!0),y=l.getTileContentUVBounds(g,E,c),{position:w,normal:$,uv:Y}=I.attributes,k=w.count;e.cached.boundingVolume.getSphere(W);for(let L=0;L<k;L++){U.fromBufferAttribute(w,L),x.fromBufferAttribute(Y,L);const X=n.convertProjectionToLongitude(d.mapLinear(x.x,0,1,_,j));let P=n.convertProjectionToLatitude(d.mapLinear(x.y,0,1,C,v));if(n.isMercator&&this.endCaps&&(v===1&&x.y===1&&(P=Math.PI/2),C===0&&x.y===0&&(P=-Math.PI/2)),n.isMercator&&x.y!==0&&x.y!==1){const R=n.convertProjectionToLatitude(1),G=1/S,J=d.mapLinear(x.y-G,0,1,M,h),K=d.mapLinear(x.y+G,0,1,M,h);P>R&&J<R&&(P=R),P<-R&&K>-R&&(P=-R)}a.getCartographicToPosition(P,X,0,U).sub(W.center),a.getCartographicToNormal(P,X,z);const Q=d.mapLinear(n.convertLongitudeToProjection(X),_,j,y[0],y[2]),q=d.mapLinear(n.convertLatitudeToProjection(P),C,v,y[1],y[3]);Y.setXY(L,Q,q),w.setXYZ(L,...U),$.setXYZ(L,...z)}i.geometry=I,i.position.copy(W.center)}return i}createBoundingVolume(t,e,s){if(this.shape==="ellipsoid"){const{tiling:i,endCaps:o}=this,n=s===-1,r=n?i.getContentBounds(!0):i.getTileBounds(t,e,s,!0,!0),l=n?i.getContentBounds():i.getTileBounds(t,e,s,!1,!0);return o&&(r[3]===1&&(l[3]=Math.PI/2),r[1]===0&&(l[1]=-Math.PI/2)),{region:[...l,-1,1]}}else return super.createBoundingVolume(t,e,s)}createChild(...t){const e=super.createChild(...t),{shape:s,projection:i,tiling:o}=this;if(e&&s==="ellipsoid"){const n=e[N],r=e[O],l=e[H];if(n===-1)return e.geometricError=1e50,parent;const[a,c,g,E]=o.getTileBounds(r,l,n,!0),{tilePixelWidth:m,tilePixelHeight:M}=o.getLevel(n),u=(g-a)/m,h=(E-c)/M,[,T,f,S]=o.getTileBounds(r,l,n),B=T>0!=S>0?0:Math.min(Math.abs(T),Math.abs(S)),I=i.convertLatitudeToProjection(B),_=i.getLongitudeDerivativeAtProjection(a),C=i.getLatitudeDerivativeAtProjection(I),[j,v]=rt(this.tiles.ellipsoid,B,f),y=Math.max(u*_*j,h*C*v);e.geometricError=y}return e}}class ct extends Z{constructor(t={}){super();const{capabilities:e=null,layer:s=null,tileMatrixSet:i=null,style:o=null,url:n=null,dimensions:r={}}=t;this.capabilities=e,this.layer=s,this.tileMatrixSet=i,this.style=o,this.dimensions=r,this.url=n}getUrl(t,e,s){return this.url.replace(/{\s*TileMatrix\s*}/gi,s).replace(/{\s*TileCol\s*}/gi,t).replace(/{\s*TileRow\s*}/gi,e)}init(){const{tiling:t,dimensions:e,capabilities:s}=this;let{layer:i,tileMatrixSet:o,style:n,url:r}=this;i?typeof i=="string"&&(i=s.layers.find(a=>a.identifier===i)):i=s.layers[0],o?typeof o=="string"&&(o=i.tileMatrixSets.find(a=>a.identifier===o)):o=i.tileMatrixSets[0],n||(n=i.styles.find(a=>a.isDefault).identifier),r||(r=i.resourceUrls[0].template);const l=o.supportedCRS.includes("4326")?"EPSG:4326":"EPSG:3857";t.flipY=!0,t.setProjection(new F(l)),i.boundingBox!==null?t.setContentBounds(...i.boundingBox.bounds):t.setContentBounds(...t.projection.getBounds()),o.tileMatrices.forEach((a,c)=>{const{tileWidth:g,tileHeight:E,matrixWidth:m,matrixHeight:M}=a;t.setLevel(c,{tilePixelWidth:g,tilePixelHeight:E,tileCountX:m||t.projection.tileCountX*2**c,tileCountY:M||t.projection.tileCountY*2**c,tileBounds:a.bounds})}),r=r.replace(/{\s*TileMatrixSet\s*}/g,o.identifier).replace(/{\s*Style\s*}/g,n);for(const a in e)r=r.replace(new RegExp(`{\\s*${a}\\s*}`),e[a]);return i.dimensions.forEach(a=>{r=r.replace(new RegExp(`{\\s*${a.identifier}\\s*}`),a.defaultValue)}),this.url=r,Promise.resolve()}}class ut extends Z{constructor(t={}){const{url:e=null,layer:s=null,styles:i=null,contentBoundingBox:o=null,version:n="1.3.0",crs:r="EPSG:4326",format:l="image/png",transparent:a=!1,levels:c=18,tileDimension:g=256}=t;super(),this.url=e,this.layer=s,this.crs=r,this.format=l,this.tileDimension=g,this.styles=i,this.version=n,this.levels=c,this.transparent=a,this.contentBoundingBox=o}init(){const{tiling:t,levels:e,tileDimension:s,contentBoundingBox:i}=this;return t.setProjection(new F(this.crs)),t.flipY=!0,t.generateLevels(e,t.projection.tileCountX,t.projection.tileCountY,{tilePixelWidth:s,tilePixelHeight:s}),i!==null?t.setContentBounds(...i):t.setContentBounds(...t.projection.getBounds()),Promise.resolve()}normalizedToMercatorX(t){return d.mapLinear(t,0,1,-20037508342789244e-9,20037508342789244e-9)}normalizedToMercatorY(t){return d.mapLinear(t,0,1,-20037508342789244e-9,20037508342789244e-9)}getUrl(t,e,s){const{tiling:i,layer:o,crs:n,format:r,tileDimension:l,styles:a,version:c,transparent:g}=this,E=c==="1.1.1"?"SRS":"CRS";let m;if(n==="EPSG:3857"){const u=i.getTileBounds(t,e,s,!0,!1),h=this.normalizedToMercatorX(u[0]),T=this.normalizedToMercatorY(u[1]),f=this.normalizedToMercatorX(u[2]),S=this.normalizedToMercatorY(u[3]);m=[h,T,f,S]}else{const[u,h,T,f]=i.getTileBounds(t,e,s,!1,!1).map(S=>S*d.RAD2DEG);n==="EPSG:4326"?c==="1.1.1"?m=[u,h,T,f]:m=[h,u,f,T]:m=[u,h,T,f]}const M=new URLSearchParams({SERVICE:"WMS",REQUEST:"GetMap",VERSION:c,LAYERS:o,STYLES:a,[E]:n,BBOX:m.join(","),WIDTH:l,HEIGHT:l,FORMAT:r,TRANSPARENT:g?"TRUE":"FALSE"});return new URL("?"+M.toString(),this.url).toString()}}class gt extends b{constructor(t={}){const{levels:e,tileDimension:s,bounds:i,url:o,...n}=t;super(n),this.name="XYZ_TILES_PLUGIN",this.imageSource=new nt({url:o,levels:e,tileDimension:s,bounds:i})}}class Tt extends b{constructor(t={}){const{url:e,...s}=t;super(s),this.name="TMS_TILES_PLUGIN",this.imageSource=new ot({url:e})}}class Mt extends b{constructor(t={}){const{capabilities:e,layer:s,tileMatrixSet:i,style:o,dimensions:n,...r}=t;super(r),this.name="WTMS_TILES_PLUGIN",this.imageSource=new ct({capabilities:e,layer:s,tileMatrixSet:i,style:o,dimensions:n})}}class ft extends b{constructor(t={}){const{url:e,layer:s,crs:i,format:o,tileDimension:n,styles:r,version:l,...a}=t;super(a),this.name="WMS_TILES_PLUGIN",this.imageSource=new ut({url:e,layer:s,crs:i,format:o,tileDimension:n,styles:r,version:l})}}export{Tt as T,ft as W,gt as X,Mt as a};
//# sourceMappingURL=EPSGTilesPlugin-C-ZW09X4.js.map
