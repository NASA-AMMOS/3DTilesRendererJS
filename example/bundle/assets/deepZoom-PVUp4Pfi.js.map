{"version":3,"file":"deepZoom-PVUp4Pfi.js","sources":["../../../src/three/plugins/images/sources/DeepZoomImageSource.js","../../../src/three/plugins/images/DeepZoomImagePlugin.js","../../three/deepZoom.js"],"sourcesContent":["import { TiledImageSource } from './TiledImageSource.js';\n\nexport class DeepZoomImageSource extends TiledImageSource {\n\n\tconstructor( options = {} ) {\n\n\t\tconst { url = null, ...rest } = options;\n\t\tsuper( rest );\n\n\t\tthis.url = url;\n\t\tthis.format = null;\n\t\tthis.stem = null;\n\n\t}\n\n\tgetUrl( x, y, level ) {\n\n\t\treturn `${ this.stem }_files/${ level }/${ x }_${ y }.${ this.format }`;\n\n\t}\n\n\tinit() {\n\n\t\tconst { url } = this;\n\n\t\t// If implementing DeepZoom with limitations like a fixed orthographic camera perspective then\n\t\t// the target tile level can be immediately 'jumped' to for the entire image and in-view tiles\n\t\t// can be immediately queried without any hierarchy traversal. Due the flexibility of camera\n\t\t// type, rotation, and per-tile error calculation we generate a hierarchy.\n\t\treturn this\n\t\t\t.fetchData( url, this.fetchOptions )\n\t\t\t.then( res => res.text() )\n\t\t\t.then( text => {\n\n\t\t\t\tconst xml = new DOMParser().parseFromString( text, 'text/xml' );\n\t\t\t\tif ( xml.querySelector( 'DisplayRects' ) || xml.querySelector( 'Collection' ) ) {\n\n\t\t\t\t\tthrow new Error( 'DeepZoomImagesPlugin: DisplayRect and Collection DZI files not supported.' );\n\n\t\t\t\t}\n\n\t\t\t\t// Elements\n\t\t\t\tconst image = xml.querySelector( 'Image' );\n\t\t\t\tconst size = image.querySelector( 'Size' );\n\n\t\t\t\t// Image properties\n\t\t\t\tconst width = parseInt( size.getAttribute( 'Width' ) );\n\t\t\t\tconst height = parseInt( size.getAttribute( 'Height' ) );\n\t\t\t\tconst tileSize = parseInt( image.getAttribute( 'TileSize' ) );\n\t\t\t\tconst overlap = parseInt( image.getAttribute( 'Overlap' ) );\n\t\t\t\tconst format = image.getAttribute( 'Format' );\n\n\t\t\t\t// Assign deep zoom properties\n\t\t\t\tthis.format = format;\n\t\t\t\tthis.stem = url.split( /\\.[^.]+$/g )[ 0 ];\n\n\t\t\t\t// Assign tiling properties\n\t\t\t\tconst { tiling } = this;\n\t\t\t\tconst levels = Math.ceil( Math.log2( Math.max( width, height ) ) ) + 1;\n\t\t\t\ttiling.flipY = true;\n\t\t\t\ttiling.pixelOverlap = overlap;\n\t\t\t\ttiling.generateLevels( levels, 1, 1, {\n\t\t\t\t\ttilePixelWidth: tileSize,\n\t\t\t\t\ttilePixelHeight: tileSize,\n\t\t\t\t\tpixelWidth: width,\n\t\t\t\t\tpixelHeight: height,\n\t\t\t\t} );\n\n\t\t\t} );\n\n\t}\n\n}\n","import { ImageFormatPlugin } from './ImageFormatPlugin.js';\nimport { DeepZoomImageSource } from './sources/DeepZoomImageSource.js';\n\n// Support for Deep Zoom Image format\n// https://openseadragon.github.io/\n\n// https://learn.microsoft.com/en-us/previous-versions/windows/silverlight/dotnet-windows-silverlight/cc645077(v=vs.95)\nexport class DeepZoomImagePlugin extends ImageFormatPlugin {\n\n\tconstructor( options = {} ) {\n\n\t\tconst { url, ...rest } = options;\n\t\tsuper( rest );\n\n\t\tthis.name = 'DZI_TILES_PLUGIN';\n\t\tthis.imageSource = new DeepZoomImageSource( { url } );\n\n\t}\n\n}\n","import {\n\tScene,\n\tWebGLRenderer,\n\tPerspectiveCamera,\n\tOrthographicCamera,\n} from 'three';\nimport { EnvironmentControls, TilesRenderer, CameraTransitionManager } from '3d-tiles-renderer';\nimport { DeepZoomImagePlugin, UpdateOnChangePlugin } from '3d-tiles-renderer/plugins';\nimport { GUI } from 'three/examples/jsm/libs/lil-gui.module.min.js';\n\nlet controls, scene, renderer;\nlet tiles, transition;\n\nconst params = {\n\n\terrorTarget: 1,\n\trenderScale: 1,\n\n\torthographic: false,\n\n};\n\ninit();\nrender();\n\nfunction init() {\n\n\t// renderer\n\trenderer = new WebGLRenderer( { antialias: true } );\n\trenderer.setPixelRatio( window.devicePixelRatio );\n\trenderer.setSize( window.innerWidth, window.innerHeight );\n\trenderer.setClearColor( 0x111111 );\n\n\tdocument.body.appendChild( renderer.domElement );\n\n\t// scene\n\tscene = new Scene();\n\n\t// set up cameras and ortho / perspective transition\n\ttransition = new CameraTransitionManager(\n\t\tnew PerspectiveCamera( 60, window.innerWidth / window.innerHeight, 0.001, 10000 ),\n\t\tnew OrthographicCamera( - 1, 1, 1, - 1, 0, 4000 ),\n\t);\n\ttransition.camera.position.set( 0, 0, 1.5 );\n\ttransition.camera.lookAt( 0, 0, 0 );\n\ttransition.autoSync = false;\n\ttransition.addEventListener( 'camera-change', ( { camera, prevCamera } ) => {\n\n\t\ttiles.deleteCamera( prevCamera );\n\t\ttiles.setCamera( camera );\n\t\tcontrols.setCamera( camera );\n\n\t} );\n\n\t// tiles\n\ttiles = new TilesRenderer( 'https://openseadragon.github.io/example-images/duomo/duomo.dzi' );\n\ttiles.registerPlugin( new DeepZoomImagePlugin( { center: true } ) );\n\ttiles.registerPlugin( new UpdateOnChangePlugin() );\n\ttiles.fetchOptions.mode = 'cors';\n\ttiles.lruCache.minSize = 900;\n\ttiles.lruCache.maxSize = 1300;\n\ttiles.errorTarget = 1;\n\ttiles.setCamera( transition.camera );\n\tscene.add( tiles.group );\n\n\t// controls\n\tcontrols = new EnvironmentControls( scene, transition.camera, renderer.domElement );\n\tcontrols.minZoomDistance = 2;\n\tcontrols.minDistance = 0.01;\n\tcontrols.maxDistance = 1000;\n\tcontrols.cameraRadius = 0;\n\tcontrols.enableDamping = true;\n\tcontrols.fallbackPlane.normal.set( 0, 0, 1 );\n\tcontrols.up.set( 0, 0, 1 );\n\n\t// events\n\tonWindowResize();\n\twindow.addEventListener( 'resize', onWindowResize, false );\n\n\t// gui initialization\n\tconst gui = new GUI();\n\tgui.add( params, 'orthographic' ).onChange( v => {\n\n\t\ttransition.fixedPoint.copy( controls.pivotPoint );\n\n\t\t// adjust the camera before the transition begins\n\t\ttransition.syncCameras();\n\t\tcontrols.adjustCamera( transition.perspectiveCamera );\n\t\tcontrols.adjustCamera( transition.orthographicCamera );\n\t\ttransition.toggle();\n\n\t} );\n\n\tgui.add( params, 'errorTarget', 0, 100 ).onChange( () => {\n\n\t\ttiles.getPluginByName( 'UPDATE_ON_CHANGE_PLUGIN' ).needsUpdate = true;\n\n\t} );\n\tgui.add( params, 'renderScale', 0.1, 1.0, 0.05 ).onChange( v => renderer.setPixelRatio( v * window.devicePixelRatio ) );\n\n\tgui.open();\n\n}\n\nfunction onWindowResize() {\n\n\tconst { perspectiveCamera, orthographicCamera } = transition;\n\tconst aspect = window.innerWidth / window.innerHeight;\n\n\torthographicCamera.bottom = - 40;\n\torthographicCamera.top = 40;\n\torthographicCamera.left = - 40 * aspect;\n\torthographicCamera.right = 40 * aspect;\n\torthographicCamera.updateProjectionMatrix();\n\n\tperspectiveCamera.aspect = aspect;\n\tperspectiveCamera.updateProjectionMatrix();\n\n\trenderer.setSize( window.innerWidth, window.innerHeight );\n\n}\n\nfunction render() {\n\n\trequestAnimationFrame( render );\n\n\tcontrols.enabled = ! transition.animating;\n\tcontrols.update();\n\ttransition.update();\n\n\tconst camera = transition.camera;\n\tcamera.updateMatrixWorld();\n\n\ttiles.errorTarget = params.errorTarget;\n\ttiles.setCamera( camera );\n\ttiles.setResolutionFromRenderer( camera, renderer );\n\ttiles.update();\n\n\trenderer.render( scene, camera );\n\n}\n"],"names":["DeepZoomImageSource","TiledImageSource","options","url","rest","x","y","level","res","text","xml","image","size","width","height","tileSize","overlap","format","tiling","levels","DeepZoomImagePlugin","ImageFormatPlugin","controls","scene","renderer","tiles","transition","params","init","render","WebGLRenderer","Scene","CameraTransitionManager","PerspectiveCamera","OrthographicCamera","camera","prevCamera","TilesRenderer","UpdateOnChangePlugin","EnvironmentControls","onWindowResize","gui","GUI","v","perspectiveCamera","orthographicCamera","aspect"],"mappings":"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"}