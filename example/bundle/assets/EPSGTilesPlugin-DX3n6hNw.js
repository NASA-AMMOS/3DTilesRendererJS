import{I as tt,T as z,a as G,b as O}from"./ImageFormatPlugin-DGN9sc3I.js";import{o as N,a_ as et,d as it,V as st,M as g}from"./three.module-D-uF--xd.js";import{X as nt,T as ot}from"./TMSImageSource-BIqdNmly.js";import{T as F,P as Z}from"./TiledImageSource-DmD64Gn9.js";const X=new N,V=new N;function rt(m,t,e){const i=e+1e-5;let o=t+1e-5;Math.abs(o)>Math.PI/2&&(o=o-1e-5),m.getCartographicToPosition(t,e,0,X),m.getCartographicToPosition(o,e,0,V);const n=X.distanceTo(V)/1e-5;return m.getCartographicToPosition(t,i,0,V),[X.distanceTo(V)/1e-5,n]}const at=30,lt=15,j=new N,H=new N,P=new st,U=new it;class b extends tt{get projection(){return this.tiling.projection}constructor(t={}){const{shape:e="planar",endCaps:s=!0,...i}=t;super(i),this.shape=e,this.endCaps=s}async parseToMesh(t,e,...s){const i=await super.parseToMesh(t,e,...s),{shape:o,projection:n,tiles:r,tiling:l}=this;if(o==="ellipsoid"){const c=r.ellipsoid,a=e[z],d=e[G],T=e[O],[h,f,u,p]=e.boundingVolume.region,M=Math.ceil((p-f)*g.RAD2DEG*.25),S=Math.ceil((u-h)*g.RAD2DEG*.25),x=Math.max(lt,M),B=Math.max(at,S),I=new et(1,1,B,x),[_,C,A,v]=l.getTileBounds(d,T,a,!0,!0),y=l.getTileContentUVBounds(d,T,a),{position:w,normal:$,uv:W}=I.attributes,k=w.count;e.engineData.boundingVolume.getSphere(U);for(let L=0;L<k;L++){j.fromBufferAttribute(w,L),P.fromBufferAttribute(W,L);const D=n.convertNormalizedToLongitude(g.mapLinear(P.x,0,1,_,A));let E=n.convertNormalizedToLatitude(g.mapLinear(P.y,0,1,C,v));if(n.isMercator&&this.endCaps&&(v===1&&P.y===1&&(E=Math.PI/2),C===0&&P.y===0&&(E=-Math.PI/2)),n.isMercator&&P.y!==0&&P.y!==1){const R=n.convertNormalizedToLatitude(1),Y=1/x,J=g.mapLinear(P.y-Y,0,1,f,p),K=g.mapLinear(P.y+Y,0,1,f,p);E>R&&J<R&&(E=R),E<-R&&K>-R&&(E=-R)}c.getCartographicToPosition(E,D,0,j).sub(U.center),c.getCartographicToNormal(E,D,H);const Q=g.mapLinear(n.convertLongitudeToNormalized(D),_,A,y[0],y[2]),q=g.mapLinear(n.convertLatitudeToNormalized(E),C,v,y[1],y[3]);W.setXY(L,Q,q),w.setXYZ(L,...j),$.setXYZ(L,...H)}i.geometry=I,i.position.copy(U.center)}return i}createBoundingVolume(t,e,s){if(this.shape==="ellipsoid"){const{tiling:i,endCaps:o}=this,n=s===-1,r=n?i.getContentBounds(!0):i.getTileBounds(t,e,s,!0,!0),l=n?i.getContentBounds():i.getTileBounds(t,e,s,!1,!0);return o&&(r[3]===1&&(l[3]=Math.PI/2),r[1]===0&&(l[1]=-Math.PI/2)),{region:[...l,-1,1]}}else return super.createBoundingVolume(t,e,s)}createChild(...t){const e=super.createChild(...t),{shape:s,projection:i,tiling:o}=this;if(e&&s==="ellipsoid"){const n=e[z],r=e[G],l=e[O];if(n===-1)return e.geometricError=1e50,parent;const[c,a,d,T]=o.getTileBounds(r,l,n,!0),{tilePixelWidth:h,tilePixelHeight:f}=o.getLevel(n),u=(d-c)/h,p=(T-a)/f,[,M,S,x]=o.getTileBounds(r,l,n),B=M>0!=x>0?0:Math.min(Math.abs(M),Math.abs(x)),I=i.convertLatitudeToNormalized(B),_=i.getLongitudeDerivativeAtNormalized(c),C=i.getLatitudeDerivativeAtNormalized(I),[A,v]=rt(this.tiles.ellipsoid,B,S),y=Math.max(u*_*A,p*C*v);e.geometricError=y}return e}}function ct(m){return/(:84|:crs84)$/i.test(m)}class ut extends F{constructor(t={}){const{capabilities:e=null,layer:s=null,tileMatrixSet:i=null,style:o=null,url:n=null,dimensions:r={},...l}=t;super(l),this.capabilities=e,this.layer=s,this.tileMatrixSet=i,this.style=o,this.dimensions=r,this.url=n}getUrl(t,e,s){return this.url.replace(/{\s*TileMatrix\s*}/gi,s).replace(/{\s*TileCol\s*}/gi,t).replace(/{\s*TileRow\s*}/gi,e)}init(){const{tiling:t,dimensions:e,capabilities:s}=this;let{layer:i,tileMatrixSet:o,style:n,url:r}=this;i?typeof i=="string"&&(i=s.layers.find(a=>a.identifier===i)):i=s.layers[0],o?typeof o=="string"&&(o=i.tileMatrixSets.find(a=>a.identifier===o)):o=i.tileMatrixSets[0],n||(n=i.styles.find(a=>a.isDefault).identifier),r||(r=i.resourceUrls[0].template);const l=o.supportedCRS,c=l.includes("4326")||ct(l)?"EPSG:4326":"EPSG:3857";t.flipY=!0,t.setProjection(new Z(c)),i.boundingBox!==null?t.setContentBounds(...i.boundingBox.bounds):t.setContentBounds(...t.projection.getBounds()),o.tileMatrices.forEach((a,d)=>{const{tileWidth:T,tileHeight:h,matrixWidth:f,matrixHeight:u}=a;t.setLevel(d,{tilePixelWidth:T,tilePixelHeight:h,tileCountX:f||t.projection.tileCountX*2**d,tileCountY:u||t.projection.tileCountY*2**d,tileBounds:a.bounds})}),r=r.replace(/{\s*TileMatrixSet\s*}/g,o.identifier).replace(/{\s*Style\s*}/g,n);for(const a in e)r=r.replace(new RegExp(`{\\s*${a}\\s*}`),e[a]);return i.dimensions.forEach(a=>{r=r.replace(new RegExp(`{\\s*${a.identifier}\\s*}`),a.defaultValue)}),this.url=r,Promise.resolve()}}class mt extends F{constructor(t={}){const{url:e=null,layer:s=null,styles:i=null,contentBoundingBox:o=null,version:n="1.3.0",crs:r="EPSG:4326",format:l="image/png",transparent:c=!1,levels:a=18,tileDimension:d=256,...T}=t;super(T),this.url=e,this.layer=s,this.crs=r,this.format=l,this.tileDimension=d,this.styles=i,this.version=n,this.levels=a,this.transparent=c,this.contentBoundingBox=o}init(){const{tiling:t,levels:e,tileDimension:s,contentBoundingBox:i}=this;return t.setProjection(new Z(this.crs)),t.flipY=!0,t.generateLevels(e,t.projection.tileCountX,t.projection.tileCountY,{tilePixelWidth:s,tilePixelHeight:s}),i!==null?t.setContentBounds(...i):t.setContentBounds(...t.projection.getBounds()),Promise.resolve()}normalizedToMercatorX(t){return g.mapLinear(t,0,1,-20037508342789244e-9,20037508342789244e-9)}normalizedToMercatorY(t){return g.mapLinear(t,0,1,-20037508342789244e-9,20037508342789244e-9)}getUrl(t,e,s){const{tiling:i,layer:o,crs:n,format:r,tileDimension:l,styles:c,version:a,transparent:d}=this,T=a==="1.1.1"?"SRS":"CRS";let h;if(n==="EPSG:3857"){const u=i.getTileBounds(t,e,s,!0,!1),p=this.normalizedToMercatorX(u[0]),M=this.normalizedToMercatorY(u[1]),S=this.normalizedToMercatorX(u[2]),x=this.normalizedToMercatorY(u[3]);h=[p,M,S,x]}else{const[u,p,M,S]=i.getTileBounds(t,e,s,!1,!1).map(x=>x*g.RAD2DEG);n==="EPSG:4326"?a==="1.1.1"?h=[u,p,M,S]:h=[p,u,S,M]:h=[u,p,M,S]}const f=new URLSearchParams({SERVICE:"WMS",REQUEST:"GetMap",VERSION:a,LAYERS:o,[T]:n,BBOX:h.join(","),WIDTH:l,HEIGHT:l,FORMAT:r,TRANSPARENT:d?"TRUE":"FALSE"});return c!=null&&f.set("STYLES",c),new URL("?"+f.toString(),this.url).toString()}}class Tt extends b{constructor(t={}){const{levels:e,tileDimension:s,projection:i,url:o,...n}=t;super(n),this.name="XYZ_TILES_PLUGIN",this.imageSource=new nt({url:o,levels:e,tileDimension:s,projection:i})}}class ft extends b{constructor(t={}){const{url:e,...s}=t;super(s),this.name="TMS_TILES_PLUGIN",this.imageSource=new ot({url:e})}}class Mt extends b{constructor(t={}){const{capabilities:e,layer:s,tileMatrixSet:i,style:o,dimensions:n,...r}=t;super(r),this.name="WTMS_TILES_PLUGIN",this.imageSource=new ut({capabilities:e,layer:s,tileMatrixSet:i,style:o,dimensions:n})}}class St extends b{constructor(t={}){const{url:e,layer:s,crs:i,format:o,tileDimension:n,styles:r,version:l,...c}=t;super(c),this.name="WMS_TILES_PLUGIN",this.imageSource=new mt({url:e,layer:s,crs:i,format:o,tileDimension:n,styles:r,version:l})}}export{ft as T,St as W,Tt as X,Mt as a};
//# sourceMappingURL=EPSGTilesPlugin-DX3n6hNw.js.map
