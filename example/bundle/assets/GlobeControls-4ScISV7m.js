import{Q as U,G as W,n as I,o as f,ah as O,V as A,M as h}from"./three.module-D-uF--xd.js";import{E as N,N as G,s as z,m as w,D as Z,a as j,Z as H}from"./EnvironmentControls-BRF5UI-K.js";import{E as L}from"./Ellipsoid-Dwquuq5w.js";import{W as R}from"./I3DMLoader-BWluRuWb.js";const T=new I,C=new I,u=new f,r=new f,x=new f,g=new f,q=new f,y=new f,_=new U,E=new f,D=new f,a=new O,V=new L,v=new A,S={},k=2550;class $ extends N{get tilesGroup(){return console.warn('GlobeControls: "tilesGroup" has been deprecated. Use "ellipsoidGroup", instead.'),this.ellipsoidFrame}get ellipsoidFrame(){return this.ellipsoidGroup.matrixWorld}get ellipsoidFrameInverse(){const{ellipsoidGroup:t,ellipsoidFrame:i,_ellipsoidFrameInverse:e}=this;return t.matrixWorldInverse?t.matrixWorldInverse:e.copy(i).invert()}constructor(t=null,i=null,e=null,o=null){super(t,i,e),this.isGlobeControls=!0,this._dragMode=0,this._rotationMode=0,this.maxZoom=.01,this.nearMargin=.25,this.farMargin=0,this.useFallbackPlane=!1,this.autoAdjustCameraRotation=!1,this.globeInertia=new U,this.globeInertiaFactor=0,this.ellipsoid=R.clone(),this.ellipsoidGroup=new W,this._ellipsoidFrameInverse=new I,o!==null&&this.setTilesRenderer(o)}setTilesRenderer(t){super.setTilesRenderer(t),t!==null&&this.setEllipsoid(t.ellipsoid,t.group)}setEllipsoid(t,i){this.ellipsoid=t||R.clone(),this.ellipsoidGroup=i||new W}getPivotPoint(t){const{camera:i,ellipsoidFrame:e,ellipsoidFrameInverse:o,ellipsoid:s}=this;return g.set(0,0,-1).transformDirection(i.matrixWorld),a.origin.copy(i.position),a.direction.copy(g),a.applyMatrix4(o),s.closestPointToRayEstimate(a,r).applyMatrix4(e),(super.getPivotPoint(t)===null||u.subVectors(t,a.origin).dot(a.direction)>u.subVectors(r,a.origin).dot(a.direction))&&t.copy(r),t}getVectorToCenter(t){const{ellipsoidFrame:i,camera:e}=this;return t.setFromMatrixPosition(i).sub(e.position)}getDistanceToCenter(){return this.getVectorToCenter(r).length()}getUpDirection(t,i){const{ellipsoidFrame:e,ellipsoidFrameInverse:o,ellipsoid:s}=this;r.copy(t).applyMatrix4(o),s.getPositionToNormal(r,i),i.transformDirection(e)}getCameraUpDirection(t){const{ellipsoidFrame:i,ellipsoidFrameInverse:e,ellipsoid:o,camera:s}=this;s.isOrthographicCamera?(this._getVirtualOrthoCameraPosition(r),r.applyMatrix4(e),o.getPositionToNormal(r,t),t.transformDirection(i)):this.getUpDirection(s.position,t)}update(t=Math.min(this.clock.getDelta(),64/1e3)){if(!this.enabled||!this.camera||t===0)return;const{camera:i,pivotMesh:e}=this;this._isNearControls()?this.scaleZoomOrientationAtEdges=this.zoomDelta<0:(this.state!==G&&this._dragMode!==1&&this._rotationMode!==1&&(e.visible=!1),this.scaleZoomOrientationAtEdges=!1);const o=this.needsUpdate||this._inertiaNeedsUpdate();super.update(t),this.adjustCamera(i),o&&this._isNearControls()&&(this.getCameraUpDirection(y),this._alignCameraUp(y,1),this.getCameraUpDirection(y),this._clampRotation(y))}adjustCamera(t){super.adjustCamera(t);const{ellipsoidFrame:i,ellipsoidFrameInverse:e,ellipsoid:o,nearMargin:s,farMargin:n}=this,l=this._getMaxWorldRadius();if(t.isPerspectiveCamera){const c=r.setFromMatrixPosition(i).sub(t.position).length(),p=s*l,d=h.clamp((c-l)/p,0,1),m=h.lerp(1,1e3,d);t.near=Math.max(m,c-l-p),u.copy(t.position).applyMatrix4(e),o.getPositionToCartographic(u,S);const M=Math.max(o.getPositionElevation(u),k),F=o.calculateHorizonDistance(S.lat,M);t.far=F+.1+l*n,t.updateProjectionMatrix()}else{this._getVirtualOrthoCameraPosition(t.position,t),t.updateMatrixWorld(),T.copy(t.matrixWorld).invert(),r.setFromMatrixPosition(i).applyMatrix4(T);const c=-r.z;t.near=c-l*(1+s),t.far=c+.1+l*n,t.position.addScaledVector(g,t.near),t.far-=t.near,t.near=0,t.updateProjectionMatrix(),t.updateMatrixWorld()}}setState(...t){super.setState(...t),this._dragMode=0,this._rotationMode=0}_updateInertia(t){super._updateInertia(t);const{globeInertia:i,enableDamping:e,dampingFactor:o,camera:s,cameraRadius:n,minDistance:l,inertiaTargetDistance:c,ellipsoidFrame:p}=this;if(!this.enableDamping||this.inertiaStableFrames>1){this.globeInertiaFactor=0,this.globeInertia.identity();return}const d=Math.pow(2,-t/o),m=Math.max(s.near,n,l,c),b=.25*(2/(2*1e3));if(x.setFromMatrixPosition(p),this.globeInertiaFactor!==0){z(a,r.set(0,0,-1),s),a.applyMatrix4(s.matrixWorldInverse),a.direction.normalize(),a.recast(-a.direction.dot(a.origin)).at(m/a.direction.z,r),r.applyMatrix4(s.matrixWorld),z(a,u.set(b,b,-1),s),a.applyMatrix4(s.matrixWorldInverse),a.direction.normalize(),a.recast(-a.direction.dot(a.origin)).at(m/a.direction.z,u),u.applyMatrix4(s.matrixWorld),r.sub(x).normalize(),u.sub(x).normalize(),this.globeInertiaFactor*=d;const P=r.angleTo(u)/t;(2*Math.acos(i.w)*this.globeInertiaFactor<P||!e)&&(this.globeInertiaFactor=0,i.identity())}this.globeInertiaFactor!==0&&(i.w===1&&(i.x!==0||i.y!==0||i.z!==0)&&(i.w=Math.min(i.w,1-1e-9)),x.setFromMatrixPosition(p),_.identity().slerp(i,this.globeInertiaFactor*t),w(x,_,C),s.matrixWorld.premultiply(C),s.matrixWorld.decompose(s.position,s.quaternion,r))}_inertiaNeedsUpdate(){return super._inertiaNeedsUpdate()||this.globeInertiaFactor!==0}_updatePosition(t){if(this.state===Z){this._dragMode===0&&(this._dragMode=this._isNearControls()?1:-1);const{raycaster:i,camera:e,pivotPoint:o,pointerTracker:s,domElement:n,ellipsoidFrame:l,ellipsoidFrameInverse:c}=this,p=u,d=q;s.getCenterPoint(v),j(v,n,v),z(i,v,e),i.ray.applyMatrix4(c);const m=r.copy(o).applyMatrix4(c).length();if(V.radius.setScalar(m),!V.intersectRay(i.ray,r)){this.resetState(),this._updateInertia(t);return}r.applyMatrix4(l),x.setFromMatrixPosition(l),p.subVectors(o,x).normalize(),d.subVectors(r,x).normalize(),_.setFromUnitVectors(d,p),w(x,_,C),e.matrixWorld.premultiply(C),e.matrixWorld.decompose(e.position,e.quaternion,r),s.getMoveDistance()/t<2*window.devicePixelRatio?this.inertiaStableFrames++:(this.globeInertia.copy(_),this.globeInertiaFactor=1/t,this.inertiaStableFrames=0)}}_updateRotation(...t){this._rotationMode===1||this._isNearControls()?(this._rotationMode=1,super._updateRotation(...t)):(this.pivotMesh.visible=!1,this._rotationMode=-1)}_updateZoom(){const{zoomDelta:t,zoomSpeed:i,zoomPoint:e,camera:o,maxZoom:s,state:n}=this;if(n!==H&&t===0)return;this.rotationInertia.set(0,0),this.dragInertia.set(0,0,0),this.globeInertia.identity(),this.globeInertiaFactor=0;const l=h.clamp(h.mapLinear(Math.abs(t),0,20,0,1),0,1);if(this._isNearControls()||t>0){if(this._updateZoomDirection(),t<0&&(this.zoomPointSet||this._updateZoomPoint())){g.set(0,0,-1).transformDirection(o.matrixWorld).normalize(),D.copy(this.up).multiplyScalar(-1),this.getUpDirection(e,E);const c=h.clamp(h.mapLinear(-E.dot(D),1,.95,0,1),0,1),p=1-g.dot(D),d=o.isOrthographicCamera?.05:1,m=h.clamp(l*3,0,1),M=Math.min(c*p*d*m,.1);D.lerpVectors(g,D,M).normalize(),_.setFromUnitVectors(g,D),w(e,_,C),o.matrixWorld.premultiply(C),o.matrixWorld.decompose(o.position,o.quaternion,D),this.zoomDirection.subVectors(e,o.position).normalize()}super._updateZoom()}else if(o.isPerspectiveCamera){const c=this._getPerspectiveTransitionDistance(),p=this._getMaxPerspectiveDistance(),d=h.mapLinear(this.getDistanceToCenter(),c,p,0,1);this._tiltTowardsCenter(h.lerp(0,.4,d*l)),this._alignCameraUpToNorth(h.lerp(0,.2,d*l));const m=this.getDistanceToCenter()-this._getMaxWorldRadius(),M=t*m*i*.0025,F=Math.max(M,Math.min(this.getDistanceToCenter()-p,0));this.getVectorToCenter(r).normalize(),this.camera.position.addScaledVector(r,F),this.camera.updateMatrixWorld(),this.zoomDelta=0}else{const c=this._getOrthographicTransitionZoom(),p=this._getMinOrthographicZoom(),d=h.mapLinear(o.zoom,c,p,0,1);this._tiltTowardsCenter(h.lerp(0,.4,d*l)),this._alignCameraUpToNorth(h.lerp(0,.2,d*l));const m=this.zoomDelta,M=Math.pow(.95,Math.abs(m*.05)),F=m>0?1/Math.abs(M):M,b=p/o.zoom,P=Math.max(F*i,Math.min(b,1));o.zoom=Math.min(s,o.zoom*P),o.updateProjectionMatrix(),this.zoomDelta=0,this.zoomDirectionSet=!1}}_alignCameraUpToNorth(t){const{ellipsoidFrame:i}=this;y.set(0,0,1).transformDirection(i),this._alignCameraUp(y,t)}_tiltTowardsCenter(t){const{camera:i,ellipsoidFrame:e}=this;g.set(0,0,-1).transformDirection(i.matrixWorld).normalize(),r.setFromMatrixPosition(e).sub(i.position).normalize(),r.lerp(g,1-t).normalize(),_.setFromUnitVectors(g,r),i.quaternion.premultiply(_),i.updateMatrixWorld()}_getPerspectiveTransitionDistance(){const{camera:t}=this;if(!t.isPerspectiveCamera)throw new Error;const i=this._getMaxWorldRadius(),e=2*Math.atan(Math.tan(h.DEG2RAD*t.fov*.5)*t.aspect),o=i/Math.tan(h.DEG2RAD*t.fov*.5),s=i/Math.tan(e*.5);return Math.max(o,s)}_getMaxPerspectiveDistance(){const{camera:t}=this;if(!t.isPerspectiveCamera)throw new Error;const i=this._getMaxWorldRadius(),e=2*Math.atan(Math.tan(h.DEG2RAD*t.fov*.5)*t.aspect),o=i/Math.tan(h.DEG2RAD*t.fov*.5),s=i/Math.tan(e*.5);return 2*Math.max(o,s)}_getOrthographicTransitionZoom(){const{camera:t}=this;if(!t.isOrthographicCamera)throw new Error;const i=t.top-t.bottom,e=t.right-t.left,o=Math.max(i,e),n=2*this._getMaxWorldRadius();return 2*o/n}_getMinOrthographicZoom(){const{camera:t}=this;if(!t.isOrthographicCamera)throw new Error;const i=t.top-t.bottom,e=t.right-t.left,o=Math.min(i,e),n=2*this._getMaxWorldRadius();return .7*o/n}_getVirtualOrthoCameraPosition(t,i=this.camera){const{ellipsoidFrame:e,ellipsoidFrameInverse:o,ellipsoid:s}=this;if(!i.isOrthographicCamera)throw new Error;a.origin.copy(i.position),a.direction.set(0,0,-1).transformDirection(i.matrixWorld),a.applyMatrix4(o),s.closestPointToRayEstimate(a,u).applyMatrix4(e);const n=i.top-i.bottom,l=i.right-i.left,c=Math.max(n,l)/i.zoom;g.set(0,0,-1).transformDirection(i.matrixWorld);const p=u.sub(i.position).dot(g);t.copy(i.position).addScaledVector(g,p-c*4)}_isNearControls(){const{camera:t}=this;return t.isPerspectiveCamera?this.getDistanceToCenter()<this._getPerspectiveTransitionDistance():t.zoom>this._getOrthographicTransitionZoom()}_raycast(t){const i=super._raycast(t);if(i===null){const{ellipsoid:e,ellipsoidFrame:o,ellipsoidFrameInverse:s}=this;a.copy(t.ray).applyMatrix4(s);const n=e.intersectRay(a,r);return n!==null?(n.applyMatrix4(o),{point:n.clone(),distance:n.distanceTo(t.ray.origin)}):null}else return i}_getMaxWorldRadius(){const{ellipsoid:t,ellipsoidFrame:i}=this;return Math.max(...t.radius)*i.getMaxScaleOnAxis()}}export{$ as G};
//# sourceMappingURL=GlobeControls-4ScISV7m.js.map
