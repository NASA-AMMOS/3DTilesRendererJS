{"version":3,"file":"i3dmExample-DFlwN-Sc.js","sources":["../../three/i3dmExample.js"],"sourcesContent":["import { I3DMLoader } from '3d-tiles-renderer';\nimport {\n\tScene,\n\tDirectionalLight,\n\tAmbientLight,\n\tWebGLRenderer,\n\tPerspectiveCamera,\n\tPCFSoftShadowMap,\n\tVector3,\n\tQuaternion,\n\tRaycaster,\n\tVector2,\n\tMatrix4,\n} from 'three';\nimport { OrbitControls } from 'three/examples/jsm/controls/OrbitControls.js';\nimport { DRACOLoader } from 'three/examples/jsm/loaders/DRACOLoader.js';\nimport { GLTFLoader } from 'three/examples/jsm/loaders/GLTFLoader.js';\n\nlet camera, controls, scene, renderer;\nlet dirLight;\nlet raycaster, mouse;\nlet infoEl;\n\ninit();\nanimate();\n\nfunction init() {\n\n\tinfoEl = document.getElementById( 'hover-info' );\n\n\tscene = new Scene();\n\n\t// primary camera view\n\trenderer = new WebGLRenderer( { antialias: true } );\n\trenderer.setPixelRatio( window.devicePixelRatio );\n\trenderer.setSize( window.innerWidth, window.innerHeight );\n\trenderer.setClearColor( 0x151c1f );\n\trenderer.shadowMap.enabled = true;\n\trenderer.shadowMap.type = PCFSoftShadowMap;\n\n\tdocument.body.appendChild( renderer.domElement );\n\n\tcamera = new PerspectiveCamera( 60, window.innerWidth / window.innerHeight, 1, 4000 );\n\tcamera.position.set( 100, 100, 100 );\n\n\t// controls\n\tcontrols = new OrbitControls( camera, renderer.domElement );\n\tcontrols.screenSpacePanning = false;\n\tcontrols.minDistance = 1;\n\tcontrols.maxDistance = 2000;\n\n\t// lights\n\tdirLight = new DirectionalLight( 0xffffff, 1.25 );\n\tdirLight.position.set( 1, 2, 3 ).multiplyScalar( 40 );\n\tdirLight.castShadow = true;\n\tdirLight.shadow.bias = - 0.01;\n\tdirLight.shadow.mapSize.setScalar( 2048 );\n\n\tconst shadowCam = dirLight.shadow.camera;\n\tshadowCam.left = - 200;\n\tshadowCam.bottom = - 200;\n\tshadowCam.right = 200;\n\tshadowCam.top = 200;\n\tshadowCam.updateProjectionMatrix();\n\n\tscene.add( dirLight );\n\n\tconst ambLight = new AmbientLight( 0xffffff, 0.05 );\n\tscene.add( ambLight );\n\n\tconst i3dmLoader = new I3DMLoader();\n\n\tconst dracoLoader = new DRACOLoader();\n\tdracoLoader.setDecoderPath( 'https://unpkg.com/three@0.153.0/examples/jsm/libs/draco/gltf/' );\n\tconst gltfLoader = new GLTFLoader( i3dmLoader.manager );\n\tgltfLoader.setDRACOLoader( dracoLoader );\n\ti3dmLoader.manager.addHandler( /\\.gltf$/, gltfLoader );\n\n\ti3dmLoader.loadAsync( 'https://3d.geo.admin.ch/ch.swisstopo.vegetation.3d/v1/20250728/10/200/330.i3dm' )\n\t\t.then( res => {\n\n\t\t\tlet instance = null;\n\t\t\tres.scene.traverse( c => {\n\n\t\t\t\tif ( ! instance && c.isInstancedMesh ) {\n\n\t\t\t\t\tinstance = c;\n\n\t\t\t\t}\n\n\t\t\t} );\n\n\t\t\tif ( instance ) {\n\n\t\t\t\tres.scene.updateMatrixWorld( true );\n\n\t\t\t\tconst pos = new Vector3();\n\t\t\t\tconst quat = new Quaternion();\n\t\t\t\tconst sca = new Vector3();\n\t\t\t\tconst mat = new Matrix4();\n\t\t\t\tconst averagePos = new Vector3();\n\n\t\t\t\tfor ( let i = 0, l = instance.count; i < l; i ++ ) {\n\n\t\t\t\t\tinstance.getMatrixAt( i, mat );\n\t\t\t\t\tmat.premultiply( instance.matrixWorld );\n\t\t\t\t\tmat.decompose( pos, quat, sca );\n\t\t\t\t\taveragePos.add( pos );\n\n\t\t\t\t}\n\n\t\t\t\taveragePos.divideScalar( instance.count );\n\t\t\t\tcontrols.target.copy( averagePos );\n\t\t\t\tcamera.position.add( averagePos );\n\t\t\t\tcontrols.update();\n\n\t\t\t}\n\n\t\t\tconsole.log( res );\n\t\t\tscene.add( res.scene );\n\n\t\t} );\n\n\traycaster = new Raycaster();\n\tmouse = new Vector2();\n\n\tonWindowResize();\n\twindow.addEventListener( 'resize', onWindowResize, false );\n\trenderer.domElement.addEventListener( 'mousemove', onMouseMove, false );\n\n}\n\nfunction onMouseMove( e ) {\n\n\tconst bounds = this.getBoundingClientRect();\n\tmouse.x = e.clientX - bounds.x;\n\tmouse.y = e.clientY - bounds.y;\n\tmouse.x = ( mouse.x / bounds.width ) * 2 - 1;\n\tmouse.y = - ( mouse.y / bounds.height ) * 2 + 1;\n\n\traycaster.setFromCamera( mouse, camera );\n\n\t// Get the batch table data\n\tconst intersects = raycaster.intersectObject( scene );\n\tlet hoveredInstanceId = - 1;\n\tif ( intersects.length > 0 ) {\n\n\t\tconst { object, instanceId } = intersects[ 0 ];\n\n\t\tif ( instanceId ) {\n\n\t\t\thoveredInstanceId = instanceId;\n\n\t\t\t// Traverse the parents to find the batch table.\n\t\t\tlet batchTableObject = object;\n\t\t\twhile ( ! batchTableObject.batchTable ) {\n\n\t\t\t\tbatchTableObject = batchTableObject.parent;\n\n\t\t\t}\n\n\t\t\t// Log the batch data\n\t\t\tconst batchTable = batchTableObject.batchTable;\n\t\t\tconst batchData = batchTable.getDataFromId( hoveredInstanceId );\n\t\t\tconst hierarchyData = batchData[ '3DTILES_batch_table_hierarchy' ];\n\n\t\t\tconst batchTableKeys = batchTable.getKeys();\n\t\t\tinfoEl.innerText = `${ '_batchid'.padEnd( 15 ) }: ${ hoveredInstanceId }\\n`;\n\t\t\tfor ( const key of batchTableKeys ) {\n\n\t\t\t\tinfoEl.innerText += `${ key.padEnd( 15 ) }: ${ batchData[ key ] }\\n`;\n\n\t\t\t}\n\n\t\t\tfor ( const className in hierarchyData ) {\n\n\t\t\t\tfor ( const instance in hierarchyData[ className ] ) {\n\n\t\t\t\t\tinfoEl.innerText +=\n\t\t\t\t\t\t`${ instance.padEnd( 15 ) } : ${ hierarchyData[ className ][ instance ] }\\n`;\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t}\n\n\t} else {\n\n\t\tinfoEl.innerText = '';\n\n\t}\n\n}\n\nfunction onWindowResize() {\n\n\tcamera.aspect = window.innerWidth / window.innerHeight;\n\trenderer.setPixelRatio( window.devicePixelRatio );\n\trenderer.setSize( window.innerWidth, window.innerHeight );\n\tcamera.updateProjectionMatrix();\n\n}\n\nfunction animate() {\n\n\trequestAnimationFrame( animate );\n\n\trender();\n\n}\n\nfunction render() {\n\n\trenderer.render( scene, camera );\n\n}\n"],"names":["camera","controls","scene","renderer","dirLight","raycaster","mouse","infoEl","init","animate","Scene","WebGLRenderer","PCFSoftShadowMap","PerspectiveCamera","OrbitControls","DirectionalLight","shadowCam","ambLight","AmbientLight","i3dmLoader","I3DMLoader","dracoLoader","DRACOLoader","gltfLoader","GLTFLoader","res","instance","c","pos","Vector3","quat","Quaternion","sca","mat","Matrix4","averagePos","i","l","Raycaster","Vector2","onWindowResize","onMouseMove","e","bounds","intersects","hoveredInstanceId","object","instanceId","batchTableObject","batchTable","batchData","hierarchyData","batchTableKeys","key","className","render"],"mappings":"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"}