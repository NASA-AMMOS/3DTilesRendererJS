import{g as R,r as l,l as G,u as D,h as V,j as m,k as I,i as N,d as q}from"./CameraControls-CQWLZjoh.js";import{S as Q,o as z,n as S,ah as U,O as X,aE as Y,R as $,Q as Z,M as H}from"./three.module-D-uF--xd.js";import{C as J}from"./CanvasDOMOverlay-Dx1Xg4wU.js";import{C as K}from"./CameraTransitionManager-DLsYaW0B.js";const g=new z,E=new z,T=new z,k=new S,F=new S,W=new U,O={};function ee(a,u,s,r){W.origin.copy(a.position),W.direction.set(0,0,-1).transformDirection(a.matrixWorld),W.applyMatrix4(s.matrixWorldInverse),u.closestPointToRayEstimate(W,T),T.applyMatrix4(s.matrixWorld),E.set(0,0,-1).transformDirection(a.matrixWorld);const c=T.sub(a.position).dot(E);return r.copy(a.position).addScaledVector(E,c),r}function te(a){const{defaultScene:u,defaultCamera:s,overrideRenderLoop:r=!0,renderPriority:c=1}=a,p=l.useMemo(()=>new X,[]),[h,o,i,y]=R(n=>[n.set,n.size,n.gl,n.scene]);l.useEffect(()=>{h({camera:p})},[h,p]),l.useEffect(()=>{p.left=-o.width/2,p.right=o.width/2,p.top=o.height/2,p.bottom=-o.height/2,p.near=0,p.far=2e3,p.position.z=p.far/2,p.updateProjectionMatrix()},[p,o]),D(()=>{r&&i.render(u,s);const n=i.autoClear;i.autoClear=!1,i.clearDepth(),i.render(y,p),i.autoClear=n},c)}function _(){const a=l.useRef();return l.useEffect(()=>{const s=a.current.attributes.position;for(let r=0,c=s.count;r<c;r++)g.fromBufferAttribute(s,r),g.y>0&&(g.x=0,s.setXYZ(r,...g))}),m.jsx("boxGeometry",{ref:a})}function re({northColor:a=15684432,southColor:u=16777215}){const[s,r]=l.useState(),c=l.useRef();return l.useEffect(()=>{r(c.current)},[]),m.jsxs("group",{scale:.5,ref:c,children:[m.jsx("ambientLight",{intensity:1}),m.jsx("directionalLight",{position:[0,2,3],intensity:3,target:s}),m.jsx("directionalLight",{position:[0,-2,-3],intensity:3,target:s}),m.jsxs("mesh",{children:[m.jsx("sphereGeometry",{}),m.jsx("meshBasicMaterial",{color:0,opacity:.3,transparent:!0,side:Y})]}),m.jsxs("group",{scale:[.5,1,.15],children:[m.jsxs("mesh",{"position-y":.5,children:[m.jsx(_,{}),m.jsx("meshStandardMaterial",{color:a})]}),m.jsxs("mesh",{"position-y":-.5,"rotation-x":Math.PI,children:[m.jsx(_,{}),m.jsx("meshStandardMaterial",{color:u})]})]})]})}function ce({children:a,overrideRenderLoop:u,mode:s="3d",margin:r=10,scale:c=35,visible:p=!0,...h}){const[o,i,y]=R(t=>[t.camera,t.scene,t.size]),n=l.useContext(G),f=l.useRef(null),M=l.useMemo(()=>new Q,[]);let v,e;return Array.isArray(r)?(v=r[0],e=r[1]):(v=r,e=r),D(()=>{const t=n==null?void 0:n.ellipsoid,d=n==null?void 0:n.frame;if(!t||!d||f.current===null)return null;const x=f.current;if(ee(o,t,d,T).applyMatrix4(d.matrixWorldInverse),t.getPositionToCartographic(T,O),t.getEastNorthUpFrame(O.lat,O.lon,0,F).premultiply(d.matrixWorld),F.invert(),k.copy(o.matrixWorld).premultiply(F),s.toLowerCase()==="3d")x.quaternion.setFromRotationMatrix(k).invert();else if(g.set(0,1,0).transformDirection(k).normalize(),g.z=0,g.normalize(),g.length()===0)x.quaternion.identity();else{const C=E.set(0,1,0).angleTo(g);E.cross(g).normalize(),x.quaternion.setFromAxisAngle(E,-C)}}),a||(a=m.jsx(re,{})),p?V(m.jsxs(m.Fragment,{children:[m.jsx("group",{ref:f,scale:c,position:[y.width/2-v-c/2,-y.height/2+e+c/2,0],...h,children:a}),m.jsx(te,{defaultCamera:o,defaultScene:i,overrideRenderLoop:u,renderPriority:10})]}),M,{events:{priority:10}}):null}const oe=l.forwardRef(function(u,s){const{mode:r="perspective",onBeforeToggle:c,perspectiveCamera:p,orthographicCamera:h,...o}=u,[i,y,n,f,M,v]=R(t=>[t.set,t.get,t.invalidate,t.controls,t.camera,t.size]),e=l.useMemo(()=>{const t=new K;return t.autoSync=!1,M.isOrthographicCamera?(t.orthographicCamera.copy(M),t.mode="orthographic"):t.perspectiveCamera.copy(M),t.syncCameras(),t.mode=r,t},[]);l.useEffect(()=>{const{perspectiveCamera:t,orthographicCamera:d}=e,x=v.width/v.height;t.aspect=x,t.updateProjectionMatrix(),d.left=-d.top*x,d.right=-d.left,t.updateProjectionMatrix()},[e,v]),I(e,s),l.useEffect(()=>{const t=({camera:d})=>{i(()=>({camera:d}))};return i(()=>({camera:e.camera})),e.addEventListener("camera-change",t),()=>{e.removeEventListener("camera-change",t)}},[e,i]),l.useEffect(()=>{const t=e.perspectiveCamera,d=e.orthographicCamera;return e.perspectiveCamera=p||t,e.orthographicCamera=h||d,i(()=>({camera:e.camera})),()=>{e.perspectiveCamera=t,e.orthographicCamera=d}},[p,h,e,i]),l.useEffect(()=>{if(r!==e.mode){const t=r==="orthographic"?e.orthographicCamera:e.perspectiveCamera;c?c(e,t):f&&f.isEnvironmentControls?(f.getPivotPoint(e.fixedPoint),e.syncCameras(),f.adjustCamera(e.perspectiveCamera),f.adjustCamera(e.orthographicCamera)):(e.fixedPoint.set(0,0,-1).transformDirection(e.camera.matrixWorld).multiplyScalar(50).add(e.camera.position),e.syncCameras()),e.toggle(),n()}},[r,e,n,f,c]),l.useEffect(()=>{const t=()=>n();return e.addEventListener("transition-start",t),e.addEventListener("change",t),e.addEventListener("transition-end",t),()=>{e.removeEventListener("transition-start",t),e.removeEventListener("change",t),e.removeEventListener("transition-end",t)}},[e,n]),N(e,o),D(()=>{e.update(),f&&(f.enabled=!e.animating);const{camera:t,size:d}=y();if(!h&&t===e.orthographicCamera){const x=d.width/d.height,C=e.orthographicCamera;x!==C.right&&(C.bottom=-1,C.top=1,C.left=-x,C.right=x,C.updateProjectionMatrix())}e.animating&&n()},-1)});function le(a){const u=l.useContext(q),s=l.useRef();return D(()=>{const r=s.current;r&&u&&(r.style.width=`${u.loadProgress*100}%`,r.style.opacity=u.loadProgress===1?0:1,r.style.transition=u.loadProgress===1?"opacity 0.5s linear":"")}),m.jsx(J,{ref:s,style:{position:"absolute",left:0,bottom:0,height:"2px",background:"white",opacity:0,width:"100%"}})}const b=new S;function B(a,u,s){return s.makeTranslation(-a.x,-a.y,-a.z),b.makeRotationFromQuaternion(u),s.premultiply(b),b.makeTranslation(a.x,a.y,a.z),s.premultiply(b),s}const P=new $,j=new z,L=new z,A=new Z,w=new S,me=l.forwardRef(function(u,s){const r=l.useContext(q),c=R(({controls:o})=>o),p=R(({scene:o})=>o),h=l.useCallback((o,i)=>{if(!o.animating){i.updateMatrixWorld(),P.ray.direction.set(0,0,-1).transformDirection(o.camera.matrixWorld),P.ray.origin.setFromMatrixPosition(o.camera.matrixWorld);const y=P.intersectObject(p)[0];if(y?(o.fixedPoint.copy(y.point),o.syncCameras()):(c.getPivotPoint(o.fixedPoint),o.syncCameras()),r?(w.copy(r.group.matrixWorld).invert(),j.copy(o.fixedPoint).applyMatrix4(w),r.ellipsoid.getPositionToNormal(j,j).multiplyScalar(-1).transformDirection(r.group.matrixWorld)):j.set(0,-1,0),i.isOrthographicCamera){const n=j.angleTo(P.ray.direction);L.crossVectors(j,P.ray.direction),A.setFromAxisAngle(L,-n).normalize(),B(o.fixedPoint,A,w),i.matrixWorld.premultiply(w),i.matrixWorld.decompose(i.position,i.quaternion,i.scale)}else if(!c.isGlobeControls||c._isNearControls()){let n=j.angleTo(P.ray.direction);n=Math.max(65*H.DEG2RAD-n,0),L.set(1,0,0).transformDirection(i.matrixWorld),A.setFromAxisAngle(L,n).normalize(),B(o.fixedPoint,A,w),i.matrixWorld.premultiply(w),i.matrixWorld.decompose(i.position,i.quaternion,i.scale)}}c.adjustCamera(o.perspectiveCamera),c.adjustCamera(o.orthographicCamera)},[r,c,p]);return m.jsx(oe,{...u,ref:s,onBeforeToggle:h})});export{me as C,le as T,ce as a};
//# sourceMappingURL=CameraViewTransition-Cm1nEoKA.js.map
