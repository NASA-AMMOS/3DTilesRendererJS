import{L as K,r as tt,F as et,B as at,a as st,g as nt}from"./BatchTable-CRr3zuRk.js";import{aY as ot,n as B,o as m,bk as rt,Q as J}from"./three.module-D-uF--xd.js";import{G as it}from"./GLTFLoader-B4GrkiON.js";import{W as v,b as ct}from"./constants-JFoaxC9y.js";import{E as lt}from"./Ellipsoid-Dwquuq5w.js";class Tt extends K{parse(s){const n=new DataView(s),e=tt(n);console.assert(e==="i3dm");const T=n.getUint32(4,!0);console.assert(T===1);const w=n.getUint32(8,!0);console.assert(w===s.byteLength);const M=n.getUint32(12,!0),R=n.getUint32(16,!0),c=n.getUint32(20,!0),f=n.getUint32(24,!0),N=n.getUint32(28,!0),p=32,x=s.slice(p,p+M+R),r=new et(x,0,M,R),a=p+M+R,o=s.slice(a,a+c+f),u=new at(o,r.getData("INSTANCES_LENGTH"),0,c,f),S=a+c+f,_=new Uint8Array(s,S,w-S);let g=null,h=null,A=null;if(N)g=_,h=Promise.resolve();else{const E=this.resolveExternalURL(st(_));A=nt(E),h=fetch(E,this.fetchOptions).then(i=>{if(!i.ok)throw new Error(`I3DMLoaderBase : Failed to load file "${E}" with status ${i.status} : ${i.statusText}`);return i.arrayBuffer()}).then(i=>{g=new Uint8Array(i)})}return h.then(()=>({version:T,featureTable:r,batchTable:u,glbBytes:g,gltfWorkingPath:A}))}}const q=new lt(v,v,ct);q.name="WGS84 Earth";const D=new m,b=new m,d=new m,G=new m,F=new J,P=new m,I=new B,z=new B,Z=new m,j=new B,H=new J,W={};function $(O,s,n,e){if(O=O/n*2-1,s=s/n*2-1,e.x=O,e.y=s,e.z=1-Math.abs(O)-Math.abs(s),e.z<0){const T=e.x;e.x=(1-Math.abs(e.y))*(T>=0?1:-1),e.y=(1-Math.abs(T))*(e.y>=0?1:-1)}return e.normalize(),e}class mt extends Tt{constructor(s=ot){super(),this.manager=s,this.adjustmentTransform=new B,this.ellipsoid=q.clone()}resolveExternalURL(s){return this.manager.resolveURL(super.resolveExternalURL(s))}parse(s){return super.parse(s).then(n=>{const{featureTable:e,batchTable:T}=n,w=n.glbBytes.slice().buffer;return new Promise((M,R)=>{const c=this.fetchOptions,f=this.manager,N=f.getHandler("path.gltf")||new it(f);c.credentials==="include"&&c.mode==="cors"&&N.setCrossOrigin("use-credentials"),"credentials"in c&&N.setWithCredentials(c.credentials==="include"),c.headers&&N.setRequestHeader(c.headers);let p=n.gltfWorkingPath??this.workingPath;/[\\/]$/.test(p)||(p+="/");const x=this.adjustmentTransform;N.parse(w,p,r=>{const a=e.getData("INSTANCES_LENGTH");let o=e.getData("POSITION",a,"FLOAT","VEC3");const u=e.getData("POSITION_QUANTIZED",a,"UNSIGNED_SHORT","VEC3"),S=e.getData("QUANTIZED_VOLUME_OFFSET",1,"FLOAT","VEC3"),_=e.getData("QUANTIZED_VOLUME_SCALE",1,"FLOAT","VEC3"),g=e.getData("NORMAL_UP",a,"FLOAT","VEC3"),h=e.getData("NORMAL_RIGHT",a,"FLOAT","VEC3"),A=e.getData("NORMAL_UP_OCT32P",a,"UNSIGNED_SHORT","VEC2"),E=e.getData("NORMAL_RIGHT_OCT32P",a,"UNSIGNED_SHORT","VEC2"),i=e.getData("SCALE_NON_UNIFORM",a,"FLOAT","VEC3"),Q=e.getData("SCALE",a,"FLOAT","SCALAR"),y=e.getData("RTC_CENTER",1,"FLOAT","VEC3"),X=e.getData("EAST_NORTH_UP");if(!o&&u){o=new Float32Array(a*3);for(let t=0;t<a;t++)o[t*3+0]=S[0]+u[t*3+0]/65535*_[0],o[t*3+1]=S[1]+u[t*3+1]/65535*_[1],o[t*3+2]=S[2]+u[t*3+2]/65535*_[2]}const L=new m;for(let t=0;t<a;t++)L.x+=o[t*3+0]/a,L.y+=o[t*3+1]/a,L.z+=o[t*3+2]/a;const C=[],k=[];r.scene.updateMatrixWorld(),r.scene.traverse(t=>{if(t.isMesh){k.push(t);const{geometry:U,material:V}=t,l=new rt(U,V,a);l.position.copy(L),y&&(l.position.x+=y[0],l.position.y+=y[1],l.position.z+=y[2]),C.push(l)}});for(let t=0;t<a;t++){G.set(o[t*3+0]-L.x,o[t*3+1]-L.y,o[t*3+2]-L.z),F.identity(),g&&h?(b.set(g[t*3+0],g[t*3+1],g[t*3+2]),d.set(h[t*3+0],h[t*3+1],h[t*3+2]),D.crossVectors(d,b).normalize(),I.makeBasis(d,b,D),F.setFromRotationMatrix(I)):A&&E&&($(A[t*2+0],A[t*2+1],65535,b),$(E[t*2+0],E[t*2+1],65535,d),D.crossVectors(d,b).normalize(),I.makeBasis(d,b,D),F.setFromRotationMatrix(I)),P.set(1,1,1),i&&P.set(i[t*3+0],i[t*3+1],i[t*3+2]),Q&&P.multiplyScalar(Q[t]);for(let U=0,V=C.length;U<V;U++){const l=C[U];H.copy(F),X&&(l.updateMatrixWorld(),Z.copy(G).applyMatrix4(l.matrixWorld),this.ellipsoid.getPositionToCartographic(Z,W),this.ellipsoid.getEastNorthUpFrame(W.lat,W.lon,j),H.setFromRotationMatrix(j)),I.compose(G,H,P).multiply(x);const Y=k[U];z.multiplyMatrices(I,Y.matrixWorld),l.setMatrixAt(t,z)}}r.scene.clear(),r.scene.add(...C),r.batchTable=T,r.featureTable=e,r.scene.batchTable=T,r.scene.featureTable=e,M(r)},R)})})}}export{mt as I,q as W};
//# sourceMappingURL=I3DMLoader-BWluRuWb.js.map
