{"version":3,"file":"metadata-CQh_2vjO.js","sources":["../../src/MeshFeaturesMaterial.js","../../metadata.js"],"sourcesContent":["import { MeshBasicMaterial } from 'three';\n\nexport const MeshFeaturesMaterialMixin = base => class extends base {\n\n\tget featureTexture() {\n\n\t\treturn this.uniforms.featureTexture.value;\n\n\t}\n\n\tset featureTexture( v ) {\n\n\t\tconst texture = this.uniforms.featureTexture.value;\n\t\tif ( texture !== v && texture ) {\n\n\t\t\ttexture.dispose();\n\n\t\t}\n\n\t\tthis.uniforms.featureTexture.value = v;\n\n\t}\n\n\tget nullFeatureId() {\n\n\t\treturn this.uniforms.nullFeatureId.value;\n\n\t}\n\n\tset nullFeatureId( v ) {\n\n\t\tif ( v < 0 || v === null || v === undefined ) {\n\n\t\t\tthis.uniforms.nullFeatureId.value = null;\n\t\t\tthis.setDefine( 'USE_NULL_FEATURE', 0 );\n\n\t\t} else {\n\n\t\t\tthis.uniforms.nullFeatureId.value = v;\n\t\t\tthis.setDefine( 'USE_NULL_FEATURE', 1 );\n\n\t\t}\n\n\t}\n\n\tget highlightFeatureId() {\n\n\t\treturn this.uniforms.highlightFeatureId.value;\n\n\t}\n\n\tset highlightFeatureId( v ) {\n\n\t\tif ( v === null || v === undefined ) {\n\n\t\t\tthis.uniforms.highlightFeatureId.value = null;\n\t\t\tthis.setDefine( 'USE_HIGHLIGHT_FEATURE', 0 );\n\n\t\t} else {\n\n\t\t\tthis.uniforms.highlightFeatureId.value = v;\n\t\t\tthis.setDefine( 'USE_HIGHLIGHT_FEATURE', 1 );\n\n\t\t}\n\n\t}\n\n\tconstructor( ...args ) {\n\n\t\tsuper( ...args );\n\n\t\tthis.isMeshFeaturesMaterial = true;\n\t\tthis.uniforms = {\n\n\t\t\tfeatureChannelsLength: { value: 0 },\n\t\t\tfeatureChannels: { value: new Array( 4 ).fill( 0 ) },\n\t\t\tfeatureTexture: { value: null },\n\t\t\tnullFeatureId: { value: null },\n\t\t\thighlightFeatureId: { value: - 1 },\n\n\t\t};\n\n\t\tObject.assign( this.defines, {\n\n\t\t\t// 0: Disabled\n\t\t\t// 1: Implicit\n\t\t\t// 2: Attribute\n\t\t\t// 3: Texture\n\t\t\tFEATURE_TYPE: 0,\n\t\t\tUSE_HIGHLIGHT_FEATURE: 0,\n\t\t\tUSE_NULL_FEATURE: 0,\n\t\t\tFEATURE_ATTR: '',\n\t\t\tFEATURE_TEXTURE_ATTR: 'uv',\n\n\t\t} );\n\n\t\tthis.addEventListener( 'dispose', () => {\n\n\t\t\tif ( this.featureTexture ) {\n\n\t\t\t\tthis.featureTexture.dispose();\n\n\t\t\t}\n\n\t\t} );\n\n\t}\n\n\tcopy( source ) {\n\n\t\tconst currentDefines = this.defines;\n\n\t\tsuper.copy( source );\n\n\t\tif ( source.defines ) {\n\n\t\t\tObject.assign( this.defines, currentDefines, source.defines );\n\n\t\t}\n\n\t\tif ( source.uniforms ) {\n\n\t\t\tfor ( const key in this.uniforms ) {\n\n\t\t\t\tconst value = source.uniforms[ key ].value;\n\t\t\t\tif ( Array.isArray( value ) ) {\n\n\t\t\t\t\tthis.uniforms[ key ].value = value.slice();\n\n\t\t\t\t} else {\n\n\t\t\t\t\tthis.uniforms[ key ].value = value;\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t}\n\n\t\tthis.needsUpdate = true;\n\n\n\n\t}\n\n\tsetDefine( define, value ) {\n\n\t\tconst defines = this.defines;\n\t\tif ( defines[ define ] !== value ) {\n\n\t\t\tthis.needsUpdate = true;\n\n\t\t}\n\n\t\tif ( value === null ) {\n\n\t\t\tdelete defines[ define ];\n\n\t\t} else {\n\n\t\t\tdefines[ define ] = value;\n\n\t\t}\n\n\t}\n\n\tsetFromMeshFeatures( meshFeatures, featureIdOrName ) {\n\n\t\tlet info = null;\n\t\tif ( typeof featureIdOrName === 'number' ) {\n\n\t\t\tinfo = meshFeatures.getFeatureInfo()[ featureIdOrName ] || null;\n\n\t\t} else if ( typeof featureIdOrName === 'string' ) {\n\n\t\t\tinfo = meshFeatures.getFeatureInfo().find( el => el.label === featureIdOrName ) || null;\n\n\t\t}\n\n\t\tif ( info === null ) {\n\n\t\t\tthis.setDefine( 'FEATURE_TYPE', 0 );\n\t\t\tthis.featureTexture = null;\n\n\t\t} else if ( 'attribute' in info ) {\n\n\t\t\tthis._setAttributeFeature( info.attribute );\n\n\t\t} else if ( 'texture' in info ) {\n\n\t\t\tthis._setTextureFeature( meshFeatures.textures[ info.texture.index ], info.texture.texCoord, info.texture.channels );\n\n\t\t} else {\n\n\t\t\tthis._setAttributeFeature( null );\n\n\t\t}\n\n\t\tif ( info !== null ) {\n\n\t\t\tthis.nullFeatureId = info.nullFeatureId == null ? null : info.nullFeatureId;\n\n\t\t}\n\n\t}\n\n\tdisableFeatureDisplay() {\n\n\t\tthis.setDefine( 'FEATURE_TYPE', 0 );\n\t\tthis.featureTexture = null;\n\n\t}\n\n\t_setTextureFeature( texture, uv, channels ) {\n\n\t\tconst uniforms = this.uniforms;\n\n\t\tthis.setDefine( 'FEATURE_TYPE', 3 );\n\t\tif ( uv === 0 ) {\n\n\t\t\tthis.setDefine( 'FEATURE_TEXTURE_ATTR', 'uv' );\n\t\t\tthis.setDefine( 'USE_UV', '' );\n\n\t\t} else {\n\n\t\t\tthis.setDefine( 'FEATURE_TEXTURE_ATTR', `uv${ uv }` );\n\t\t\tthis.setDefine( `USE_UV${ uv }`, '' );\n\n\t\t}\n\n\t\t// remove other uv channels\n\t\tif ( uv !== 0 ) this.setDefine( 'USE_UV', null );\n\t\tif ( uv !== 1 ) this.setDefine( 'USE_UV1', null );\n\t\tif ( uv !== 2 ) this.setDefine( 'USE_UV2', null );\n\t\tif ( uv !== 3 ) this.setDefine( 'USE_UV3', null );\n\n\t\tuniforms.featureChannelsLength.value = channels.length;\n\t\tuniforms.featureChannels.value = [ ...channels ];\n\t\tthis.featureTexture = texture;\n\n\t}\n\n\t_setAttributeFeature( attribute = null ) {\n\n\t\tif ( attribute === null ) {\n\n\t\t\tthis.setDefine( 'FEATURE_TYPE', 1 );\n\n\t\t} else {\n\n\t\t\tthis.setDefine( 'FEATURE_TYPE', 2 );\n\t\t\tthis.setDefine( 'FEATURE_ATTR', `_feature_id_${ attribute }` );\n\n\t\t}\n\n\t\tthis.featureTexture = null;\n\n\t}\n\n\tcustomProgramCacheKey() {\n\n\t\tconst defines = this.defines;\n\t\treturn `${ defines.FEATURE_TYPE }|${ defines.USE_HIGHLIGHT_FEATURE }|${ defines.USE_NULL_FEATURE }|${ defines.FEATURE_ATTR }|${ defines.FEATURE_TEXTURE_ATTR }`;\n\n\t}\n\n\tonBeforeCompile( shader ) {\n\n\t\tshader.uniforms = {\n\n\t\t\t...shader.uniforms,\n\t\t\t...this.uniforms,\n\n\t\t};\n\n\t\tshader.defines = this.defines;\n\n\t\tshader.vertexShader = shader.vertexShader\n\t\t\t.replace( /^/, match =>\n\t\t\t\t/* glsl */`\n\t\t\t\t\t// texture\n\t\t\t\t\t#if FEATURE_TYPE == 3\n\n\t\t\t\t\t\tvarying vec2 _feature_uv;\n\n\t\t\t\t\t// attribute\n\t\t\t\t\t#elif FEATURE_TYPE == 2\n\n\t\t\t\t\t\tattribute float FEATURE_ATTR;\n\t\t\t\t\t\tflat varying uint _feature_attr;\n\n\t\t\t\t\t// implicit\n\t\t\t\t\t#elif FEATURE_TYPE == 1\n\n\t\t\t\t\t\tflat varying uint _feature_attr;\n\n\t\t\t\t\t#endif\n\n\t\t\t\t\t${ match }\n\t\t\t\t`,\n\t\t\t)\n\t\t\t.replace( /void main\\(\\) {/, match =>\n\t\t\t\t/* glsl */`\n\t\t\t\t\t${ match }\n\n\t\t\t\t\t// texture\n\t\t\t\t\t#if FEATURE_TYPE == 3\n\n\t\t\t\t\t\t_feature_uv = FEATURE_TEXTURE_ATTR;\n\n\t\t\t\t\t// attribute\n\t\t\t\t\t#elif FEATURE_TYPE == 2\n\n\t\t\t\t\t\t_feature_attr = uint( FEATURE_ATTR );\n\n\t\t\t\t\t// none\n\t\t\t\t\t#elif FEATURE_TYPE == 1\n\n\t\t\t\t\t\t_feature_attr = uint( gl_VertexID );\n\n\t\t\t\t\t#endif\n\t\t\t\t`,\n\t\t\t);\n\n\n\t\tshader.fragmentShader = shader.fragmentShader\n\t\t\t.replace( /^/, match =>\n\t\t\t\t/* glsl */`\n\n\t\t\t\t\t#if USE_HIGHLIGHT_FEATURE\n\n\t\t\t\t\t\tuniform uint highlightFeatureId;\n\n\t\t\t\t\t#endif\n\n\t\t\t\t\t#if USE_NULL_FEATURE\n\n\t\t\t\t\t\tuniform uint nullFeatureId;\n\n\t\t\t\t\t#endif\n\n\t\t\t\t\t// texture\n\t\t\t\t\t#if FEATURE_TYPE == 3\n\n\t\t\t\t\t\tuniform sampler2D featureTexture;\n\t\t\t\t\t\tuniform int featureChannelsLength;\n\t\t\t\t\t\tuniform uint featureChannels[ 4 ];\n\t\t\t\t\t\tvarying vec2 _feature_uv;\n\n\t\t\t\t\t// attribute\n\t\t\t\t\t#elif FEATURE_TYPE == 2\n\n\t\t\t\t\t\tflat varying uint _feature_attr;\n\n\t\t\t\t\t// none\n\t\t\t\t\t#elif FEATURE_TYPE == 1\n\n\t\t\t\t\t\tflat varying uint _feature_attr;\n\n\t\t\t\t\t#endif\n\n\t\t\t\t\t// https://www.shadertoy.com/view/XljGzV\n\t\t\t\t\tvec3 hsl2rgb( in vec3 c ) {\n\n\t\t\t\t\t\tvec3 rgb = clamp( abs( mod( c.x * 6.0 + vec3( 0.0, 4.0, 2.0 ), 6.0 ) - 3.0 ) - 1.0, 0.0, 1.0 );\n    \t\t\t\t\treturn c.z + c.y * ( rgb - 0.5 ) * ( 1.0 - abs( 2.0 * c.z - 1.0 ) );\n\n\t\t\t\t\t}\n\n\t\t\t\t\t// https://stackoverflow.com/questions/4200224/random-noise-functions-for-glsl\n\t\t\t\t\tfloat rand( float v ) {\n\n\t\t\t\t\t\treturn fract( sin( dot( vec2( v, v ), vec2( 12.9898, 78.233 ) ) ) * 43758.5453 );\n\n\t\t\t\t\t}\n\n\t\t\t\t\tvec3 randFeatureColor( uint feature ) {\n\n\t\t\t\t\t\tvec3 hsl;\n\t\t\t\t\t\thsl.r = rand( float( feature ) / 5500.0 );\n\t\t\t\t\t\thsl.g = 0.75;\n\t\t\t\t\t\thsl.b = 0.5;\n\t\t\t\t\t\treturn hsl2rgb( hsl );\n\n\t\t\t\t\t}\n\n\t\t\t\t\t${ match }\n\t\t\t\t`,\n\t\t\t)\n\t\t\t.replace( /#include <color_fragment>/, match =>\n\t\t\t\t/* glsl */`\n\t\t\t\t\t${ match }\n\n\t\t\t\t\t// disabled\n\t\t\t\t\t#if FEATURE_TYPE != 0\n\n\t\t\t\t\t\tuint featureId = 0u;\n\n\t\t\t\t\t\t// texture\n\t\t\t\t\t\t#if FEATURE_TYPE == 3\n\n\t\t\t\t\t\t\t// TODO: support anti aliasing here at the pixel edges\n\t\t\t\t\t\t\tuvec4 fields = uvec4( texture( featureTexture, _feature_uv ) * float( 0xff ) );\n\t\t\t\t\t\t\tfor ( int i = 0; i < min( featureChannelsLength, 4 ); i ++ ) {\n\n\t\t\t\t\t\t\t\tuint offset = 8u * featureChannels[ i ];\n\t\t\t\t\t\t\t\tfeatureId = featureId | ( fields[ i ] << offset );\n\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t// attribute\n\t\t\t\t\t\t#elif FEATURE_TYPE == 2\n\n\t\t\t\t\t\t\tfeatureId = _feature_attr;\n\n\t\t\t\t\t\t// implicit\n\t\t\t\t\t\t#elif FEATURE_TYPE == 1\n\n\t\t\t\t\t\t\tfeatureId = _feature_attr;\n\n\t\t\t\t\t\t#endif\n\n\t\t\t\t\t\t#if USE_HIGHLIGHT_FEATURE\n\n\t\t\t\t\t\t\tif ( highlightFeatureId != featureId ) {\n\n\t\t\t\t\t\t\t\tdiffuseColor.rgb *= 0.25;\n\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t#else\n\n\t\t\t\t\t\t\tvec3 featureColor = randFeatureColor( featureId );\n\t\t\t\t\t\t\tdiffuseColor.rgb = mix( diffuseColor.rgb * featureColor, featureColor, 0.05 );\n\n\t\t\t\t\t\t#endif\n\n\t\t\t\t\t\t#if USE_NULL_FEATURE\n\n\t\t\t\t\t\t\tif ( nullFeatureId == featureId ) {\n\n\t\t\t\t\t\t\t\tdiffuseColor.rgb *= vec3( 0.0 );\n\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t#endif\n\n\t\t\t\t\t#endif\n\n\t\t\t\t`,\n\t\t\t);\n\n\t}\n\n};\n\nexport const MeshFeaturesMaterial = MeshFeaturesMaterialMixin( MeshBasicMaterial );\n","import {\n\tScene,\n\tDirectionalLight,\n\tAmbientLight,\n\tWebGLRenderer,\n\tPerspectiveCamera,\n\tVector2,\n\tRaycaster,\n\tTriangle,\n\tVector3,\n\tSphere,\n\tGroup,\n} from 'three';\nimport {\n\tEnvironmentControls,\n\tTilesRenderer,\n} from '3d-tiles-renderer';\nimport {\n\tCesiumIonAuthPlugin,\n\tGLTFExtensionsPlugin,\n} from '3d-tiles-renderer/plugins';\nimport { MeshFeaturesMaterialMixin } from './src/MeshFeaturesMaterial';\nimport GUI from 'three/examples/jsm/libs/lil-gui.module.min.js';\n\n// FEATURE_IDs\n// const URL = 'https://raw.githubusercontent.com/CesiumGS/3d-tiles-samples/main/glTF/EXT_mesh_features/FeatureIdAttribute/tileset.json';\n// const URL = 'https://raw.githubusercontent.com/CesiumGS/3d-tiles-samples/main/glTF/EXT_mesh_features/FeatureIdTexture/tileset.json';\n\n// STRUCTURAL_METADATA\n// const URL = 'https://raw.githubusercontent.com/CesiumGS/3d-tiles-samples/main/glTF/EXT_structural_metadata/SimplePropertyTexture/tileset.json';\n// const URL = 'https://raw.githubusercontent.com/CesiumGS/3d-tiles-samples/main/glTF/EXT_structural_metadata/PropertyAttributesPointCloud/tileset.json';\n// const URL = 'https://raw.githubusercontent.com/CesiumGS/3d-tiles-samples/main/glTF/EXT_structural_metadata/SharedPropertyTable/tileset.json';\n// const URL = 'https://raw.githubusercontent.com/CesiumGS/3d-tiles-samples/main/glTF/EXT_structural_metadata/MultipleFeatureIdsAndProperties/tileset.json';\n// const URL = 'https://raw.githubusercontent.com/CesiumGS/3d-tiles-samples/main/glTF/EXT_structural_metadata/MultipleClasses/tileset.json';\n// const URL = 'https://raw.githubusercontent.com/CesiumGS/3d-tiles-samples/main/glTF/EXT_structural_metadata/FeatureIdAttributeAndPropertyTable/tileset.json';\n// const URL = 'https://raw.githubusercontent.com/CesiumGS/3d-tiles-samples/main/glTF/EXT_structural_metadata/FeatureIdTextureAndPropertyTable/tileset.json';\n// const URL = 'https://raw.githubusercontent.com/CesiumGS/3d-tiles-samples/main/glTF/EXT_structural_metadata/ComplexTypes/tileset.json';\n\n// page elements\nlet camera, controls, scene, renderer;\nlet dirLight, tiles, rotationContainer;\nlet meshFeaturesEl, structuralMetadataEl, gui;\n\n// hovered feature state\nlet controlsActive = false;\nlet hoveredInfo = null;\nlet updatingFeatures = false;\n\n// raycaster objects\nconst pointer = new Vector2( - 1, - 1 );\nconst raycaster = new Raycaster();\nraycaster.firstHitOnly = true;\nraycaster.params.Points.threshold = 0.05;\n\n// gui parameters\nconst apiKey = localStorage.getItem( 'ionApiKey' ) ?? 'put-your-api-key-here';\nconst params = {\n\taccessToken: apiKey,\n\tassetId: 2333904,\n\treload: () => {\n\n\t\treinstantiateTiles();\n\n\t},\n\n\tfeatureIndex: 0,\n\tpropertyTexture: 0,\n\thighlightAllFeatures: false,\n};\n\ninit();\nanimate();\n\nfunction init() {\n\n\t// dom elements\n\tmeshFeaturesEl = document.getElementById( 'meshFeatures' );\n\n\tstructuralMetadataEl = document.getElementById( 'structuralMetadata' );\n\n\t// renderer\n\trenderer = new WebGLRenderer( { antialias: true } );\n\trenderer.setPixelRatio( window.devicePixelRatio );\n\trenderer.setSize( window.innerWidth, window.innerHeight );\n\trenderer.setClearColor( 0x151c1f );\n\tdocument.body.appendChild( renderer.domElement );\n\n\t// scene\n\tscene = new Scene();\n\n\t// camera\n\tcamera = new PerspectiveCamera( 60, window.innerWidth / window.innerHeight, 0.1, 5000 );\n\tcamera.position.set( - 4, 2, 0 ).multiplyScalar( 30 );\n\tcamera.lookAt( 0, 0, 0 );\n\n\t// controls\n\tcontrols = new EnvironmentControls( scene, camera, renderer.domElement );\n\tcontrols.minDistance = 0.1;\n\tcontrols.cameraRadius = 0.1;\n\tcontrols.minAltitude = 0;\n\tcontrols.maxAltitude = Math.PI;\n\tcontrols.adjustHeight = false;\n\n\tcontrols.addEventListener( 'start', () => controlsActive = true );\n\tcontrols.addEventListener( 'end', () => controlsActive = false );\n\n\t// lights\n\tdirLight = new DirectionalLight( 0xffffff, 3.3 );\n\tdirLight.position.set( 1, 2, 3 ).multiplyScalar( 40 );\n\tscene.add( dirLight );\n\n\tscene.add( new AmbientLight( 0xffffff, 1.0 ) );\n\n\t// create rotation object to orient the tile set\n\trotationContainer = new Group();\n\trotationContainer.position.y = 40;\n\tscene.add( rotationContainer );\n\n\t// initialize tileset\n\treinstantiateTiles();\n\n\t// events\n\tonWindowResize();\n\twindow.addEventListener( 'resize', onWindowResize, false );\n\twindow.addEventListener( 'pointermove', e => {\n\n\t\tpointer.x = ( e.clientX / window.innerWidth ) * 2 - 1;\n\t\tpointer.y = - ( e.clientY / window.innerHeight ) * 2 + 1;\n\n\t} );\n\n}\n\nfunction buildGUI() {\n\n\tif ( gui ) {\n\n\t\tgui.destroy();\n\n\t}\n\n\t// gui\n\tgui = new GUI();\n\tconst ionFolder = gui.addFolder( 'ion' );\n\tionFolder.add( params, 'accessToken' );\n\tionFolder.add( params, 'assetId', [ 2333904, 2342602 ] ).onChange( reinstantiateTiles );\n\tionFolder.add( params, 'reload' );\n\n\tconst featureFolder = gui.addFolder( 'features' );\n\tif ( params.assetId === 2333904 ) {\n\n\t\tfeatureFolder.add( params, 'featureIndex', [ 0, 1 ] );\n\t\tfeatureFolder.add( params, 'highlightAllFeatures' );\n\n\t} else {\n\n\t\tfeatureFolder.add( params, 'propertyTexture', { NONE: 0, HORIZ_UNCERTAINTY: 1, VERT_UNCERTAINTY: 2 } );\n\n\t}\n\n}\n\nfunction reinstantiateTiles() {\n\n\t// remove any existing tileset\n\tif ( tiles ) {\n\n\t\ttiles.dispose();\n\t\ttiles.group.removeFromParent();\n\n\t}\n\n\t// save the ion access token\n\tlocalStorage.setItem( 'ionApiKey', params.accessToken );\n\n\t// create tile set\n\ttiles = new TilesRenderer();\n\ttiles.registerPlugin( new CesiumIonAuthPlugin( { apiToken: params.accessToken, assetId: params.assetId } ) );\n\ttiles.registerPlugin( new GLTFExtensionsPlugin( { metadata: true } ) );\n\n\ttiles.setCamera( camera );\n\trotationContainer.add( tiles.group );\n\n\t// set up the materials for highlighting features\n\ttiles.addEventListener( 'load-model', ( { scene } ) => {\n\n\t\tscene.traverse( c => {\n\n\t\t\tif ( c.material && c.userData.meshFeatures ) {\n\n\t\t\t\tconst MaterialConstructor = MeshFeaturesMaterialMixin( c.material.constructor );\n\t\t\t\tconst material = new MaterialConstructor();\n\t\t\t\tmaterial.copy( c.material );\n\t\t\t\tmaterial.metalness = 0;\n\n\t\t\t\tc.material = material;\n\n\t\t\t}\n\n\t\t\tif ( c.material && c.userData.structuralMetadata ) {\n\n\t\t\t\tc.material.originalMap = c.material.map;\n\n\t\t\t}\n\n\t\t} );\n\n\t} );\n\n\tbuildGUI();\n\n}\n\n// resize the renderer\nfunction onWindowResize() {\n\n\tcamera.aspect = window.innerWidth / window.innerHeight;\n\trenderer.setPixelRatio( window.devicePixelRatio );\n\trenderer.setSize( window.innerWidth, window.innerHeight );\n\tcamera.updateProjectionMatrix();\n\n}\n\n// append structural metadata information table\nfunction appendStructuralMetadata( structuralMetadata, triangle, barycoord, index = null, tableIndices = null, features = null ) {\n\n\tstructuralMetadataEl.innerText = 'STRUCTURAL_METADATA\\n';\n\n\t// append property table data\n\tif ( tableIndices !== null ) {\n\n\t\tconst data = structuralMetadata.getPropertyTableData( tableIndices, features );\n\t\tappendRows( data, structuralMetadata.getPropertyTableInfo( tableIndices ) );\n\n\t}\n\n\t// append property attribute data\n\tif ( index !== null ) {\n\n\t\tappendRows( structuralMetadata.getPropertyAttributeData( index ), structuralMetadata.getPropertyAttributeInfo() );\n\n\t}\n\n\t// append property texture data\n\tappendRows( structuralMetadata.getPropertyTextureData( triangle, barycoord ), structuralMetadata.getPropertyTextureInfo() );\n\n\t// function for writing rows\n\tfunction appendRows( data, info ) {\n\n\t\tconst maxPropertyName = Math.max( ...Object.values( data ).flatMap( v => Object.keys( v ) ).map( n => n.length ) );\n\t\tfor ( const i in data ) {\n\n\t\t\tstructuralMetadataEl.innerText += `\\n${ info[ i ].name || info[ i ].className }\\n`;\n\n\t\t\tconst properties = data[ i ];\n\t\t\tfor ( const propertyName in properties ) {\n\n\t\t\t\tlet field = properties[ propertyName ];\n\t\t\t\tif ( field && field.toArray ) {\n\n\t\t\t\t\tfield = field.toArray();\n\n\t\t\t\t}\n\n\t\t\t\tif ( field && field.join ) {\n\n\t\t\t\t\tfield = '\\n' + field\n\t\t\t\t\t\t.map( n => n.toFixed ? parseFloat( n.toFixed( 6 ) ) : n )\n\t\t\t\t\t\t.map( ( v, i ) => `    [${ i }] ${ v }` ).join( '\\n' );\n\n\t\t\t\t}\n\n\t\t\t\tif ( typeof field === 'number' ) {\n\n\t\t\t\t\tfield = parseFloat( field.toFixed( 6 ) );\n\n\t\t\t\t}\n\n\t\t\t\tstructuralMetadataEl.innerText += `  ${ propertyName.padEnd( maxPropertyName + 1 ) } : ${ field }\\n`;\n\n\t\t\t}\n\n\t\t}\n\n\t}\n\n}\n\n// update raycasting to find hovered mesh features\nfunction updateMeshFeatureRaycast() {\n\n\tif ( updatingFeatures || controlsActive ) {\n\n\t\treturn;\n\n\t}\n\n\traycaster.setFromCamera( pointer, camera );\n\n\tconst hit = raycaster.intersectObject( scene )[ 0 ];\n\tif ( hit ) {\n\n\t\t// get the barycentric coordinate for sampling mesh feature data\n\t\tconst { object, face, point, index, faceIndex } = hit;\n\t\tconst barycoord = new Vector3();\n\t\tif ( face ) {\n\n\t\t\tconst triangle = new Triangle();\n\t\t\ttriangle.setFromAttributeAndIndices( object.geometry.attributes.position, face.a, face.b, face.c );\n\t\t\ttriangle.a.applyMatrix4( object.matrixWorld );\n\t\t\ttriangle.b.applyMatrix4( object.matrixWorld );\n\t\t\ttriangle.c.applyMatrix4( object.matrixWorld );\n\t\t\ttriangle.getBarycoord( point, barycoord );\n\n\t\t} else {\n\n\t\t\tbarycoord.set( 0, 0, 0 );\n\n\t\t}\n\n\t\t// save the feature and hit information for use in updating the tables and materials\n\t\tconst { meshFeatures } = hit.object.userData;\n\t\tif ( meshFeatures ) {\n\n\t\t\tupdatingFeatures = true;\n\t\t\tmeshFeatures.getFeaturesAsync( faceIndex, barycoord )\n\t\t\t\t.then( features => {\n\n\t\t\t\t\tupdatingFeatures = false;\n\t\t\t\t\thoveredInfo = {\n\t\t\t\t\t\tindex,\n\t\t\t\t\t\tfeatures,\n\t\t\t\t\t\tfaceIndex,\n\t\t\t\t\t\tbarycoord,\n\t\t\t\t\t\tobject,\n\t\t\t\t\t};\n\n\t\t\t\t} );\n\n\t\t} else {\n\n\t\t\thoveredInfo = {\n\t\t\t\tindex,\n\t\t\t\tfeatures: null,\n\t\t\t\tfaceIndex,\n\t\t\t\tbarycoord,\n\t\t\t\tobject,\n\t\t\t};\n\n\t\t}\n\n\t} else {\n\n\t\thoveredInfo = null;\n\n\t}\n\n}\n\n// Update the mesh feature material and meta data table displays\nfunction updateMetaDataDisplay() {\n\n\tconst { featureIndex } = params;\n\n\tlet meshFeatures = null;\n\tlet structuralMetadata = null;\n\tlet features = null;\n\tif ( hoveredInfo ) {\n\n\t\tmeshFeatures = hoveredInfo.object.userData.meshFeatures;\n\t\tstructuralMetadata = hoveredInfo.object.userData.structuralMetadata;\n\t\tfeatures = hoveredInfo.features;\n\n\t}\n\n\tif ( meshFeatures !== null && features !== null ) {\n\n\t\t// update the mesh feature info\n\t\tconst { index, faceIndex, barycoord } = hoveredInfo;\n\t\tmeshFeaturesEl.innerText = 'EXT_MESH_FEATURES\\n\\n';\n\t\tmeshFeaturesEl.innerText += `feature        : ${ features.map( v => v + '' ).join( ', ' ) }\\n`;\n\t\tmeshFeaturesEl.innerText += `texture memory : ${ renderer.info.memory.textures }\\n`;\n\n\t\t// update structural metadata table\n\t\tif ( structuralMetadata !== null ) {\n\n\t\t\tconst info = meshFeatures.getFeatureInfo();\n\t\t\tconst tableIndices = info.map( p => p.propertyTable );\n\t\t\tappendStructuralMetadata( structuralMetadata, faceIndex, barycoord, index, tableIndices, features );\n\n\t\t}\n\n\t} else {\n\n\t\t// update the mesh feature info\n\t\tmeshFeaturesEl.innerText = 'EXT_MESH_FEATURES\\n\\n';\n\t\tmeshFeaturesEl.innerText += 'feature        : -\\n';\n\t\tmeshFeaturesEl.innerText += `texture memory : ${ renderer.info.memory.textures }`;\n\n\t\t// update structural metadata table\n\t\tif ( structuralMetadata !== null ) {\n\n\t\t\tconst { index, faceIndex, barycoord } = hoveredInfo;\n\t\t\tappendStructuralMetadata( structuralMetadata, faceIndex, barycoord, index );\n\n\t\t} else {\n\n\t\t\tstructuralMetadataEl.innerText = '';\n\n\t\t}\n\n\t}\n\n\t// update the materials\n\ttiles.forEachLoadedModel( scene => scene.traverse( child => {\n\n\t\tconst material = child.material;\n\t\tconst { meshFeatures, structuralMetadata } = child.userData;\n\n\t\t// set the highlight state for the mesh features\n\t\tif ( material && meshFeatures ) {\n\n\t\t\tif ( params.highlightAllFeatures ) {\n\n\t\t\t\tmaterial.setFromMeshFeatures( meshFeatures, featureIndex );\n\t\t\t\tmaterial.highlightFeatureId = null;\n\n\t\t\t} else if ( hoveredInfo === null ) {\n\n\t\t\t\tmaterial.disableFeatureDisplay();\n\n\t\t\t} else {\n\n\t\t\t\tconst id = features[ featureIndex ];\n\t\t\t\tmaterial.setFromMeshFeatures( meshFeatures, featureIndex );\n\t\t\t\tmaterial.highlightFeatureId = id === null ? - 1 : id;\n\n\t\t\t}\n\n\t\t}\n\n\t\t// assign textures from structured metadata\n\t\tif ( material && structuralMetadata && structuralMetadata.textureAccessors.length > 0 ) {\n\n\t\t\tlet newTexture = null;\n\t\t\tif ( params.propertyTexture === 0 ) {\n\n\t\t\t\tnewTexture = material.originalMap;\n\n\t\t\t} else if ( params.propertyTexture === 1 ) {\n\n\t\t\t\tconst info = structuralMetadata.getPropertyTextureInfo()[ 0 ];\n\t\t\t\tconst prop = info.properties.r3dm_uncertainty_ce90sum;\n\t\t\t\tnewTexture = structuralMetadata.textures[ prop.index ];\n\t\t\t\tnewTexture.channel = prop.texCoord;\n\n\t\t\t} else if ( params.propertyTexture === 2 ) {\n\n\t\t\t\tconst info = structuralMetadata.getPropertyTextureInfo()[ 1 ];\n\t\t\t\tconst prop = info.properties.r3dm_uncertainty_le90sum;\n\t\t\t\tnewTexture = structuralMetadata.textures[ prop.index ];\n\t\t\t\tnewTexture.channel = prop.texCoord;\n\n\t\t\t}\n\n\t\t\tif ( material.map !== newTexture ) {\n\n\t\t\t\tmaterial.map = newTexture;\n\t\t\t\tmaterial.needsUpdate = true;\n\n\t\t\t}\n\n\t\t}\n\n\t} ) );\n\n}\n\n// render and animate\nfunction animate() {\n\n\trequestAnimationFrame( animate );\n\n\t// update controls and camera\n\tcontrols.update();\n\tcamera.updateMatrixWorld();\n\n\t// update metadata\n\tupdateMetaDataDisplay();\n\tupdateMeshFeatureRaycast();\n\n\t// center tiles\n\tconst sphere = new Sphere();\n\tconst upVector = new Vector3( 0, 1, 0 );\n\ttiles.getBoundingSphere( sphere );\n\ttiles.group.position.copy( sphere.center ).multiplyScalar( - 1 );\n\n\trotationContainer.quaternion.setFromUnitVectors( sphere.center.normalize(), upVector );\n\n\t// update tiles\n\ttiles.setResolutionFromRenderer( camera, renderer );\n\ttiles.update();\n\n\t// render\n\trenderer.render( scene, camera );\n\n}\n"],"names":["MeshFeaturesMaterialMixin","base","v","texture","args","source","currentDefines","key","value","define","defines","meshFeatures","featureIdOrName","info","el","uv","channels","uniforms","attribute","shader","match","camera","controls","scene","renderer","dirLight","tiles","rotationContainer","meshFeaturesEl","structuralMetadataEl","gui","controlsActive","hoveredInfo","updatingFeatures","pointer","Vector2","raycaster","Raycaster","apiKey","params","reinstantiateTiles","init","animate","WebGLRenderer","Scene","PerspectiveCamera","EnvironmentControls","DirectionalLight","AmbientLight","Group","onWindowResize","e","buildGUI","GUI","ionFolder","featureFolder","TilesRenderer","CesiumIonAuthPlugin","GLTFExtensionsPlugin","c","MaterialConstructor","material","appendStructuralMetadata","structuralMetadata","triangle","barycoord","index","tableIndices","features","data","appendRows","maxPropertyName","n","i","properties","propertyName","field","updateMeshFeatureRaycast","hit","object","face","point","faceIndex","Vector3","Triangle","updateMetaDataDisplay","featureIndex","p","child","id","newTexture","prop","sphere","Sphere","upVector"],"mappings":"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"}